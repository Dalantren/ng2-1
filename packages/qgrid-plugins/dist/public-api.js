import*as e from"@qgrid/core";import{filter as t,takeOnce as s,Event as i,EventListener as o,EventManager as n,checkButtonCode as r,LEFT_BUTTON as c,MIDDLE_BUTTON as l,elementFromPoint as a,Command as h,preOrderDFS as u,copy as d,Aggregation as m,isFunction as p,identity as g,Resource as w,getLabelFactory as f,isUndefined as b,clone as x,isArray as v,parseFactory as y,Fastdom as E,GRID_PREFIX as k,cloneDeep as I,isObject as L,isNumber as O,isDate as _,isBoolean as C,Action as A,GridError as V,setValue as D,setLabel as R,Composite as S,RowEditor as M,graphFlatView as F,PluginService as N,CsvExport as T,JsonExport as $,XmlExport as q,jobLine as j,CsvImport as z,generate as B,columnFactory as G,firstRowTitle as W,XmlImport as U,JsonImport as P,alphaTitle as H,numericTitle as J,upload as K,FocusAfterRenderService as Q,PersistenceService as Y,CommandManager as X,Shortcut as Z,ShortcutDispatcher as ee,serialize as te,stringifyFactory as se,max as ie,PipeUnit as oe,serializeGet as ne,serializePost as re,hasRules as ce,createValidator as le,isString as ae,same as he}from"@qgrid/core";class ue{constructor(e){const{model:i,table:o,observeReply:n}=e;n(i.sceneChanged).pipe(t((e=>{if(e.hasChanges("status")&&"stop"===e.state.status){if(o.body.rowCount(0))return!0}return!1})),s()).subscribe((()=>{const e=Object.keys(o.box.markup).find((e=>e.startsWith("body")));if(e){const t=o.box.markup[e];t&&t.focus()}const{body:t}=o,{focus:s}=i,n=s(),r=t.cell(n.rowIndex,n.columnIndex).model();if(!r||!r.column.canFocus){let e=0;const i=t.rowCount(0);for(;e<i;){const i=t.row(e).cells().findIndex((e=>{const t=e.model();return t&&t.column.canFocus}));if(i>=0){s({rowIndex:e,columnIndex:i},{source:"autofocus.plugin"});break}e++}}}))}}class de{constructor(e){this.closeEvent=new i;const t=e.element,s=new o(t,new n(this));s.on("mousedown",(s=>{if(r(s,c)||r(s,l)){if(s.stopPropagation(),t.remove(),!1!==e.propagate){const e=a(s.clientX,s.clientY),t=document.createEvent("MouseEvents");t.initEvent("mousedown",!0,!0),e.dispatchEvent(t)}this.closeEvent.emit(s)}})),s.on("keydown",(t=>e.onKeyDown({$event:t})))}}class me{constructor(e,t){this.plugin=e,this.context=t,this.cancelEvent=new i,this.submitEvent=new i,this.dropEvent=new i;const s=()=>{const{model:e}=this.plugin,{index:t}=e.columnList();this.tree=u([t],((e,t,s)=>{const{model:i}=e.key,o={key:i.key,title:i.title,isVisible:i.isVisible,isDefault:i.isDefault,canMove:i.canMove,aggregation:i.aggregation};if(s){const s=d(e);return s.value={column:o,isVisible:"data"===i.category||"cohort"===i.category},t.children.push(s),s}return t.value={column:o,isVisible:!0},t}),d(t)),n()};let o=g;const n=()=>{this.listView=[],this.treeView=o(this.tree),u([this.treeView],(e=>{e.value.isVisible&&this.listView.push(e.value.column)}))};this.search=e=>{const t=(""+e).toLowerCase();o=t?e=>filterNode(e,(e=>(e.value.column.title||"").toLowerCase().indexOf(t)>=0)):g,n()},s();const r=(e,t)=>{const{children:s}=e,{column:i}=e.value;i.isVisible=t,s.length&&s.forEach((e=>r(e,t)))};this.toggle=new h({source:"column.chooser",canExecute:e=>e.value.isVisible,execute:e=>r(e,!this.state(e))}),this.toggleAll=new h({source:"column.chooser",execute:()=>{const e=!this.stateAll();for(let t of this.listView)t.isVisible=e}}),this.defaults=new h({source:"column.chooser",execute:()=>{for(let e of this.listView)e.isVisible=!1!==e.isDefault}}),this.toggleAggregation=new h({source:"column.chooser"}),this.drop=new h({source:"column.chooser",canExecute:e=>{const t=e.dropData;return t&&t.value.column.canMove},execute:e=>{switch(e.action){case"over":{const t=e.dragData,s=e.dropData;if(t!==s){const e=this.tree,i=findNode(e,(e=>e===t)),o=findNode(e,(e=>e===s));if(i&&o&&o.path.indexOf(i.node)<0){const e=i.path.reverse(),t=e.findIndex((e=>e.children.length>1));if(t>=0){const s=e[t],n=e[t-1]||i.node,r=s.children.indexOf(n);s.children.splice(r,1),o.parent.children.splice(o.index,0,n),n.level=o.parent.level+1,u(n.children,((e,t,s)=>{e.level=(t||s).level+1}),n),this.dropEvent.emit()}}}break}}}}),this.drag=new h({source:"column.chooser",canExecute:e=>{const t=e.data;return t&&t.value.column.canMove}}),this.submit=new h({source:"column.chooser",execute:()=>{const e=u([this.tree],((e,t,s)=>{if(s){const s=d(e);t.children.push(s);const{isVisible:i,column:o}=e.value;if(i){const{model:e}=s.key;e.isVisible=o.isVisible,e.aggregation=o.aggregation}return s.value=null,s}return t.value=null,t}),d(this.tree)),{model:t}=this.plugin;t.columnList({index:e},{source:"column.chooser.view"}),this.submitEvent.emit()}}),this.cancel=new h({source:"column.chooser",execute:()=>this.cancelEvent.emit()}),this.reset=new h({source:"column.chooser",execute:()=>s()}),this.aggregations=Object.getOwnPropertyNames(m).filter((e=>p(m[e])));const{model:c,observe:l}=this.plugin;l(c.dataChanged).subscribe((e=>{"column.chooser"!==e.tag.source&&e.hasChanges("columns")&&s()})),l(c.columnListChanged).subscribe((e=>{"column.chooser"!==e.tag.source&&e.hasChanges("index")&&s()}))}state(e){const{children:t}=e,{column:s}=e.value;return t.length?t.some((e=>e.value.column.isVisible)):!1!==s.isVisible}stateAll(){return this.listView.every((e=>e.isVisible))}stateDefault(){return this.listView.every((e=>!1!==e.isDefault&&!1!==e.isVisible||!1===e.isDefault&&!1===e.isVisible))}isIndeterminate(){return!this.stateAll()&&this.listView.some((e=>e.isVisible))}get canAggregate(){return this.columnChooserCanAggregate}get resource(){return this.plugin.model.columnChooser().resource}}class pe{constructor(){this.resource=new w,this.canAggregate=!1,this.canSort=!0}}class ge{constructor(e,t){const{model:s}=e;this.plugin=e,this.column=t.column,this.cancelEvent=new i,this.submitEvent=new i,this.resetEvent=new i;const o=s.filter().by[this.column.key];this.by=new Set(o&&o.items||[]),this.byBlanks=!(!o||!o.blanks);let n=s.filter().operatorFactory(this.column)[0]||"contains";o&&o.items&&o.items.length&&(n="contains"),this.items=[],this.operator=o&&o.expression&&o.expression.op||n,this.value=o&&o.expression&&o.expression.right||null,this.title=this.column.title,this.getValue=f(this.column),Object.assign(this,this.commands),this.changeOperator.execute(this.operator)}state(e){return this.by.has(e)}stateAll(){return this.items.every(this.state.bind(this))&&(!this.hasBlanks||this.byBlanks)}isIndeterminate(){return!this.stateAll()&&(this.items.some(this.state.bind(this))||this.byBlanks)}isEmpty(){return!!this.by.size||this.byBlanks}get commands(){return{toggle:new h({source:"column.filter.view",execute:e=>{this.by.has(e)?this.by.delete(e):this.by.add(e),this.by=new Set(this.by)}}),toggleAll:new h({source:"column.filter.view",execute:e=>{const t=!this.stateAll();if(t)for(let e of this.items)this.by.add(e);else if(e)for(let e of this.by)this.items.indexOf(e)>=0&&this.by.delete(e);else this.by.clear();this.by=new Set(this.by),this.byBlanks=this.hasBlanks&&t}}),changeOperator:new h({source:"column.filter.view",execute:e=>{this.operator=e;let{value:t}=this;if("between"===e)Array.isArray(t)||(b(t)||null===t||""===t?this.value=[]:this.value=[t]);else Array.isArray(t)&&(this.value=t[0])}}),submit:new h({source:"column.filter.view",execute:()=>{const{model:e}=this.plugin,t=x(e.filter().by),s=t[this.column.key]||{};if(s.items=Array.from(this.by),s.blanks=this.byBlanks,"contains"===this.operator)delete s.expression;else if(s.items=[],this.operator.startsWith("is"))s.expression={kind:"condition",op:this.operator,left:this.column.key,right:null};else if(b(this.value)||null===this.value||""===this.value||v(this.value)&&0===this.value.length)delete s.expression;else{const e=y(this.column.type,this.column.editorOptions.editor);s.expression={kind:"condition",op:this.operator,left:this.column.key,right:v(this.value)?this.value.map(e):e(this.value)}}s.items&&s.items.length||s.blanks||s.expression?t[this.column.key]=s:delete t[this.column.key],e.filter({by:t},{source:"column.filter.view"}),this.submitEvent.emit()}}),cancel:new h({source:"column.filter.view",execute:()=>this.cancelEvent.emit()}),reset:new h({source:"column.filter.view",execute:()=>{this.by=new Set,this.byBlanks=!1,this.value="between"===this.operator?[]:null,this.resetEvent.emit()}})}}}class we{constructor(){this.threshold=20,this.source="data"}}const fe=`${k}-active`,be=`${k}-hide`;class xe{constructor(e,t){const{model:s,observeReply:i,view:o}=e,{column:n,iconDesc:r,iconAsc:c,element:l}=t;this.element=l,i(s.sortChanged).subscribe((e=>{if(e.hasChanges("by"))if(o.sort.order(n)<0)E.mutate((()=>{l.classList.add(be),l.classList.remove(fe),c.classList.remove(fe),r.classList.remove(fe)}));else{const e=o.sort.direction(n),t="asc"===e?r:c,s="asc"===e?c:r;E.mutate((()=>{l.classList.add(fe),l.classList.remove(be),t.classList.remove(fe),s.classList.add(fe)}))}})),this.toggle=new h({canExecute:()=>o.sort.toggle.canExecute(n),execute:()=>o.sort.toggle.execute(n)})}click(){return!!this.toggle.canExecute()&&(this.toggle.execute(),!0)}mouseLeave(){E.mutate((()=>{this.element.classList.remove(be)}))}}class ve{constructor(){this.resource=new w,this.deleted=new Set,this.added=new Set,this.edited=new Map,this.rowFactory=e=>{if(e)return I(e,(e=>v(e)?[]:!L(e)||O(e)||_(e)||C(e)||p(e)?null:void 0))}}}class ye{constructor(i){this.plugin=i,this.commitCommand=new h({execute:e=>{if("data"!==e.column.category)return;const t=this.rowId(e.rowIndex,e.row),s=this.columnId(e.columnIndex,e.column),{edited:i}=this.changes;let o=i.get(t);o||(o=[],i.set(t,o));let n=o.findIndex((e=>e.column===s)),r=o[n];r||(r={column:s,oldValue:e.oldValue,oldLabel:e.oldLabel},n=o.length,o.push(r)),r.newValue=e.newValue,r.newLabel=e.newLabel,this.hasChanges(r.newValue,r.oldValue)||(o.splice(n,1),o.length||i.delete(t))}}),this.actions=[new A(new h({source:"data.manipulation",execute:()=>{const{model:e,observe:i,table:o}=this.plugin,{data:n}=e,r=this.rowFactory(e.data().rows[0]);if(b(r))throw new V("data.manipulation","Setup rowFactory property to add new rows");const c=this.rowId(0,r);this.changes.added.add(c),n({rows:[r].concat(n().rows)},{source:"data.manipulation"}),i(e.sceneChanged).pipe(t((e=>e.hasChanges("status")&&"stop"===e.state.status)),s()).subscribe((t=>{const s=e.view().rows.indexOf(r);e.focus({rowIndex:s},{source:"data.manipulation.plugin"}),o.view.focus()}))},shortcut:"F7"}),"Add New Row","add")],this.rowActions=[new A(new h({source:"data.manipulation",canExecute:e=>{const t=this.rowId(e.rowIndex,e.row);return!this.changes.deleted.has(t)},execute:e=>{const{model:t}=this.plugin,{data:s}=t,i=this.rowId(e.rowIndex,e.row),o=this.changes;if(o.added.has(i)){o.added.delete(i);const e=s().rows.filter(((e,t)=>this.rowId(t,e)!==i));s({rows:e},{source:"data.manipulation"})}else o.deleted.add(i)}}),"Delete Row","delete"),new A(new h({source:"data.manipulation",execute:t=>{const s=this.rowId(t.rowIndex,t.row);if(this.changes.deleted.has(s)&&this.changes.deleted.delete(s),this.changes.edited.has(s))try{const{model:i}=this.plugin,o=this.changes.edited.get(s),n=e.mapColumns(i.columnList().line);for(const e of o){const s=n[e.column];if(!s)throw new V("data.manipulation",`Column ${e.column} is not found`);D(t.row,s,e.oldValue),R(t.row,s,e.oldLabel)}}finally{this.changes.edited.delete(s)}},canExecute:e=>{const t=this.rowId(e.rowIndex,e.row);return this.changes.deleted.has(t)||this.changes.edited.has(t)}}),"Revert Row","restore")];const{model:o,disposable:n,observeReply:r}=this.plugin;this.rowId=o.data().rowId,this.columnId=o.data().columnId;const c=o.resolve(ve);this.rowFactory=c.state().rowFactory;const l=o.style(),a=Array.from(l.rows),u=Array.from(l.cells);a.push(this.styleRow.bind(this)),u.push(this.styleCell.bind(this)),o.edit({mode:"cell",commit:S.command([this.commitCommand,o.edit().commit])}).style({rows:a,cells:u}).action({items:S.list([this.actions,o.action().items])}),n.add((()=>{const{items:e}=o.action(),t=e.filter((e=>this.actions.every((t=>t.id!==e.id))));o.action({items:t})})),r(o.columnListChanged).pipe(t((e=>e.hasChanges("line"))),s()).subscribe((e=>{const t=e.state.line.find((e=>"row-options"===e.type));t&&t.editorOptions.actions.push(...this.rowActions)}))}hasChanges(e,t){return e!==t}styleRow(e,t){const s=this.rowId(t.row,e);this.changes.deleted.has(s)&&t.class("deleted",{opacity:.3})}styleCell(e,t,s){const i=this.rowId(s.row,e),o=this.changes;if("row-indicator"!==t.type){if(o.edited.has(i)){o.edited.get(i).findIndex((e=>e.column===this.columnId(s.column,t)))>=0&&s.class("edited",{background:"#E3F2FD"})}}else o.deleted.has(i)?s.class("delete-indicator",{background:"#EF5350"}):o.added.has(i)?s.class("add-indicator",{background:"#C8E6C9"}):o.edited.has(i)&&s.class("edit-indicator",{background:"#E3F2FD"})}get changes(){const{model:e}=this.plugin;return e.dataManipulation()}get resource(){return this.model.resolve(ve).state().resource}}class Ee{constructor(e){this.editor=e.editor}}class ke{constructor(e,t){const{model:s,disposable:o}=e;this.plugin=e,this.editor=new M(t.row,s.columnList().line),this.caption=t.caption,this.submitEvent=new i,this.cancelEvent=new i,this.resetEvent=new i,this.submit=this.commands.submit,this.cancel=this.commands.cancel,this.reset=this.commands.reset,b(t.shortcut)||o.add(t.shortcut.register(new Map(Object.entries(this.commands))))}get editors(){return this.editor.editors}get commands(){return{submit:new h({source:"edit.form.panel",shortcut:this.shortcutFactory("commit"),execute:()=>{this.editor.commit(),this.submitEvent.emit()}}),cancel:new h({source:"edit.form.panel",shortcut:this.shortcutFactory("cancel"),execute:()=>this.cancelEvent.emit()}),reset:new h({source:"edit.form.panel",execute:()=>{this.editor.editors.forEach((e=>e.reset())),this.resetEvent.emit()}})}}shortcutFactory(e){const{model:t}=this.plugin;return()=>{const s=t.edit()[e+"Shortcuts"];return s.reference||s.$default}}}class Ie{constructor(e,t){this.model=e,this.key=t.key,this.title=t.title,this.row=t.row,this.submitEvent=new i,this.cancelEvent=new i,this.submit=this.commands.submit,this.cancel=this.commands.cancel}get commands(){return{submit:new h({source:"edit.form",execute:()=>this.submitEvent.emit()}),cancel:new h({source:"edit.form",execute:()=>this.cancelEvent.emit()})}}}function Le(e){return function(t,s,i,o){const n=new Blob([s],{type:i}),r=`${t}.${o||i.split("/")[1]}`;e.saveAs(n,r)}}class Oe{constructor(e){this.jsPDF=e}write(e,t,s){const i=[],o=[],n=new(0,this.jsPDF)({orientation:"landscape",unit:"in"});for(let e of t)i.push({title:e.title,dataKey:e.path});for(let t of e)o.push(F(t));n.autoTable(i,o,{styles:{overflow:"linebreak",fontSize:8,columnWidth:"auto",overflowColumns:!0},headerStyles:{overflow:"ellipsize"},pageBreak:"auto",margin:0}),n.save(`${s}.pdf`)}}class _e{constructor(e){this.xlsx=e}write(e,t){const s=[],i=[];for(let t of e)s.push(F(t));for(let e of t)i.push(e.title);const o=this.xlsx.utils.json_to_sheet(s),n=function(e){const t={};return t.Sheet1=e,{SheetNames:["Sheet1"],Sheets:t}}(this.updateTitles(o,i));return function(e){const t=new ArrayBuffer(e.length),s=new Uint8Array(t);for(let t=0;t<e.length;++t)s[t]=255&e.charCodeAt(t);return t}(this.xlsx.write(n,{bookType:"xlsx",bookSST:!0,cellDates:!0,compression:!0,type:"binary"}))}updateTitles(e,t){const s=this.xlsx.utils.decode_range(e["!ref"]);for(let i=s.s.r;i<=s.e.r;++i){const s=this.xlsx.utils.encode_col(i)+"1";e[s]&&(e[s].v=t[i])}return e}}class Ce{constructor(e,t){this.model=e,this.type=t,this.csv=new h({source:"export",canExecute:()=>"csv"===this.type,execute:()=>{const e=new N(this.model).resolve("fileSaver"),t=(new T).write(this.rows,this.columns);Le(e)(this.id,t,`text/${this.type}`)}}),this.json=new h({source:"export",canExecute:()=>"json"===this.type,execute:()=>{const e=new N(this.model).resolve("fileSaver"),t=(new $).write(this.rows,this.columns);Le(e)(this.id,t,`text/${this.type}`)}}),this.xml=new h({source:"export",canExecute:()=>"xml"===this.type,execute:()=>{const e=new N(this.model).resolve("fileSaver"),t=(new q).write(this.rows);Le(e)(this.id,t,`application/${this.type}`)}}),this.xlsx=new h({source:"export",canExecute:()=>"xlsx"===this.type,execute:()=>{const e=new N(this.model),t=e.resolve("xlsx"),s=e.resolve("fileSaver"),i=new _e(t).write(this.rows,this.columns);Le(s)(this.id,i,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","xlsx")}}),this.pdf=new h({source:"export",canExecute:()=>"pdf"===this.type,execute:()=>{const e=new N(this.model).resolve("pdf");new Oe(e).write(this.rows,this.columns,this.id)}})}get columns(){return this.model.columnList().line}get rows(){return this.model.data().rows}get id(){return this.model.grid().id}}class Ae{constructor(e){this.element=e.element,this.targetSelector=e.targetSelector,this.job=j(e.delay)}set(){null!==this.element.getAttribute("tabindex")&&""===this.element.getAttribute("tabindex")||this.element.setAttribute("tabindex",-1),this.job((()=>{let e=this.element;if(this.targetSelector){const t=this.element.querySelector(this.targetSelector);if(!t)throw new V("focus",`Element "${this.targetSelector}" is not found`);e=t}e.focus()}))}}function Ve(e){const t={};for(let[s,i]of Object.entries(e))t[s]=i;return t}class De{constructor(e){this.xlsx=e}read(e,t){const s=this.xlsx.read(e,{type:"binary"});return this.toJson(s,t)}toJson(e,t={}){const s={};switch(t.head){case"alpha":s.header="A";break;case"numeric":s.header=1}let i=[];for(let t of e.SheetNames){i=this.xlsx.utils.sheet_to_json(e.Sheets[t],s).concat(i)}return i.map(Ve)}}function Re(e,t,s,i={}){const o=e.target.result,n=""===t.type?function(e){if(/[.]/g.test(e)){const t=e.split(".");return t[t.length-1]}}(t.name):t.type,r=new N(s);switch(n){case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"xlsx":{const e=r.resolve("xlsx"),t=new De(e).read(o,i),n=G(s),c=B({rows:t,columnFactory:(e,t)=>n("text",t),deep:!1});s.data({columns:c,rows:t},{source:"read"});break}case"application/json":case"text/json":case"json":{const e=(new P).read(o);if(!e.length)throw new V("import","JSON for input should be an array of objects");{const t=G(s),i=B({rows:e,columnFactory:(e,s)=>t("text",s),deep:!0});s.data({columns:i,rows:e},{source:"read"})}break}case"application/xml":case"text/xml":case"xml":{const e=(new U).read(o),t=B({rows:e,columnFactory:G(s),deep:!0});s.data({columns:t,rows:e},{source:"read"});break}case"application/vnd.ms-excel":case"text/csv":case"csv":{const e=(new z).read(o);let t=W;"alpha"===i.head?t=H:"numeric"===i.head&&(t=J);const n=B({rows:e,columnFactory:G(s),deep:!1,title:t});t===W&&e.shift(0),s.data({columns:n,rows:e},{source:"read"});break}default:throw new V("import",`This is not valid file type ${n}`)}}class Se{constructor(e,t){this.model=e,this.element=t}upload(){K(this.element)}load(e){const{files:t}=e.target;for(let e of t){const t=new FileReader;t.onload=t=>Re(t,e,this.model,this.options),t.readAsBinaryString(e)}}}class Me{constructor(e){const{model:t}=e;this.plugin=e;const{shortcut:s}=t.pagination();this.next=new h({source:"pager",shortcut:s.next,execute:()=>{new Q(e),t.pagination({current:t.pagination().current+1},{source:"pager.view"})},canExecute:()=>(t.pagination().current+1)*t.pagination().size<t.pagination().count}),this.prev=new h({source:"pager",shortcut:s.prev,execute:()=>{new Q(e),t.pagination({current:t.pagination().current-1},{source:"pager.view"})},canExecute:()=>t.pagination().current>0})}get theme(){return this.plugin.model.style().classList}get resource(){return this.plugin.model.pagination().resource}get size(){return this.plugin.model.pagination().size}set size(e){this.plugin.model.pagination({size:e,current:0},{source:"pager.view"})}get sizeList(){return this.plugin.model.pagination().sizeList}get current(){return this.plugin.model.pagination().current}set current(e){return this.plugin.model.pagination({current:e},{source:"pager.view"})}get from(){return Math.min(this.total,this.current*this.size+1)}get to(){return Math.min(this.total,(this.current+1)*this.size)}get total(){return this.plugin.model.pagination().count}get totalPages(){return 0===this.size?0:Math.max(1,Math.ceil(this.total/this.size))}get scroll(){return this.plugin.model.scroll()}get mode(){return this.plugin.model.pagination().mode}}class Fe{constructor(e,t){const{model:s,observeReply:o}=e;this.plugin=e,this.service=new Y(s,t),this.closeEvent=new i,this.items=[],this.state={editItem:null,oldValue:null};const{persistence:n}=s;this.id=n().id,this.title=this.stringify(),n().storage.getItem(this.id).then((e=>{this.items=e||[],this.groups=this.buildGroups(this.items)})),o(s.gridChanged).subscribe((e=>{e.hasChanges("status")&&"unbound"===e.state.status&&this.closeEvent.emit()})),this.create=new h({source:"persistence.view",execute:()=>{const e={title:this.title,modified:Date.now(),model:this.service.save(),isDefault:!1,group:n().defaultGroup,canEdit:!0};return!1!==n().create.execute(e)&&(this.items.push(e),this.persist(),this.title="",!0)},canExecute:()=>{if(this.title&&this.isUniqueTitle(this.title)){const e={title:this.title,modified:Date.now(),model:this.service.save(),isDefault:!1,group:n().defaultGroup,canEdit:!0};return n().create.canExecute(e)}return!1}}),this.edit={enter:new h({source:"persistence.view",execute:e=>!!(e=e||this.items.find(this.isActive))&&(this.state={editItem:e,oldValue:x(e)},!0),canExecute:e=>null===this.state.editItem&&e.canEdit}),commit:new h({source:"persistence.view",shortcut:"enter",execute:e=>{if(e=e||this.state.editItem,!1!==n().modify.execute(e)){const t=e.title;return t&&this.isUniqueTitle(t)?(e.modified=Date.now(),this.persist(),this.state.editItem=null,!0):(this.edit.cancel.execute(),!1)}return!1},canExecute:()=>null!==this.state.editItem&&n().modify.canExecute(this.state.editItem)}),cancel:new h({source:"persistence.view",shortcut:"escape",execute:()=>{if(null!==this.state.editItem){const e=this.items.indexOf(this.state.editItem);this.items.splice(e,1,this.state.oldValue),this.state.oldValue=null,this.state.editItem=null}else this.closeEvent.emit();return!0}})},this.load=new h({source:"persistence.view",canExecute:e=>n().load.canExecute(e),execute:e=>!1!==n().load.execute(e)&&(this.service.load(e.model),!0)}),this.reset=new h({source:"persistence.view",execute:()=>(!1!==n().reset.execute()&&this.service.reset(),!1),canExecute:()=>n().reset.canExecute()}),this.remove=new h({source:"persistence.view",execute:e=>{const t=this.items.indexOf(e);return t>=0&&!1!==n().remove.execute(e)&&(this.items.splice(t,1),this.persist(),!0)},canExecute:e=>e.canEdit&&n().remove.canExecute(e)}),this.setDefault=new h({source:"persistence.view",canExecute:e=>n().setDefault.canExecute(e),execute:e=>{if(!1!==n().setDefault.execute(e)){const t=this.items.indexOf(e);return-1!==t&&(e.isDefault?e.isDefault=!1:(this.items.forEach((e=>e.isDefault=!1)),e.isDefault=!0),this.items.splice(t,1,e),this.persist(),!0)}return!1}});const r=new X,c=new Z(new ee);this.keyDown=e=>c.keyDown(e),c.register(r,[this.edit.enter,this.edit.commit,this.edit.cancel])}get blank(){return{title:"Blank",modified:Date.now(),model:{},isDefault:!1,group:"blank",canEdit:!1}}get sortedItems(){return this.items.sort(((e,t)=>t.modified-e.modified))}buildGroups(e){return e.reduce(((e,t)=>{const s=e.find((e=>e.key===t.group));return s?s.items.push(t):e.push({key:t.group,items:[t]}),e}),[])}isActive(e){return te(e.model)===te(this.service.save())}persist(){const{model:e}=this.plugin;e.persistence().storage.setItem(this.id,this.items.filter((e=>e.canEdit))),this.groups=this.buildGroups(this.items)}stringify(e){const{settings:t}=this.plugin.model.persistence(),s=e?e.model:this.service.save(),i=[];for(let e in t){if(!s[e])continue;const t=se(e)(s[e]);""!==t&&i.push(t)}return i.join("; ")||"No settings"}isUniqueTitle(e){return e=(e||"").trim().toLowerCase(),!this.items.some((t=>t!==this.state.editItem&&(t.title||"").toLowerCase()===e))}}class Ne{constructor(e,t){this.element=e.element,this.targetName=e.targetName;const s=new o(window,new n(this)),i=j(400);t.add(s.on("resize",(()=>{this.invalidate(),i((()=>this.invalidate()))})))}invalidate(){let e=this.element.parentNode;for(;e;){const t=(this.targetName||"").toLowerCase();if(e.nodeName.toLowerCase()===t)return void E.measure((()=>E.mutate((()=>{this.layout(e,this.element),this.element.style.opacity=1}))));e=e.parentNode}}layout(e,t){const{top:s,right:i,left:o,bottom:n}=e.getBoundingClientRect(),{width:r,height:c}=t.getBoundingClientRect(),l=this.boxRect(),a=[];a.push(this.intersection(l,{top:s,right:o+r,bottom:s+c,left:o})),a.push(this.intersection(l,{top:s,right:i,bottom:s+c,left:i-r})),a.push(this.intersection(l,{top:n-c,right:o+r,bottom:n,left:o})),a.push(this.intersection(l,{top:n-c,right:i,bottom:n,left:i-r}));const h=ie(a,(e=>e.area)),{left:u,top:d}=h.b,m=this.fix({left:u-l.left,top:d-l.top,width:r,height:c});t.style.left=m.left+"px",t.style.top=m.top+"px"}intersection(e,t){return{area:Math.max(0,Math.min(e.right,t.right)-Math.max(e.left,t.left))*Math.max(0,Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top)),a:e,b:t}}fix(e){const t=this.windowRect(),s=this.boxRect(),{width:i,height:o}=t,n=s.left-t.left,r=s.top-t.top,{height:c,width:l}=e,a=e.left+n,h=e.top+r,u=a<t.left,d=a+l>i,m=h<t.top,p=h+c>o;return{left:u||d?e.left+(i-a-l):e.left,top:m||p?e.top+(o-h-c):e.top}}boxRect(){let e=this.element;const t=`${k}-box`;for(;e;){if(e.classList&&e.classList.contains(t))return e.getBoundingClientRect();e=e.parentNode}return this.windowRect()}windowRect(){const{innerHeight:e,innerWidth:t}=window;return{top:0,left:0,bottom:e,right:t,height:e,width:t}}}class Te{constructor(e,{get:t,post:s}){this.model=e;const{method:i,url:o,serialize:n}=this.model.rest();if(!o)throw new V("rest","REST endpoint URL is required");const r=this.fetchFactory(i,t,s),c=this.serializeFactory(i,n);e.data({pipe:[(t,s,i)=>{r(o,c(e)).then((e=>i(e)))},...oe.view]},{source:"rest.view"})}fetchFactory(e,t,s){switch(e.toLowerCase()){case"get":return t;case"post":return s;default:throw new V("rest",`"${e}" is incorrect REST method`)}}serializeFactory(e,t){return p(t)?t:"get"===e?ne:"post"===e?re:void 0}}class $e{constructor(e,t){this.model=e,this.context=t,this.oldErrors=[],ce(this.rules,this.key)&&(this.validator=le(this.rules,this.key))}get errors(){if(this.validator){const e={[this.key]:this.value};if(this.validator.validate(e))this.oldErrors.length=0;else{const e=this.validator.getErrors()[this.key],t=ae(e)?[e]:e;he(t,this.oldErrors)||(this.oldErrors=t)}return this.stringify(this.oldErrors)}}get rules(){return this.model.validation().rules}get type(){return this.context.type}get value(){return this.context.value}get key(){return this.context.key}stringify(e){const t=[];let s={};for(const e of this.validator.livrRules[this.key])s=Object.assign(s,e);for(const i of e)switch(i){case"REQUIRED":case"CANNOT BE EMPTY":t.push("Can't be empty");break;case"FORMAT_ERROR":t.push("Wrong format");break;case"TOO_LOW":t.push(`Must be > ${s.min_number}`);break;case"TOO_HIGH":t.push(`Must be < ${s.max_number}`);break;case"WRONG_FORMAT":t.push("Must match the pattern");break;case"WRONG_EMAIL":t.push("Must be an email");break;case"WRONG_URL":t.push("Must be a url");break;case"WRONG_DATE":t.push("Must be a date");break;case"FIELDS_NOT_EQUAL":t.push(`Field must be equal ${s.equal_to_field}`);break;case"NOT_INTEGER":t.push("Must be an integer");break;case"NOT_POSITIVE_INTEGER":t.push("Must be a positive integer");break;case"NOT_DECIMAL":t.push("Must be a decimal");break;case"NOT_POSITIVE_DECIMAL":t.push("Must be a positive decimal");break;case"NOT_ALLOWED_VALUE":s.eq&&s.eq!=this.value?t.push(`Must be equal to ${s.eq}`):t.push(`Must be one of ${s.one_of}`);break;case"TOO_LONG":s.max_length&&s.max_length<this.value.length?t.push(`Length must be < ${s.max_length}`):s.length_equal&&s.length_equal!=this.value.length?t.push(`Length must be equal to ${s.length_equal}`):t.push(`Length must be [${s.length_between[0]},${s.length_between[1]}]`);break;case"TOO_SHORT":s.min_length&&s.min_length>this.value.length?t.push(`Length must be > ${s.min_length}`):s.length_equal&&s.length_equal!=this.value.length?t.push(`Length must be equal to ${s.length_equal}`):t.push(`Length must be [${s.length_between[0]},${s.length_between[1]}]`);break;default:t.push(i)}return t}}export{ue as AutofocusPlugin,de as BackdropPlugin,me as ColumnChooserPlugin,pe as ColumnChooserState,ge as ColumnFilterPlugin,we as ColumnFilterState,xe as ColumnSortPlugin,ye as DataManipulationPlugin,ve as DataManipulationState,Ee as EditFormEditorPlugin,ke as EditFormPanelPlugin,Ie as EditFormPlugin,Ce as ExportPlugin,Ae as FocusPlugin,Se as ImportPlugin,Me as PagerPlugin,Oe as PdfWriter,Fe as PersistencePlugin,Ne as PositionPlugin,Te as RestPlugin,$e as ValidatorPlugin,De as XlsxReader,_e as XlsxWriter,Le as downloadFactory,Re as readFile};
