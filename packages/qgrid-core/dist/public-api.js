import e from"lodash-es/assignWith";export{default as assignWith}from"lodash-es/assignWith";import t from"lodash-es/clone";export{default as clone}from"lodash-es/clone";import s from"lodash-es/cloneDeepWith";export{default as cloneDeep}from"lodash-es/cloneDeepWith";import n from"lodash-es/dropWhile";export{default as dropWhile}from"lodash-es/dropWhile";import o from"lodash-es/flatten";export{default as flatten}from"lodash-es/flatten";import r from"lodash-es/isArray";export{default as isArray}from"lodash-es/isArray";import i from"lodash-es/isBoolean";export{default as isBoolean}from"lodash-es/isBoolean";import c from"lodash-es/isDate";export{default as isDate}from"lodash-es/isDate";import l from"lodash-es/isEqual";export{default as same}from"lodash-es/isEqual";import a from"lodash-es/isFunction";export{default as isFunction}from"lodash-es/isFunction";import u from"lodash-es/isNumber";export{default as isNumber}from"lodash-es/isNumber";import h from"lodash-es/isObject";export{default as isObject}from"lodash-es/isObject";import d from"lodash-es/isString";export{default as isString}from"lodash-es/isString";import m from"lodash-es/isUndefined";export{default as isUndefined}from"lodash-es/isUndefined";import g from"lodash-es/maxBy";export{default as max}from"lodash-es/maxBy";import p from"lodash-es/minBy";export{default as min}from"lodash-es/minBy";import w from"lodash-es/startCase";export{default as startCase}from"lodash-es/startCase";import f from"lodash-es/sumBy";export{default as sumBy}from"lodash-es/sumBy";import y from"lodash-es/takeWhile";export{default as takeWhile}from"lodash-es/takeWhile";import b from"lodash-es/uniq";export{default as uniq}from"lodash-es/uniq";import v from"lodash-es/zip";export{default as zip}from"lodash-es/zip";import x from"fastdom";import C from"css.escape";import k from"livr";class E{constructor(e,t,s,n){this.command=e,this.title=t,this.icon=s,this.templateUrl=n}}class ${constructor(e={},t={}){this.data=e,this.scope=t}}const R=new Set(["shift","ctrl","alt","pause","break","capslock","escape","insert","left","right","end","home","pageup","pagedown","up","down","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","numlock","scrolllock"]),I=new Set(["enter"]),O=(new Map).set(8,"backspace").set(9,"tab").set(13,"enter").set(16,"shift").set(17,"ctrl").set(18,"alt").set(20,"capslock").set(27,"escape").set(32,"space").set(33,"pageup").set(34,"pagedown").set(35,"end").set(36,"home").set(37,"left").set(38,"up").set(39,"right").set(40,"down").set(45,"insert").set(46,"delete").set(96,"numpad0").set(97,"numpad1").set(98,"numpad2").set(99,"numpad3").set(100,"numpad4").set(101,"numpad5").set(102,"numpad6").set(103,"numpad7").set(104,"numpad8").set(105,"numpad9").set(112,"f1").set(113,"f2").set(114,"f3").set(115,"f4").set(116,"f5").set(117,"f6").set(118,"f7").set(119,"f8").set(120,"f9").set(121,"f10").set(122,"f11").set(123,"f12").set(144,"numlock").set(145,"scrolllock"),F=new Set(O.values()),q=(new Map).set("space"," ");class L{static isPrintable(e){return!I.has(e)&&!L.isControl(e)}static isControl(e){return R.has(e)}static stringify(e,t){return F.has(e)?q.get(e)||"":t}static translate(e){return O.get(e)||String.fromCharCode(e)}}class S{constructor(e){this.dispatcher=e,this.keyCode={key:null,code:null}}static isControl(e){if(!e)return!1;const t=e.code.split("+");return t.some((e=>"ctrl"===e||"alt"===e))||t.every((e=>L.isControl(e)))}static isPrintable(e){if(!e)return!1;return e.code.split("+").some((e=>L.isPrintable(e)))}static stringify(e){return e?L.stringify(e.code,e.key):""}static translate(e){const t=[],s=L.translate(e.keyCode).toLowerCase();return e.ctrlKey&&t.push("ctrl"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),"ctrl"!==s&&"shift"!==s&&"alt"!==s&&t.push(s),t.join("+")}factory(e){const t=this;return{register:s=>t.register(e,s)}}keyDown(e,t){const s=S.translate(e);return this.keyCode={key:e.key,code:s},this.dispatcher.execute(s,t)}register(e,t){return this.dispatcher.register(e,t)}}const M=()=>{},T=()=>!0,j=()=>!1,N=e=>e,A=(...e)=>{const t=e.length,s=e.map((e=>""+e));return t>0?s[0]+s.slice(1).map((e=>e[0].toUpperCase()+e.substring(1,e.length))).join(""):""},P=e=>{if(e){return/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(e)}return!1};function V(e,t){return e===t?0:null==e||""===e?1:null==t||""===t?-1:e>t?1:-1}function D(e,t,s){const n=t.length,o=[],r=e.length;let i=r;for(;i--;){const s=e[i],r=[];for(let e=0;e<n;e++){const n=t[e];r.push(n(s))}o.push({row:s,criteria:r,index:i})}for(o.sort(((e,t)=>{let o=0;for(let r=0;r<n;r++){if(o=(0,s[r])(e.criteria[r],t.criteria[r],e.row,t.row),0!==o)return o}return e.index-t.index})),i=r;i--;)o[i]=o[i].row;return o}function z(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function B(e){return e?e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"):e}function H(e,t){let s=0,n=e.length;for(;s<n;){const o=s+n>>>1;e[o]<t?s=o+1:n=o}return s}function W(e){var t=document.createElement("a");return t.href=e,t.host&&t.host!=window.location.host}function U(e){return null!=(""+e).match(/\.(jpeg|jpg|gif|png)$/)}function _(e){return/^(\d{4})(-(\d{2})(-(\d{2})([T ](\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|(([-+])(\d{2})(:?(\d{2})))))))$/.test(""+e)}function K(e){if(e.name)return e.name;const t=/function (.{1,})\(/.exec(e.constructor.toString());return t&&t.length>1?t[1]:""}const G=e=>"*"!==e.shortcut;class J{constructor(){this.managerMap=new Map}register(e,t){t=t.values?t.values():t;let s=this.managerMap.get(e);s||(s={commands:[],shortcuts:new Map},this.managerMap.set(e,s));const n=[];for(let e of t)e.shortcut&&(a(e.shortcut)?(s.commands.push(e),n.push((()=>{const t=s.commands.indexOf(e);t>=0&&s.commands.splice(t,1)}))):e.shortcut.toLowerCase().split("|").forEach((t=>{let o=[];s.shortcuts.has(t)&&(o=s.shortcuts.get(t)),o.push(e),s.shortcuts.set(t,o),n.push((()=>{const n=s.shortcuts.get(t);if(n){const o=n.indexOf(e);o>=0&&(n.splice(o,1),n.length||s.shortcuts.delete(t))}}))})));return()=>{n.forEach((e=>e())),0===s.commands.length&&0===Object.keys(s.shortcuts).length&&this.managerMap.delete(e)}}execute(e,t){return this.fetchActivities(e,t).reduce(((e,s)=>{const n=s.commands,o=s.manager.invoke(n,null,t)||o;return o&&e.push(...n.map((e=>e.source))),e}),[])}canExecute(e,t){return this.fetchActivities(e,t).length>0}fetchActivities(e,t){const s=this.searchFactory(e),n=Array.from(this.managerMap.entries()).map((([e,n])=>({manager:e,commands:e.filter(s(n),t)}))),r=o(n.map((e=>e.commands))).filter(G).length>0?G:T;return n.map((({commands:e,manager:t})=>({manager:t,commands:e.filter(r)}))).filter((({commands:e})=>e.length>0))}searchFactory(e){return t=>{let s=[];return t.shortcuts.has(e)&&(s=s.concat(t.shortcuts.get(e))),t.shortcuts.has("*")&&"*"!==e&&(s=s.concat(t.shortcuts.get("*"))),s=s.concat(t.commands.map((e=>e.clone({shortcut:e.shortcut()}))).filter((t=>this.test(t.shortcut,e)))),s}}test(e,t){return t=t.toLowerCase(),(""+e).toLowerCase().split("|").some((e=>"*"===e||t===e))}}class Y{constructor(e=(e=>e()),t){this.apply=e,this.context=t}invoke(e,t){if(t=t||this.context,e.length){const s=Array.from(e);return s.sort(((e,t)=>t.priority-e.priority)),this.apply((()=>{for(const e of s)if(t){if(!1===e.execute(t))break}else if(!1===e.execute())break})),!0}return!1}filter(e){return e.filter((e=>e.sink=e.canExecute()))}}class X{constructor(){this.resource=new $,this.items=[],this.shortcut=new S(new J),this.manager=new Y}}class Z{constructor(){this.apply=[]}}class Q{static mutate(e){return Q.invoke((()=>x.mutate(e)))}static measure(e){return Q.invoke((()=>x.measure(e)))}static clear(e){return Q.invoke((()=>x.clear(e)))}static invoke(e){return e()}}const ee="q-grid";class te{constructor(e){this.handlers=[],this.lastArg=null,this.reply=e||(()=>this.lastArg)}on(e,t="app"){const{handlers:s}=this,n={next:e,lifecycle:t},o=()=>{const e=s.indexOf(n);e>=0&&s.splice(e,1)};return n.off=o,s.push(n),o}watch(e,t="app"){const s=this.on(e,t);if(this.lastArg){e(this.reply(),s)}return s}emit(e){this.lastArg=e;const t=Array.from(this.handlers);for(let s=0,n=t.length;s<n;s++){const n=t[s];n.next(e,n.off)}}}class se{constructor(){this.promise=new ne}reject(){this.promise.reject()}resolve(e){this.promise.resolve(e)}}class ne{constructor(){this.catchEvent=new te,this.thenEvent=new te}reject(){return this.catchEvent.emit(),this}resolve(e){return this.thenEvent.emit(e),this}catch(e){return this.catchEvent.on(e),this}then(e){return this.thenEvent.on(e),this}}class oe extends Error{constructor(e,t){super(t),this.name=this.constructor.name,this.message=`qgrid.${e}: ${t}`,a(Error.captureStackTrace)?Error.captureStackTrace(this,this.constructor):this.stack=new Error(t).stack}}function re(e){let t=null;return s=>{if(t&&(t.reject(),t=null),!a(s))throw new oe("job.line","job is not invocable");return t=re.run((()=>{t&&(s(),t.resolve(),t=null)}),e),t.promise}}re.run=(e,t)=>{const s=new se,n=Q.invoke((()=>setTimeout(e,t)));return s.promise.catch((()=>clearTimeout(n))),s};class ie{constructor(e){this.plugin=e,this.scrollingJob=re(100)}scroll(e){const{model:t,table:s}=this.plugin,{scroll:n}=t,o=n(),r={};let i=!1;o.top!==e.scrollTop&&(s.view.addClass("q-grid-scroll-vertical"),r.top=e.scrollTop,i=!0),o.left!==e.scrollLeft&&(s.view.addClass("q-grid-scroll-horizontal"),r.left=e.scrollLeft,i=!0),i&&n(r,{source:"body.core",behavior:"core"}),this.scrollingJob(this.scrollEnd.bind(this))}scrollEnd(){const{table:e}=this.plugin;e.view.removeClass("q-grid-scroll-vertical"),e.view.removeClass("q-grid-scroll-horizontal")}wheel(e){if(e.shiftKey)return;const{model:t,table:s}=this.plugin;if("view"===t.edit().status){const{scroll:n}=t,o=0;Q.measure((()=>{const t=s.view.scrollHeight()-s.view.height(),r=100*Math.sign(e.deltaY),i=Math.min(t,Math.max(o,n().top+r));n({top:i},{source:"body.core"})}))}}mouseLeave(){this.clearHighlight()}clearHighlight(){const{view:e}=this.plugin,{highlight:t}=e;t.clear.canExecute()&&t.clear.execute()}}class ce{static info(e,t){}static warn(e,t){}static error(e,t){console.error(`qgrid.${e}: ${t}`)}}class le{constructor(e,t=0,s="group"){this.key=e,this.level=t,this.rows=[],this.children=[],this.type=s,this.source=null,this.value=null,this.state={expand:!1}}}class ae{constructor(e,t){this.item=e,this.column=t}}function ue(e){const t=e.length-1,s=me(e,t),n=e[t];return s?function(t,o){if(2===arguments.length){const r=s(t);return r&&(r[n]=o),void ce.warn("path.compile",`Object reference ${e.join(".")} is not set.`)}const r=s(t);return r?r[n]:(ce.warn("path.compile",`Object reference ${e.join(".")} is not set.`),null)}:function(t,s){return t?(2===arguments.length&&(t[n]=s),t[n]):(ce.warn("path.compile",`Object reference ${e.join(".")} is not set.`),null)}}function he(e){const t=e.split("."),s=t.length-1,n=me(t,s),o=t[s];return n?function(e){const s=n(e);return s?s[o]:(ce.warn("path.compile",`Object reference ${t.join(".")} is not set.`),null)}:function(e){return e?e[o]:(ce.warn("path.compile",`Object reference ${t.join(".")} is not set.`),null)}}function de(e){const t=e.split("."),s=t.length-1,n=me(t,s),o=t[s];return n?function(e,s){const r=n(e);r?r[o]=s:ce.warn("path.compile",`Object reference ${t.join(".")} is not set.`)}:function(e,s){e?e[o]=s:ce.warn("path.compile",`Object reference ${t.join(".")} is not set.`)}}function me(e,t){if(e.length>1){const s=e[0];return e.filter(((e,s)=>s>0&&s!==t)).reduce(((e,t)=>s=>{const n=e(s);return n?n[t]:null}),(e=>e?e[s]:null))}return null}function ge(e,t){return t.$value?t.$value({$row:e,$column:t}):t.value?t.value(e):t.path?he(t.path)(e):e[t.key]}function pe(e){return e.$value?t=>e.$value({$row:t,$column:e}):e.value?t=>e.value(t):e.path?he(e.path):t=>t[e.key]}function we(e,t,s){if(a(t.$value))return t.$value({$row:e,$value:s,$column:t});if(a(t.value))return t.value(e,s);if(t.path)return de(t.path)(e,s);if(e.hasOwnProperty(t.key))return e[t.key]=s;throw new oe("value",`Row can't be edit on "${t.key}" column`)}function fe(e,t){return t.$label?a(t.$label)?t.$label({$row:e}):t.$label:t.label?a(t.label)?t.label(e):t.label:t.labelPath?he(t.labelPath)(e):ge(e,t)}function ye(e){return e.$label?a(e.$label)?t=>e.$label({$row:t}):t=>e.label:e.label?a(e.label)?t=>e.label(t):t=>e.label:e.labelPath?he(e.labelPath):t=>ge(t,e)}function be(e,t,s){return a(t.$label)?t.$label({$row:e,$label:s}):a(t.label)?t.label(e,s):t.labelPath?de(t.labelPath)(e,s):void 0}class ve{constructor(e,t){const{model:s,observeReply:n}=e;let o=new Map;const r=(e,s,n,r,i)=>{const c=`valueFactory-${s.key}`;return(n=o.get(c))||(n=pe(s),o.set(c,n)),t.getValue(e,s,n,r,i)},i=(e,t,s,n,i)=>{const c=`getValue-${n}x${t.key}`;if(o.has(c))return o.get(c);const l=r(e,t,s,n,i);return o.set(c,l),l},c=(e,s,n,r,i)=>{const c=`labelFactory-${s.key}`;return(n=o.get(c))||(n=ye(s),o.set(c,n)),t.getLabel(e,s,n,r,i)},l=(e,t,s,n,r)=>{const i=`getLabel-${n}x${t.key}`;if(o.has(i))return o.get(i);const l=c(e,t,s,n,r);return o.set(i,l),l};this.getValue=r,this.getLabel=c,this.colspan=(e,s,n,r)=>{const i=`colspan-${n}x${s.model.key}`;if(o.has(i))return o.get(i);const c=t.colspan(e,s,n,r);return o.set(i,c),c},this.rowspan=(e,s,n,r)=>{const i=`rowspan-${n}x${s.model.key}`;if(o.has(i))return o.get(i);const c=t.rowspan(e,s,n,r);return o.set(i,c),c},this.columns=(e,s,n)=>{const r=`columns-${s}-${n}`;if(o.has(r))return o.get(r);const i=t.columns(e,s,n);return o.set(r,i),i},this.setValue=(...e)=>t.setValue(...e),this.setLabel=(...e)=>t.setLabel(...e),this.columnList=(e="mid")=>{const s=`columnList-${e}`;if(o.has(s))return o.get(s);const n=t.columnList(e);return o.set(s,n),n},n(s.sceneChanged).subscribe((e=>{e.hasChanges("status")&&"stop"!==e.state.status&&(o=new Map)})),n(s.gridChanged).subscribe((e=>{e.hasChanges("isReadonly")&&(o=new Map,e.state.isReadonly?(this.getValue=i,this.getLabel=l):(this.getValue=getValue,this.getLabel=this.getLabel))}))}}function xe(e,t,s){return s(e,t)}class Ce{constructor(e){const{model:t,observeReply:s}=e;let n={};s(t.sceneChanged).subscribe((e=>{e.hasChanges("column")&&(n=e.state.column.area,e.state.column.line)})),this.getValue=xe,this.getLabel=xe,this.setValue=we,this.setLabel=be,this.colspan=(e,t)=>t.colspan,this.rowspan=()=>1;const o=(e="mid")=>n[e]||[];this.columnList=o,this.columns=(e,t)=>o(t)}}const ke={};class Ee{constructor(){}static register(e,t){if(ke.hasOwnProperty(e))throw new oe("template.path",`"${e}" is already registered`);return ke[e]=t,Ee}static get(e){const t=this.find(e);if(!t)throw new oe("template.path","Template path can't be found");return t}static find(e){const t=this.name;for(let s of Object.keys(ke)){const n=e[t(s)];if(!m(n)&&null!==n){const t=ke[s](e,n);if(t)return t}}return null}static getName(e){return"_"+e}static get require(){const e=this.name;return Object.keys(ke).reduce(((t,s)=>(t[e(s)]=`^^?${s}`,t)),{})}}Ee.register("custom-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("custom-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class $e{constructor(e="text"){this.key=null,this.path=null,this.labelPath=null,this.type=e,this.title=null,this.description=null,this.pin="mid",this.origin="specific",this.source="user",this.category="data",this.class=null,this.editor=null,this.editorOptions={modelFactory:({createDefaultModel:e})=>e(),trigger:"click",cruise:"control",label:null,value:N,actions:[]},this.width=null,this.minWidth=null,this.maxWidth=null,this.viewWidth=null,this.widthMode="relative",this.canEdit=!0,this.canResize=!0,this.canSort=!0,this.canMove=!0,this.canFilter=!0,this.canHighlight=!0,this.canFocus=!0,this.isVisible=!0,this.index=-1,this.value=null,this.label=null,this.compare=V,this.children=[],this.$label=null,this.$value=null,this.itemLabel=N,this.startNumber=1}toString(){return`${this.type}: ${this.title}`}}class Re{constructor(e){this.model=e,this.colspan=1,this.rowspan=1,this.rowIndex=-1,this.columnIndex=-1}static model(e){return e?Re.assign(e):e=new $e,e.origin="custom",e}static assign(e){const t=this.model();for(let s of Object.keys(t))if(e.hasOwnProperty(s)){const n=e[s];r(n)?e[s]=Array.from(n):h(n)&&!a(n)&&(e[s]=Object.assign({},t[s],n))}else{let n=t[s];a(n)&&(n=n.bind(e)),e[s]=n}return e}}class Ie{static number(e,t){return e}static date(e,t){return e}static currency(e,t){return e}}class Oe extends $e{constructor(){super(...arguments),this.isDefault=!0,this.aggregation=null,this.aggregationOptions={distinct:!1,separator:"; "}}}Ee.register("array-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("array-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class Fe extends Oe{constructor(){super("array"),this.itemType="text",this.itemFormat="",this.label=function(e){const t=ge(e,this);if(r(t)){let e;switch(this.itemType){case"number":e=Ie.number;break;case"date":case"datetime":e=Ie.date;break;default:e=this.itemLabel.bind(this)}const s=this.itemFormat;return t.map((t=>e(t,s))).join(", ")}return t}}}class qe extends Re{constructor(e){super(e)}static model(e){return e?qe.assign(e):new Fe}}Ee.register("bool-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("bool-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class Le extends Oe{constructor(){super("bool"),this.trueValue=!0,this.falseValue=!1,this.editorOptions.cruise="transparent",this.isIndeterminate=function(e){return!(e===this.trueValue||e===this.falseValue)},this.isChecked=function(e){return e===this.trueValue}}}class Se extends Re{constructor(e){super(e)}static model(e){return e?Se.assign(e):new Le}}Ee.register("cohort-cell",(e=>({model:e.for,resource:`${e.for}.${e.type}`})));class Me extends $e{constructor(){super("cohort"),this.key="$cohort",this.canEdit=!1,this.canSort=!1,this.canResize=!1,this.canFocus=!1,this.canFilter=!1,this.category="cohort"}}class Te extends Re{constructor(e){super(e)}static model(e){return e?Te.assign(e):new Me}}Ee.register("currency-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("currency-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class je extends Oe{constructor(){super("currency"),this.maxLength=20,this.symbol="$",this.code="USD"}}class Ne extends Re{constructor(e){super(e)}static model(e){return e?Ne.assign(e):new je}}function Ae(e,t){if("id"===e)e=t||"text";switch(e){case"text":case"email":case"url":case"password":return _e;case"number":case"currency":return Je;case"date":return Ke;case"time":case"datetime":return Ge;case"bool":return Ue;case"array":return Ye;default:return N}}function Pe(e,t){if("id"===e)e=t||"text";switch(e){case"date":return e=>{const t=Ke(e);return t?t.getTime():t};case"time":case"datetime":return e=>{const t=Ge(e);return t?t.getTime():t};default:return Ae(e,t)}}function Ve(e){const t=e.filter((e=>!(m(e)||null===e||""===e))).map(De);if(t.length){const e=t[0];if(t.every((t=>t===e)))return e}return"text"}function De(e){if(r(e)){if(e.length){if(!He(Be(e[0])))return"collection"}return"array"}return u(e)?"number":i(e)?"bool":c(e)?"datetime":d(e)?"text":h(e)?"object":"text"}function ze(e){const t=e.filter((e=>!(m(e)||null===e||""===e))).map(Be);if(t.length){const e=t[0];if(t.every((t=>t===e)))return e}return"text"}function Be(e){if(r(e)){if(e.length){if(!He(Be(e[0])))return"collection"}return"array"}return function(e){if(isNaN(e))return!1;const t=Number.parseFloat(e);return!isNaN(t)&&isFinite(t)}(e)?"number":i(e)?"bool":function(e){if(null===e||m(e)||""===e)return!1;if(e instanceof Date)return!0;return _(e=""+e)}(e)?"datetime":We(e)?"date":P(e)?"email":U(e)?"image":W(e)?"url":d(e)?"text":h(e)?"object":"text"}function He(e){switch(e){case"date":case"time":case"bool":case"text":case"number":case"email":case"url":return!0;default:return!1}}function We(e){return null!==e&&!m(e)&&""!==e&&(e instanceof Date||!!(e=""+e).match(/^(\d{4})(-(\d{2})(-(\d{2})))$/))}function Ue(e){return null===e||m(e)?e:!!e}function _e(e){return null===e||m(e)?e:""+e}function Ke(e){if(null===e||m(e))return e;if(""===e)return null;if(e instanceof Date)return new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0,0);if(We(e)||_(e)){const t=(""+e).split("-");return new Date(Number.parseInt(t[0]),Number.parseInt(t[1])-1,Number.parseInt(t[2]),0,0,0,0)}return new Date(""+e)}function Ge(e){if(null===e||m(e))return e;if(""===e)return null;if(e instanceof Date)return e;return new Date(""+e)}function Je(e){if(null===e||m(e))return e;if(""===e||isNaN(e))return null;const t=Number.parseFloat(e);return!isNaN(t)&&isFinite(t)?t:null}function Ye(e){return e}Ee.register("date-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("date-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class Xe extends Oe{constructor(){super("date"),this.format="MM/dd/yyyy",this.parse=Ae("date"),this.label=function(e){const t=ge(e,this);try{const e=this.parse(t);return Ie.date(e,this.format)}catch(e){return ce.error("date.column",e),t}}}}class Ze extends Re{constructor(e){super(e)}static model(e){return e?Ze.assign(e):new Xe}}Ee.register("datetime-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("datetime-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class Qe extends Oe{constructor(){super("datetime"),this.format="MM/dd/yyyy h:mm a",this.dateFormat="MM/dd/yyyy",this.timeFormat="h:mm a",this.parse=Ae("datetime"),this.label=function(e){const t=ge(e,this);try{const e=this.parse(t);return Ie.date(e,this.format)}catch(e){return ce.error("datetime.column",e),t}}}}class et extends Re{constructor(e){super(e)}static model(e){return e?et.assign(e):new Qe}}Ee.register("email-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("email-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class tt extends Oe{constructor(){super("email"),this.editorOptions.trigger="custom"}}class st extends Re{constructor(e){super(e)}static model(e){return e?st.assign(e):new tt}}function nt(e){return!!e&&e.toLowerCase().search(/png|jpg|jpeg|svg/)>-1}Ee.register("file-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("file-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class ot extends Oe{constructor(){super("file"),this.canUpload=T,this.editorOptions.trigger="custom",this.hasPreview=e=>nt(e),this.canSort=!1,this.canFilter=!1}}class rt extends Re{constructor(e){super(e)}static model(e){return e?rt.assign(e):new ot}}Ee.register("group-cell",((e,t)=>({model:e.for,resource:t.type}))),Ee.register("group-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class it extends $e{constructor(){super("group"),this.key="$group",this.path="key",this.labelPath="key",this.title="Group",this.offset=24,this.canEdit=!1,this.canSort=!1,this.canFilter=!1,this.category="control",this.by=null,this.label=function(e){if("row"===e.type)return"";const{by:t,labelPath:s}=this;return t&&t!==e.source?"":e[s]}}}class ct extends Re{constructor(e){super(e)}static model(e){return e?ct.assign(e):new it}}Ee.register("group-summary-cell",((e,t)=>({model:e.for,resource:t.key})));class lt extends Oe{constructor(){super("group-summary"),this.key="$group.summary",this.category="control",this.canEdit=!1,this.canResize=!1,this.canHighlight=!1,this.canFilter=!1,this.canSort=!1,this.canMove=!1}}class at extends Re{constructor(e){super(e)}static model(e){return e?at.assign(e):new lt}}Ee.register("id-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("id-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class ut extends Oe{constructor(){super("id")}}class ht extends Re{constructor(e){super(e)}static model(e){return e?ht.assign(e):new ut}}Ee.register("image-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("image-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class dt extends Oe{constructor(){super("image"),this.canSort=!1,this.canFilter=!1,this.canUpload=T,this.hasPreview=e=>nt(e)}}class mt extends Re{constructor(e){super(e)}static model(e){return e?mt.assign(e):new dt}}Ee.register("number-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("number-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class gt extends Oe{constructor(){super("number"),this.format=""}}class pt extends Re{constructor(e){super(e)}static model(e){return e?pt.assign(e):new gt}}Ee.register("pad-cell",(e=>({model:e.for,resource:`${e.for}.${e.type}`})));class wt extends $e{constructor(){super("pad"),this.key="$pad",this.category="markup",this.title="",this.canEdit=!1,this.canSort=!1,this.canResize=!1,this.canHighlight=!1,this.canFocus=!1,this.canMove=!1,this.canFilter=!1,this.source="generation"}}class ft extends Re{constructor(e){super(e)}static model(e){return e?ft.assign(e):new wt}}Ee.register("password-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("password-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class yt extends Oe{constructor(){super("password"),this.canSort=!1,this.canFilter=!1}}class bt extends Re{constructor(e){super(e)}static model(e){return e?bt.assign(e):new yt}}Ee.register("pivot-cell",(e=>({model:"pivot",resource:e.for})));class vt extends $e{constructor(){super("pivot"),this.key="$pivot",this.title="Pivot",this.source="generation",this.category="pivot",this.canEdit=!1,this.canSort=!1,this.canResize=!1,this.canFilter=!1,this.canMove=!1}}class xt extends Re{constructor(e){super(e)}static model(e){return e?xt.assign(e):new vt}}const Ct=Object.prototype.hasOwnProperty;class kt{static notUndefined(e,t){if(m(e))throw new oe("guard.notUndefined",t)}static notNull(e,t){if(null===e||m(e))throw new oe("guard.notNull",t)}static notNullOrEmpty(e,t){if(null===e||m(e)||""===e)throw new oe("guard.notNullOrEmpty",t)}static invokable(e,t){if(!a(e))throw new oe("guard.invokable",t)}static hasProperty(e,t){if(kt.notNull(e,"instance"),!Ct.call(e,t))throw new oe("guard.hasProperty",t)}}class Et{constructor(){this.accessors=new Map}inject(e,t){const s=this.resolveAccessor(e,t);this[e+"Changed"]=s.changed,this[e]=s.state}resolveAccessor(e,t){if(this.accessors.has(e))throw new oe("model",`${e} accessor already exists`);const s=this.buildAccessor(e,t);return this.accessors.set(t,s),s}buildAccessor(e,t){let s=new t;const n=new Set,o=new te((()=>{const e=Array.from(n.values()).reduce(((e,t)=>{const n=s[t];return e[t]={newValue:n,oldValue:n},e}),{});return{state:s,changes:e,hasChanges:e.hasOwnProperty.bind(e),tag:{},source:"watch"}})),i=(t,i)=>{if(!h(t))throw new oe(`model.${e}`,`"${t}" is not a valid type, should be an object`);const c={};let l=!1;const a=Object.keys(t);for(let o=0,i=a.length;o<i;o++){const i=a[o];if(!s.hasOwnProperty(i))throw new oe(`model.${e}`,`"${i}" is not a valid key, only [${Object.keys(s).join(", ")}] keys are supported`);const h=t[i],m=s[i];(u=h)===(d=m)||r(u)&&0===u.length&&0===d.length||u instanceof Map&&0===u.size&&0===d.size||u instanceof Set&&0===u.size&&0===d.size?ce.warn("model",`value was not changed - "${e}.${i}"`):(ce.info("model",`value changed - "${e}.${i}"`),kt.notUndefined(h,`model.${e}.${i}`),s[i]=h,l=!0,c[i]={newValue:h,oldValue:m},n.add(i))}var u,d;return l&&(s={...s},o.emit({state:s,changes:c,hasChanges:c.hasOwnProperty.bind(c),tag:i||{},source:"emit"})),this};return{changed:o,state:(...e)=>e.length?i(e[0],e[1]):s}}resolve(e){let t=this.accessors.get(e);if(!t){const s=K(e);t=this.resolveAccessor(s,e)}return t}}Ee.register("reference-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("reference-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class $t extends Oe{constructor(){super("reference"),this.editorOptions.trigger="custom"}}class Rt extends Re{constructor(e){super(e)}static model(e){return e?Rt.assign(e):new $t}}Ee.register("row-details-cell",((e,t)=>({model:e.for,resource:t.key})));class It extends $e{constructor(){super("row-details"),this.key="$row.details",this.category="control",this.canEdit=!1,this.canResize=!1,this.canHighlight=!1,this.canFilter=!1,this.canSort=!1,this.canMove=!1}}class Ot extends Re{constructor(e){super(e)}static model(e){return e?Ot.assign(e):new It}}Ee.register("row-expand-cell",((e,t)=>({model:e.for,resource:t.key})));class Ft extends $e{constructor(){super("row-expand"),this.key="$row.expand",this.category="control",this.canEdit=!1,this.canResize=!1,this.canFilter=!1,this.canSort=!1,this.canHighlight=!1,this.canMove=!1}}class qt extends Re{constructor(e){super(e)}static model(e){return e?qt.assign(e):new Ft}}Ee.register("row-indicator-cell",((e,t)=>({model:e.for,resource:t.key})));class Lt extends $e{constructor(){super("row-indicator"),this.key="$row.indicator",this.category="control",this.canEdit=!1,this.canSort=!1,this.canResize=!1,this.canMove=!1,this.canFocus=!1,this.canHighlight=!1,this.canFilter=!1,this.pin="left"}}class St extends Re{constructor(e){super(e)}static model(e){return e?St.assign(e):new Lt}}Ee.register("row-number-cell",((e,t)=>({model:e.for,resource:t.key})));class Mt extends $e{constructor(){super("row-number"),this.pin="left",this.key="$row.number",this.title="No.",this.canEdit=!1,this.canResize=!0,this.canFocus=!1,this.canMove=!1,this.canHighlight=!1,this.canSort=!1,this.canFilter=!1,this.category="control"}}class Tt extends Re{constructor(e){super(e)}static model(e){return e?Tt.assign(e):new Mt}}Ee.register("row-options-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("row-options-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class jt extends Oe{constructor(){super("row-options"),this.key="$row.options",this.category="control",this.canEdit=!0,this.canResize=!1,this.canMove=!1,this.canHighlight=!1,this.canFilter=!1,this.pin="right"}}class Nt extends Re{constructor(e){super(e)}static model(e){return e?Nt.assign(e):new jt}}Ee.register("select-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("select-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class At extends $e{constructor(){super("select"),this.key="$select",this.title="",this.category="control",this.canEdit=!1,this.editorOptions.cruise="transparent",this.value=M,this.canResize=!1}}class Pt extends Re{constructor(e){super(e)}static model(e){return e?Pt.assign(e):new At}}Ee.register("text-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("text-cell-edit",((e,t)=>({model:"edit",resource:t.key}))),Ee.register("text-area-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class Vt extends Oe{constructor(){super("text"),this.maxLength=140}}class Dt extends Re{constructor(e){super(e)}static model(e){return e?Dt.assign(e):new Vt}}Ee.register("time-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("time-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class zt extends Oe{constructor(){super("time"),this.format="h:mm a"}}class Bt extends Re{constructor(e){super(e)}static model(e){return e?Bt.assign(e):new zt}}Ee.register("url-cell",((e,t)=>({model:e.for,resource:t.key}))),Ee.register("url-cell-edit",((e,t)=>({model:"edit",resource:t.key})));class Ht extends Oe{constructor(){super("url"),this.editorOptions.trigger="custom"}}class Wt extends Re{constructor(e){super(e)}static model(e){return e?Wt.assign(e):new Ht}}function Ut(s,n){return s&&n?e(s,n,((e,t)=>m(e)?t:e)):s||t(n)}function _t(e){const{columnList:t}=e,s={array:qe,bool:Se,cohort:Te,currency:Ne,custom:Re,date:Ze,datetime:et,email:st,file:rt,group:ct,id:ht,image:mt,number:pt,pad:ft,password:bt,pivot:xt,reference:Rt,"row-details":Ot,"row-expand":qt,"row-indicator":St,"row-number":Tt,"row-options":Nt,select:Pt,"group-summary":at,text:Dt,time:Bt,url:Wt},n=(e,n,o)=>{const r=s[e],{reference:i}=t();o=Ut(o,i.$default);o=Ut(o,i[n]);const c=r.model(o);return new r(c)};return(e,t=null)=>(e||(e="text"),s.hasOwnProperty(e)?n(e,e,t):n("custom",e,t))}class Kt{constructor(e,t){const s=_t(e)("pad",{key:"row-details-pad"});this.columns=t.getColumns,this.rowspan=t.rowspan,this.colspan=(e,s)=>f(t.columnList(s.model.pin),(e=>e.colspan)),this.columns=(e,t)=>e.column.model.pin===t?[e.column]:[s],this.getValue=()=>null,this.getLabel=()=>null,this.setValue=()=>null,this.setLabel=()=>null}}class Gt{constructor(){}static first(e,t){return e.length?t(e[0]):null}static last(e,t){const s=e.length;return s?t(e[s-1]):null}static max(e,t){let s=e.length;if(!s)return null;let n=Number.MIN_SAFE_INTEGER;for(;s--;)n=Math.max(n,t(e[s]));return n}static min(e,t){let s=e.length;if(!s)return null;let n=Number.MAX_SAFE_INTEGER;for(;s--;)n=Math.min(n,t(e[s]));return n}static minMax(e,t){let s=e.length;if(!s)return null;let n=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;for(;s--;){const r=t(e[s]);n=Math.min(n,r),o=Math.max(o,r)}return[n,o]}static avg(e,t,s){const n=e.length;if(!n)return null;if(s.distinct){const n=new Set;return Gt.sum(e,t,s,n)/n.size}return Gt.sum(e,t,s)/n}static sum(e,t,s,n){let o=e.length;if(!o)return null;let r=0;if(s.distinct)for(n=n||new Set;o--;){const s=t(e[o]);n.has(s)||(r+=s,n.add(s))}else for(;o--;)r+=Number(t(e[o]));return r}static join(e,t,s){const n=e.length;if(!n)return null;let o=t(e[0]);const r=s.separator||"";if(s.distinct){const s=new Set;let i=o;s.add(i);let c=1;for(;c<n;)i=t(e[c]),s.has(i)||(o+=r+i,s.add(i)),c++}else{let s=1;for(;s<n;)o+=r+t(e[s]),s++}return o}static count(e,t,s){let n=e.length;if(!n)return null;if(s.distinct){let s=new Set;for(;n--;){const o=Number(t(e[n]));s.add(o)}return s.size}return n}}function Jt(e){const{mode:t,summary:s}=e.group();let n=(e,t,s)=>s.push(e);if("rowspan"===t)n=(e,t,s)=>{(0===e.level||t>0)&&s.push(e)};let o=M;if("leaf"===s)o=(e,t,s,n,o)=>{if(n&&n.children.length-1===o){const{level:t,key:n}=e,o=new le(`${n}-group-summary`,t,"summary");o.rows=Array.from(e.rows),s.push(o)}};return function e(t,s=[],r=null,i=0){for(let c=0,l=t.length;c<l;c++){const l=t[c];if(n(l,c,s,r,i),l.state.expand){const t=l.children;if(t.length)e(t,s,l,c);else{const{rows:e,level:o,key:c}=l,a=o+1;for(let o=0,l=e.length;o<l;o++){const l=new le(c,a,"row"),u=e[o];l.rows=[u],t.push(l),n(l,o,s,r,i)}}o(l,c,s,r,i)}}return s}}function Yt(e){return"group"!==e.type?e:e.state.expand?e.children.length&&Yt(e.children[0]):null}class Xt{constructor(e,t){const{columnList:s,rowspan:n}=t;this.columnList=s,this.rowspan=n;const o=_t(e),r={group:o("group"),summary:o("group-summary")};this.getLabel=this.getValue=(s,n,o,r,i)=>{if("pivot"===n.type)return t.getLabel(s,n,o,r,i);const{rows:c}=e.data();switch(s.type){case"group":case"summary":{const e=n.aggregation;if(e){if(!Gt.hasOwnProperty(e))throw new oe("node.row",`Aggregation ${e} is not supported`);const t=s.rows.map((e=>c[e]));return Gt[e](t,o,n.aggregationOptions)}return null}case"row":{const e=s.rows[0];return o(c[e],n)}case"value":return o(s,n);default:throw new oe("node.row",`Invalid node type ${s.type}`)}},this.setValue=(s,n,o,r,i)=>{switch(s.type){case"row":{const{rows:r}=e.data(),c=s.rows[0];t.setValue(r[c],n,o,c,i);break}case"value":t.setValue(s,n,o,r,i);break;default:throw new oe("node.row",`Can't set value to ${s.type} node`)}},this.setLabel=(s,n,o,r,i)=>{switch(s.type){case"row":{const{rows:r}=e.data(),c=s.rows[0];t.setLabel(r[c],n,o,c,i);break}case"value":t.setLabel(s,n,o,r,i);break;default:throw new oe("node.row",`Can't set label to ${s.type} node`)}},this.colspan=(e,t)=>"summary"===e.type?f(s(t.model.pin),(e=>e.colspan)):t.colspan,this.columns=(e,t)=>"summary"===e.type?[r.summary]:s(t),this.findGroupColumn=e=>{let t=s().find((e=>"group"===e.model.type));if(!t&&(t=r.group,t.model.pin===e)){const n=s(e)[0];t.columnIndex=n?n.columnIndex:0}return t.model.pin!==e?null:t}}}class Zt{constructor(e,t){const{columnList:s,getValue:o,getLabel:r,columns:i}=t;this.setValue=t.setValue,this.setLabel=t.setLabel,this.colspan=t.colspan,this.columnList=s;const c=(e,t,s=!0)=>{if("group"===e.type)if("group"===t.model.type){if(e.state.expand){if(!s||e.source===t.model.by)return e.children.reduce(((e,s,n)=>e+c(s,t,!1)),0);if(e.children.length)return c(e.children[0],t,!1)}return 1}return 1};this.rowspan=c;const l=t=>(s,n,o)=>{if("group"===s.type){const t=Yt(s);if(t){const{rows:s}=e.data();return o(s[t.rows[0]],n)}return null}return t(s,n,o)};this.getLabel=l(r),this.getValue=l(o),this.columns=(e,t)=>{switch(e.type){case"group":return n(s(t),(t=>"group"===t.model.type&&t.model.by!==e.source));case"row":return s(t).filter((e=>"group"!==e.model.type))}return i(e,t)}}}class Qt{constructor(e){const{columnList:t,columns:s,findGroupColumn:o}=e;this.setValue=e.setValue,this.setLabel=e.setLabel,this.getValue=e.getValue,this.getLabel=e.getLabel,this.rowspan=e.rowspan,this.columnList=t,this.colspan=(s,n)=>{if("group"===s.type)if("group"===n.model.type){if(o(n.model.pin)){const e=t(n.model.pin),s=y(e,(e=>!e.model.aggregation));return f(s,(e=>e.colspan))}}return e.colspan(s,n)},this.columns=(e,r)=>{switch(e.type){case"group":{const e=o(r);if(e){const s=n(t(r),(e=>!e.model.aggregation));return[e].concat(s)}break}}return s(e,r)}}}class es{constructor(e){this.build=e}get instance(){return this.value||(this.value=this.build())}}function ts(e){const t=function(){const e=new Map;return function t(s,n=0){const{model:o}=s.key;if(e.has(o.key))return e.get(o.key);const{children:r}=s;let i=0==r.length?0:1;for(let e of r)i=Math.max(i,t(e,n+1));const c=1+i;return e.set(o.key,c),c}}();const s=[];return function e(s,n,o,r,i){const c=s.key,l=r-t(s);c.rowspan=l,c.rowIndex=n,c.columnIndex=o;const{children:a}=s;if(a.length){let t=0;const s=[];for(let i of a){const c=e(i,n+l,o,r-l,s);if(!c)continue;const{colspan:a}=c;t+=a,o+=a}c.colspan=t,t>0&&(i.push(c),i.push(...s))}else"cohort"!==c.model.type&&i.push(c);return c}(e,0,0,t(e),s),s.splice(0,1),function(e){const t=[];e.sort(((e,t)=>{const s=e.rowIndex-t.rowIndex;return 0===s?e.columnIndex-t.columnIndex:s}));for(let s of e)t[s.rowIndex]||(t[s.rowIndex]=[]),t[s.rowIndex].push(s);return t}(s)}function ss(e){const t=[],s=[];for(let n=0,o=e.length;n<o;n++){const o=e[n],r=s.length>n?s[n]:s[n]=[0];for(let e=0,i=o.length;e<i;e++){const i=o[e],{rowspan:c,colspan:l}=i,a=r[0],u=a+l;for(let e=0;e<c;e++){const o=n+e,r=t.length>o?t[o]:t[o]=[];for(let e=0;e<l;e++){r[a+e]=i}const c=s.length>o?s[o]:s[o]=[0],h=H(c,a);if(r[u])c.splice(h,1);else{const e=c[h];c.splice(h,r[e]?1:0,u)}}}}return t}function ns(e){const t=[],s=e.length;if(s){const n=new Set,o=e[s-1],r=o.length;for(let e=0;e<r;e++){const s=o[e];n.has(s)||(t.push(s),n.add(s))}}return t}function os(e,t=[]){for(let s=0,n=e.length;s<n;s++){const n=e[s];t.push(n);const{children:o}=n;o&&o.length&&os(o,t)}return t}function rs(e,t){for(let s=0,n=e.length;s<n;s++){const n=e[s];if(n.key===t)return{columns:e,index:s};const{children:o}=n;if(o.length){const e=rs(o,t);if(e)return e}}return null}function is(e){return e.reduce(((e,t)=>(e[t.key]=t,e)),{})}function cs(e){return a(e.value)?t=>e.value(t):t=>t[e.key]}function ls(e,t){const s=as(e,t);return s<0?null:e[s]}function as(e,t){let{length:s}=e;for(;s--;){if(e[s].key==t)return s}return-1}function us(e){const t=e.length;if(1===t)return Array.from(e[0]);if(t>1){return ns(ss(e))}return[]}function hs(e,t){const s=e.data.columns(),n=is(s),o=s.filter((e=>t.has(e.key)||(""+e.width).indexOf("%")<0)).reduce(((e,t)=>{const s=i(t);return null!==s&&(e+=s),e}),0);let r=new es((()=>e.view.width("head-mid")+e.view.width("head-left")+e.view.width("head-right")));function i(s){let n=s;t.has(s.key)&&(n=t.get(s.key));let{width:i}=n;if(i||0===i){if((""+i).indexOf("%")>=0){const e=Number.parseFloat(i);i=(r.instance-("absolute"===s.widthMode?2:o+2))*e/100}const e=0;return Math.max(Number.parseInt(i,10),Number.parseInt(s.minWidth,10)||e)}if("fit-head"===s.widthMode){const{cells:t}=e.head.context.bag,n=Array.from(t).find((e=>e.column===s));if(n)return e.head.cell(n.rowIndex,n.columnIndex).width()+2}return null}return e=>{let t=n[e];if(!t)throw new oe("column.service",`Column ${e} is not found`);return i(t)}}function ds(e){const{rows:t}=e.data(),{pivot:s}=e.view(),n=e.scene().rows,o=e.columnList().line,r=s.rows,i=r[0].length,c=e.group().by,l=c.length,a=is(o);return e=>{const s=[];for(let o=0,u=n.length;o<u;o++){const u=n[o],h=c[Math.min(u.level,l-1)],d=a[h];if(!d)throw new oe("group.build",`Invalid key "${h}"`);const m=d.aggregation||"count";if(!Gt.hasOwnProperty(m))throw new oe("group.build",`Aggregation ${m} is not registered`);const g=e(d),p=Gt[m],w=new Array(i);for(let e=0,s=u.rows.length;e<s;e++){const s=u.rows[e],n=r[s],o=t[s];for(let e=0;e<i;e++)if(n[e]){let t=w[e];t||(t=[],w[e]=t),t.push(o)}}s.push(w.map((e=>p(e,g,d.aggregationOptions))))}return s}}class ms{constructor(e,t){const{model:s,observeReply:n}=e;this.columns=t.columns,this.rowspan=t.rowspan,this.colspan=t.colspan,this.getValue=t.getValue,this.setValue=t.setValue,this.getLabel=t.getLabel,this.setLabel=t.setLabel,this.columnList=t.columnList;let o=[];n(s.sceneChanged).subscribe((e=>{if(e.hasChanges("column")||e.hasChanges("rows")){const{rows:n}=s.view().pivot;if(n.length){if(s.group().by.length){const e=ds(s);o=e(pe)}else o=n;const r=e.state.column.line.findIndex((e=>"pivot"===e.model.type));this.getValue=(e,s,n,i,c)=>{if("pivot"===s.type){return o[i][c-r]}return t.getValue(e,s,n,i,c)},this.getLabel=(e,s,n,i,c)=>{if("pivot"===s.type){return o[i][c-r]}return t.getLabel(e,s,n,i,c)}}else o=[],this.getValue=t.getValue,this.getLabel=t.getLabel}}))}}class gs{constructor(e){const{model:t,observe:s,observeReply:n}=e,o=new Ce(e),r=new ve(e,new ms(e,o)),i=new Xt(t,r),c=new ve(e,i),l=new ve(e,new Qt(i)),a=new ve(e,new Zt(t,i)),u=new ve(e,new Kt(t,r)),h=r,d=new Map;d.set(ae,u);const m=()=>{const{mode:e}=t.group();switch(e){case"subhead":d.set(le,l);break;case"rowspan":d.set(le,a);break;default:d.set(le,c)}};m(),s(t.groupChanged).subscribe(m),this.defaultStrategy=h,this.colspan=(e,t,s,n)=>(d.get(e.constructor)||h).colspan(e,t,s,n),this.rowspan=(e,t,s,n)=>(d.get(e.constructor)||h).rowspan(e,t,s,n),this.columns=(e,t,s)=>(d.get(e.constructor)||h).columns(e,t,s),this.getValue=(e,t,s,n)=>(d.get(e.constructor)||h).getValue(e,t,ge,s,n),this.setValue=(e,t,s,n,o)=>(d.get(e.constructor)||h).setValue(e,t,s,n,o),this.getLabel=(e,t,s,n)=>(d.get(e.constructor)||h).getLabel(e,t,fe,s,n),this.setLabel=(e,t,s,n,o)=>(d.get(e.constructor)||h).setLabel(e,t,s,n,o),this.rows={left:[],right:[],mid:[]};const g=()=>{const{rows:e}=t.scene(),{pinTop:s,pinBottom:n}=t.row();this.rows={top:s,body:e,bottom:n}};n(t.sceneChanged).subscribe((e=>{e.hasChanges("rows")&&g()})),n(t.rowChanged).subscribe((e=>{(e.hasChanges("pinTop")||e.hasChanges("pinBottom"))&&g()}))}}class ps{static set(e){if(document.body.createTextRange){const t=document.body.createTextRange();t.moveToElementText(e),t.select()}else if(window.getSelection){const t=window.getSelection(),s=document.createRange();s.selectNodeContents(e),t.removeAllRanges(),t.addRange(s)}else ce.error("text.selection","Could not select text in element: Unsupported browser.")}static clear(){if(window.getSelection){window.getSelection().removeAllRanges()}}}class ws{constructor(e){const{model:t,observe:s,disposable:n}=e,o=new gs(e);this.plugin=e,this.render=o,this.columns=e=>o.defaultStrategy.columnList(e),s(t.sceneChanged).subscribe((e=>{e.hasChanges("rows")&&this.tryShowBlankLayer()})),s(t.mouseChanged).subscribe((({state:e})=>{const{code:t,status:s,target:n}=e;n&&"right"===t&&"up"===s&&(this.targetElement=n.element,this.targetElement.classList.add("q-grid-can-select-text"),ps.set(this.targetElement)),this.targetElement&&"down"===s&&(ps.clear(),this.targetElement.classList&&this.targetElement.classList.remove("q-grid-can-select-text"),this.targetElement=null)})),this.tryShowBlankLayer()}tryShowBlankLayer(){ce.info("view.let","invalidate");const{model:e,table:t}=this.plugin,{rows:s}=e.scene();s.length||e.data().rows.length?t.view.hasLayer("blank")&&t.view.removeLayer("blank"):t.view.hasLayer("blank")||t.view.addLayer("blank")}}class fs{constructor(){this.items={}}set(e,t){this.items[e]=t}get(e){const t=this.find(e);if(!t)throw new oe("cache.get",`Entry with key was not found "${e}"`);return t}has(e){return this.items.hasOwnProperty(e)}find(e){const t=this.items;return t.hasOwnProperty(e)?t[e]:null}remove(e){if(!this.items.hasOwnProperty(e))throw new oe("cache.remove",`Entry with key was not found "${e}"`);delete this.items[e]}clear(){this.items={}}}class ys{constructor(){this.resource=new $,this.cache=new fs}}class bs{constructor(e,t){const{model:s,observeReply:n}=t;e.classList.add("q-grid"),n(s.dragChanged).subscribe((t=>{t.hasChanges("isActive")&&(s.drag().isActive?e.classList.add("q-grid-drag"):e.classList.remove("q-grid-drag"))}))}}function vs(e){return xs(e).join("\n")}function xs(e){return Object.keys(e).reduce(((t,s)=>{const n=e[s],o=Object.keys(n).reduce(((e,t)=>(e.push(`\t${t}:${n[t]} !important;`),e)),[]);return t.push(`${s}{\n${o.join("\n")}\n}`),t}),[])}function Cs(e,t){const s=`${e}-${t}`;let n=document.getElementById(s);const o=()=>(n||(n=document.createElement("style"),n.type="text/css",n.id=ks(s),document.getElementsByTagName("head")[0].appendChild(n)),n);return{set:t=>{const s=o(),n=xs(t),r=`#${Es(e)}`;s.innerHTML=n.map((e=>`${r} ${e}`)).join("\n")},remove:()=>{n&&n.parentNode.removeChild(n)}}}function ks(e){return(""+e).replace(/\s|\t|\n|"|'/g,"_")}function Es(e){return C(ks(e))}function $s(e){const t=[`q-grid-the-${ks(e.key)}`,`q-grid-${ks(e.type)}`];e.editor&&t.push(`q-grid-${ks(e.editor)}`),e.viewWidth&&t.push("q-grid-has-view-width"),e.class&&t.push(ks(e.class));const s=" "+t.join(" ");return e=>e.className+=s}function Rs(e){const t=[];e.canEdit&&t.push("q-grid-can-edit"),e.canResize&&t.push("q-grid-can-resize"),e.canSort&&t.push("q-grid-can-sort"),e.canMove&&t.push("q-grid-can-move"),e.canFilter&&t.push("q-grid-can-filter"),e.canHighlight&&t.push("q-grid-can-highlight"),e.widthMode&&t.push(`q-grid-${e.widthMode}`);const s=" "+t.join(" ");return e=>e.className+=s}class Is{constructor(e,t){this.model=e,this.table=t}map(e){const t=this.model.selection();switch(t.unit){case"row":return this.mapFromRows(e);case"column":return this.mapFromColumns(e);case"cell":return this.mapFromCells(e);case"mix":return this.mapFromMix(e);default:throw new oe("cell.selector",`Invalid unit ${t.unit}`)}}mapFromRows(e){const{table:t}=this,s=[],n=t.data.rows();for(let o of e){const e=n.indexOf(o);for(let n of t.body.row(e).cells())s.push(n)}return s}mapFromColumns(e){const{table:t}=this,s=[],n=t.data.columns();for(let o of e){const e=n.findIndex((e=>e===o));s.push(...t.body.column(e).cells())}return s}mapFromCells(e){const{table:t}=this,s=[],n=t.data.rows(),o=t.data.columns();for(let r of e){const e=n.indexOf(r.row),i=o.findIndex((e=>e===r.column));s.push(t.body.cell(e,i))}return s}mapFromMix(e){const t=Array.from(e),s=t.filter((e=>"row"===e.unit)).map((e=>e.item)),n=t.filter((e=>"cell"===e.unit)).map((e=>e.item));return[...this.mapFromRows(s),...this.mapFromCells(n)]}}function Os(e){const t=document.createElement("textarea");t.style.position="fixed",t.style.top=0,t.style.left=0,t.style.width="2em",t.style.height="2em",t.style.padding=0,t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy")}catch(e){throw new oe("clipboard",e.message)}document.body.removeChild(t)}class Fs{constructor(){this.disposes=[]}add(e){kt.notNull(e,"resource");const t=e;if(a(t.finalize))this.disposes.push((()=>t.finalize()));else if(a(t.unsubscribe))this.disposes.push((()=>t.unsubscribe()));else{if(!a(t))throw new oe("disposable","Resource is not a disposable");this.disposes.push(t)}}remove(e){const t=this.disposes.indexOf(e);return t>=0&&(this.disposes.splice(t,1),!0)}finalize(){const e=this.disposes;this.disposes=[];for(const t of e)t()}}class qs{constructor(e){this.off=e,this.closed=!1}unsubscribe(){this.closed||(this.off(),this.off=null,this.closed=!0)}}class Ls{constructor(e,t){this.errorSignal=new te,this.nextSignal=e,this.disposable=t}subscribe(...e){let t=e[0];if(a(t)&&(t={next:e[0],error:e[1],complete:e[2]}),t.error){const e=this.errorSignal.on((e=>t.error(e)));this.disposable.add(e)}if(t.next){const e=this.subscribeEvent((e=>t.next(e)));let s=!1;const n=()=>{s||(s=!0,e(),this.disposable.remove(n),t.complete&&t.complete())};return this.disposable.add(n),new qs(n)}return new qs(M)}subscribeEvent(e){return this.nextSignal.on((t=>{try{e(t)}catch(e){throw this.catchError(e),e}}))}catchError(e){throw this.errorSignal.emit(e),e}toPromise(){return new Promise((e=>{let t=!1;const s=this.subscribe((()=>{e(),t=!0,s&&(s.unsubscribe(),s=null)}));t&&s&&s.unsubscribe()}))}pipe(...e){let t=this;for(let s of e)t=s(t);return t}}class Ss extends Ls{subscribeEvent(e){return this.nextSignal.watch((t=>{try{e(t)}catch(e){this.catchError(e)}}))}}class Ms extends Ls{constructor(){super(new te,new Fs),this.isCompleted=!1}next(e){this.isCompleted||this.nextSignal.emit(e)}error(e){this.isCompleted||this.catchError(e)}complete(){this.isCompleted||(this.isCompleted=!0)}}class Ts extends Ms{constructor(e){super(),this.subscriber=e}subscribe(...e){super.subscribe(...e),this.subscriber(this)}}class js{constructor(e={}){this.execute=T,this.canExecute=T,this.canExecuteCheck=new Ms,this.shortcut="",this.priority=0,this.source="",this.sink=null,Object.assign(this,e)}clone(e={}){const t=new js(this);return Object.assign(t,e),t}}class Ns{constructor(e,t){const{model:s,table:n}=e;this.copy=new js({priority:1,source:"clipboard.let",shortcut:"ctrl+c",canExecute:()=>{const{status:e}=s.edit(),{copy:t}=s.clipboard();return"view"===e&&t.canExecute()},execute:()=>{const{cell:e}=s.navigation();if(e){const{copy:t}=s.clipboard();if(!1!==t.execute()){Os(ye(e.column)(e.row)),n.view.focus()}}return!0}}),t.register([this.copy])}}class As{constructor(){this.copy=new js}}function Ps(t){const s=e({equals:(e,t)=>e===t,update:(t,s)=>(e(t,s),t),remove:(e,t,s)=>(t.splice(s,1),e),insert:(e,t)=>(t.push(e),e)},t);return(e,t,n)=>{const o=e.slice(),r=t.slice();let i=0,c=0;n=n||e;for(let e=0,t=o.length;e<t;e++){const t=o[e];let l=!1;for(let o=0,c=r.length;o<c;o++){const c=r[o];if(s.equals(t,c,e,o)){s.update(t,c,n,n.indexOf(t)),i++,l=!0,r.splice(o,1);break}}l||(s.remove(t,n,n.indexOf(t)),c++)}const l=r.length;for(let e=0;e<l;e++)s.insert(r[e],n);return s.sort&&e.sort(s.sort(e,t)),{updated:i,removed:c,inserted:l}}}function Vs(t,s,n=!1){let o;o=n?(e,t)=>m(t)||null===t?e:t:(e,t)=>m(t)||null===t||null!==e?e:t;const r=Ps({equals:(e,t)=>e.key===t.key,update:(t,s)=>e(t,s,o),insert:(e,t)=>t.push(e),remove:M});return r(t,s)}function Ds(e){return e.some((e=>e.inserted||e.update))}function zs(e){const{data:t}=e,s=_t(e);return()=>{const{rows:n}=t(),o=e.columnList().columns,r=[],{generation:i,typeDetection:c}=e.columnList();if(i){let e={rows:n,columnFactory:s,deep:!1,cohort:!1,typeDetection:c};switch(i){case"shallow":break;case"deep":e.deep=!0;break;case"cohort":e.deep=!0,e.cohort=!0;break;default:throw new oe("column.list.generate",`Invalid generation mode "${i}"`)}r.push(...Bs(e))}const l=Array.from(t().columns);let a=[];return r.length&&a.push(Vs(l,r,!1)),o.length&&a.push(Vs(l,o,!0)),{columns:l,statistics:a,hasChanges:Ds(a)}}}function Bs(t){const s=e({deep:!0,cohort:!1,rows:[],columnFactory:()=>new Vt,title:w,testNumber:10,typeDetection:"inference"},t);return s.rows.length?Hs(s.rows[0],[],{columnFactory:s.columnFactory,deep:s.deep,cohort:s.cohort,title:s.title,typeDetection:s.typeDetection,testRows:s.rows.slice(0,s.testNumber)}):[]}function Hs(e,t,s){const{columnFactory:n,deep:o,cohort:r,title:i,testRows:c,typeDetection:l}=s;return Object.getOwnPropertyNames(e).reduce(((a,u)=>{const h=[...t,u],d=ue(h),m=h.join("."),g=e[u],p="raw"===l?Ve(c.map(d)):ze(c.map(d));switch(p){case"array":{const t=n(p).model;if(t.key=m,t.title=i(m,e,t.length),t.value=d,t.source="generation",g.length)switch(t.itemType=De(g[0]),t.itemType){case"date":t.itemFormat=n("date").model.format;break;case"datetime":t.itemFormat=n("datetime").model.format}a.push(t);break}case"collection":break;case"object":if(o){const t=Hs(g,h,s);if(r){const s=n("cohort").model;s.key=m,s.title=i(m,e,s.length),s.value=d,s.source="generation",s.children.push(...t),a.push(s)}else a.push(...t)}break;default:{const t=n(p).model;t.key=m,t.title=i(m,e,t.length),t.value=d,t.source="generation",a.push(t);break}}return a}),[])}class Ws{constructor(e,t,s){this.model=e,this.canCopy=t,this.parseFactory=s}generateKey(e){return m(e.editor)?m(e.type)?"$default":`$default.${e.type}`:`$default.${e.editor}`}copy(e,t){const s=this.canCopy,n=this.parseFactory;Object.keys(t).filter((n=>s(n,t,e))).forEach((s=>{const o=t[s],r=ue([s]),i=r(e),c=De(i);let l=o;if(null!==i&&!m(i)){const e=n(c)(o,i);null!==e&&(l=e)}r(e,l)}))}add(e){const{columnList:t,scene:s,data:n}=this.model,o=t().columns.concat([e]);t({columns:o},{source:"column.list.host",behavior:"core"}),"idle"!==s().status&&n({columns:Array.from(n().columns)},{source:"column.list.host"})}register(e){const{columnList:s}=this.model,n=t(s().reference);n[e.type||"$default"]=e,s({reference:n},{source:"column.list.host",behavior:"core"})}extract(e,t){const{model:s}=this,n=_t(s);let o=ls(s.columnList().line,e);if(o)return n(t,o);o=n(t||"text").model,o.key=e,o.source="template";const r=ls(s.data().columns,e);return r&&this.copy(o,r),o}delete(e){const{columnList:t,data:s}=this.model,n=t().columns,o=as(n,e);if(o>=0){const e=Array.from(n);e.splice(o,1),t({columns:e},{source:"column.list.host",behavior:"core"})}const r=Array.from(s().columns),i=rs(r,e);i&&(i.columns.splice(i.index,1),s({columns:r},{source:"column.list.host"}))}}function Us(e,t,s=null,n=null){for(let o=0,r=e.length;o<r;o++){const r=e[o],i=t(r,s,n,o);Us(r.children,t,i,r)}return s}function _s(e,t,s=null){const{children:n}=e;e=Ys(e);let o=!1;for(let s=0,r=n.length;s<r;s++){o=_s(n[s],t,e)||o}return s?!(!o&&!t(e))&&(s.children.push(e),!0):e}function Ks(e,t=[]){const{children:s}=e;if(!s.length)return t.push(e),t;for(let e=0,n=s.length;e<n;e++){Ks(s[e],t)}return t}function Gs(e,t,s=null,n=-1,o=[]){if(t(e))return{node:e,parent:s,index:n,path:o};(o=o.slice()).push(e);const{children:r}=e;for(let s=0,n=r.length;s<n;s++){const n=r[s],i=find(n,t,e,s,o);if(i)return i}return null}function Js(e){const t=new le(e.key,e.level,e.type);return t.rows=Array.from(e.rows),t.children=Array.from(e.children),t.state=s(e.state),t.source=e.source,t.value=e.value,t}function Ys(e){const t=new le(e.key,e.level,e.type);return t.value=e.value,t.source=e.source,t.state.expand=e.state.expand,t}function Xs(e){if(0===e.length)throw new oe("node.service","Line have no nodes");const t=Ys(e[0]),s=[t];for(let t=1,n=e.length;t<n;t++){const n=e[t];let o=s[s.length-1];for(;n.level<=o.level;)s.pop(),o=s[s.length-1];const r=Ys(n);r.level=o.level+1,o.children.push(r),s.push(r)}return t}function Zs(e){const t=e.columnList().columns.map((e=>e.key));return(e,s)=>{const{length:n}=e;s=Object.assign({list:e=>"data"===e.category||"cohort"===e.category?.1:.3,index:()=>.2,view:e=>n+("data"!==e.category&&"cohort"!==e.category?.1:.3),template:()=>n+.4},s);const o=e.map((e=>e.key)),r=function(e){return(t,s)=>{const n=function(e,t,s){const n=Qs(s),o=Qs(t),r={},i=t=>{const s=t.key;if(r.hasOwnProperty(s))return r[s];const i=[t.index+e.index(t),n(s)+e.view(t),o(s)+e.template(t)].filter((e=>e>=0)),c=i.length?i[0]:-1;return r[s]=c,c};return(e,t)=>{const s=i(e),n=i(t);return-1===n?-1:-1===s?1:s-n}}(e,t,s);return e=>{const t=Array.from(e);return t.sort(n),t.map((e=>e.key))}}}(s)(t,o),i=r(e.filter((e=>"left"===e.pin))),c=r(e.filter((e=>"mid"===e.pin))),l=r(e.filter((e=>"right"===e.pin)));return i.concat(c).concat(l)}}function Qs(e){const t=e.reduce(((e,t,s)=>(e.set(t,s),e)),new Map);return e=>t.has(e)?t.get(e):-1}function en(e,t,s){const n=function(e,t){const s={line:[],map:new Map};return Us([e],(e=>{s.line.push(e),s.map.set(e.key.model.key,e.key);const n=e.children.map((e=>e.key.model)),o=t(n);let r=0;const i=o.reduce(((e,t)=>(e[t]=r++,e)),{});e.children.sort(((e,t)=>i[e.key.model.key]-i[t.key.model.key]))})),s}(e,s),o=function(e,t){const s={line:[],set:new Set};return Us([e],(e=>{const{key:n}=e.key.model,o=t.map.get(n);if(o){const t=Ys(e);t.key=o,s.line.push(t),s.set.add(n)}})),s}(t,n),r=tn(n,o),i=function(e,t){const s=tn(e,t),{line:n}=t;return(e,t)=>{const o=new Set(t.children.map((e=>e.key.model.key))),r=n.findIndex((e=>o.has(e.key.model.key)));if(r<0)return void s(e,t);const i=Ys(t),{level:c}=n[r];i.level=c,n.splice(r,0,i);for(let e=r+1,t=n.length;e<t;e++){const t=n[e];if(t.level!==c)break;o.has(t.key.model.key)&&(t.level=c+1)}}}(n,o),c=n.line[0];o.set.has(c.key.model.key)||(o.line.unshift(Ys(c)),o.line.forEach((e=>e.level++)));for(let e=1,t=n.line.length;e<t;e++){const t=n.line[e],{model:s}=t.key;if(o.set.has(s.key))continue;const c=n.line[e-1];"cohort"===s.type?i(c,t):r(c,t,e)}return Xs(o.line)}function tn(e,t){const{line:s}=t;return(n,o,r)=>{let i=s.findIndex((e=>e.key.model.key===n.key.model.key));const c=Ys(o);c.level=o.level,!function(e,t,s){const{line:n}=e;let o;for(;o=n[++s];)if(t.set.has(o.key.model.key))return!1;return!0}(e,t,r)?s.splice(i+1,0,c):s.push(c)}}class sn{constructor(){this.generation=null,this.typeDetection="inference";const e=new Me;e.key="$root",this.index=new le(new Te(e),0),this.columns=[],this.reference={},this.line=[]}}Ee.register("filter-row-cell",((e,t)=>({model:e.for,resource:t.key})));class nn extends $e{constructor(e){super(),Object.assign(this,e),this.key=`$filter.row.${e.key}`,this.type="filter-row",this.category="control",this.canResize=!1,this.canSort=!1,this.canMove=!1,this.model=e}}class on extends Re{constructor(e){super(new nn(e))}}class rn{constructor(e){this.name=e}}function cn(e){return rn(e)}function ln(){return rn("some name")}class an{constructor(e){this.manager=e}filter(e){return this.manager.filter(e)}invoke(e,t,s){return this.manager.invoke(e,t,s)}}class un extends Y{constructor(e,t){super(e),this.table=t}filter(e,t){return"editor"===t||this.isViewActive()?super.filter(e,t):[]}isViewActive(){return this.table.view.isFocused()}}function hn(e,t,s){const{model:n}=t;!function(e,t){const s={source:"data.pipe",behavior:"core"};e.data({rows:t},s)}(n,e),function(e){const t=zs(e),s=_t(e),{hasChanges:n,columns:o}=t(),r=o.map((e=>s(e.type,e).model));if(n){const t={source:"data.pipe",behavior:"core"};e.data({columns:r},t)}}(n),n.pipe({effect:Object.assign({},n.pipe().effect,{data:e})},{source:"data.pipe",behavior:"core"}),s(e)}function dn(e,t,s){kt.notNull(e,"rows");const{model:n}=t;let o=e;if(e.length){const{match:s,custom:r}=n.filter(),i=s(t);let c;if(i!==T&&r!==T?c=e=>i(e)&&r(e):i!==T?c=e=>i(e):r!==T&&(c=e=>r(e)),c){o=[];for(let t=0,s=e.length;t<s;t++){const s=e[t];c(s)&&o.push(s)}}}n.pipe({effect:Object.assign({},n.pipe().effect,{filter:o})},{source:"filter.pipe",behavior:"core"}),s(o)}function mn(e,t,s){kt.notNull(e,"memo");const{model:n}=t;if(e.hasOwnProperty("nodes")&&e.nodes.length){const{flattenFactory:t}=n.group(),o=gn(n,e.nodes),r=t(n);return e.rows=r(o),void s(e)}if(e.hasOwnProperty("rows")){const t=gn(n,e.rows);return e.rows=t,void s(e)}s(gn(n,e))}function gn(e,t){const{pinTop:s,pinBottom:n}=e.row(),{mode:o}=e.scroll();let{size:r,current:i}=e.pagination();const c=new Set([...s,...n]);c.size&&(t=t.filter((e=>!c.has(e))));const l=t.length,a=Math.max(0,Math.floor((l-1)/r));i=Math.min(a,i);const u=i*r;return e.pagination({count:l,current:i},{source:"pagination.pipe",behavior:"core"}),"virtual"===o?t:t.slice(u,u+r)}function pn(e){const{sort:t}=e;return s=>{const{trigger:n}=t();if(n.indexOf("reorder")>=0){let t=0;const n={};Us(e.columnList().index.children,(e=>{const{key:s}=e.key.model;n[s]=t++})),s.sort(((e,t)=>n[wn(e)]-n[wn(t)]))}return s}}function wn(e){let t;if(d(e)){const s=e.split(/[+-]/);t=s[1]||s[0]}else t=Object.keys(e)[0];if(!t)throw new oe("sort.service",`Key is not defined in "${e}"`);return t}function fn(e){if(d(e)){return{"-":"desc","+":"asc"}[e[0]]||"asc"}return e[wn(e)]}function yn(e){return e.reduce(((e,t)=>(e[wn(t)]=fn(t),e)),{})}function bn(e,t){return e.map(wn).findIndex((e=>e===t))}function vn(e,t,s){kt.notNull(e,"rows");const{model:n}=t;let o=e;if(e.length){const{by:s}=n.sort();if(s.length){const r=n.columnList().line,i=[],c=[];for(let e=0,n=s.length;e<n;e++){const n=s[e],o=wn(n),l=fn(n),a=ls(r,o);if(!a)throw new oe("sort.pipe",`Column "${o}" is not found`);const u=t.getValueFactory(a),h=Ae(a.type,a.editor),d=a.compare;i.push((e=>{const t=u(e),s=h(t);return null===s?t:s})),c.push("asc"===l?d:(e,t)=>-d(e,t))}o=D(e,i,c)}}n.pipe({effect:Object.assign({},n.pipe().effect,{sort:o})},{source:"sort.pipe",behavior:"core"}),s(o)}function xn(e,t,s){kt.notNull(e,"rows");const{model:n}=t;n.pipe({effect:Object.assign({},n.pipe().effect,{memo:e})},{source:"memo.pipe",behavior:"core"}),s({rows:e,pivot:{head:new le("$root",0),rows:[]},nodes:[]})}function Cn(e,t,s,n=0){if(0===t.length)return()=>[];const o=t[0];if(!e.hasOwnProperty(o))throw new oe("node.build",`can't find column "${o}"`);const r=pe(e[o]);return(i,c=(e=>e))=>{const l=[],a=[],u={};for(let e=0,t=i.length;e<t;e++){const t=i[e],s=c(e),h=r(t);if(u.hasOwnProperty(h)){const e=u[h];e.node.rows.push(s),e.rows.push(t),l.push(h)}else{const e=new le(h,n);e.source=o,e.rows.push(s),l.push(h),a.push(e),u[h]={node:e,rows:[t]}}}const h=t.slice(1);if(h.length){const t=Cn(e,h,s,n+1);for(let e=0,s=l.length;e<s;e++){const s=u[l[e]],n=s.node,o=n.rows;n.children=t(s.rows,(e=>o[e]))}}return a}}function kn(e,t,s){kt.notNull(e,"memo");const{model:n}=t,{rows:o,nodes:r}=e;if(o.length){const{rows:s}=n.data(),{by:r}=n.group(),i=Cn(is(n.columnList().line),r,t.valueFactory);e.nodes=i(o,(e=>{const t=o[e],n=s.indexOf(t);return n<0?e:n}))}n.pipe({effect:Object.assign({},n.pipe().effect,{group:r})},{source:"group.pipe",behavior:"core"}),s(e)}class En{constructor(e){this.isRoot=!arguments.length,this.current=this.schema=e||{}}branch(){return new En(this.current)}cursor(e){const t=this.schema;this.current=t.hasOwnProperty(e)?t[e]:t[e]={}}compile(e){return this.isRoot?{schema:this.schema,data:e}:e}}function $n(e){return t=>(e.cursor(t),t=>Rn(t,e.branch()))}function Rn(e,t){const s=$n(t=t||new En),n=t=>e.selector(t).reduce(((n,o)=>{const r=e.name(o);return n[r]=e.value(o,t,s(r)),n}),e.factory(t));return e=>t.compile(t.isRoot?e.map(n):n(e))}function In(e,t){const s=Object.keys(e).map((s=>{const n=e[s];return t&&t.hasOwnProperty(s)?In(n,t[s]):In(n)}));return s.length?o(s,!0):[t]}function On(e,t){return Object.keys(e).sort(t).reduce(((s,n)=>(s[n]=On(e[n],t),s)),{})}function Fn(e,t){if(e.schema&&e.data){const s=On(e.schema,t),n=e.data.map((e=>function(e,t,s){return Object.keys(t).filter((t=>!e.hasOwnProperty(t))).reduce(((e,s)=>(e[s]=t[s],e)),s)}(s,e,In(s,e)))),o=function(e){return function e(t,s){return t&&Object.keys(t).forEach((n=>{const o=new le(n,s.level+1);return s.children.push(o),e(t[n],o),o})),s}(e,new le("$root",0))}(s);return{head:o,rows:n}}return{head:new le("$root",0),rows:[]}}function qn(e,t,s){let n=null;if(t.length){const o=function(e,t){return function s(n,o,r=0){const i=o[0],c=e[i];if(!c)throw new oe("pivot.build",`Invalid key "${i}"`);const l=t(c);return n({factory:()=>({}),selector:e=>[l(e)],name:N,value:(e,t,n)=>{const i=o.slice(1);return!i.length||s(n,i,r+1)(t)}})}}(e,s);n=o(Rn,t)}return e=>{if(n){return Fn(n(e))}return{head:new le("$root",0),rows:[]}}}function Ln(e,t,s){kt.notNull(e,"memo");const{model:n}=t;if(e.rows.length){const{getValueFactory:s}=t,{line:o}=n.columnList(),{by:r}=n.pivot(),i=qn(is(o),r,s);e.pivot=i(e.rows,r)}n.pipe({effect:Object.assign({},n.pipe().effect,{pivot:e.pivot})},{source:"pivot.pipe",behavior:"core"}),s(e)}function Sn(e,t,s){kt.notNull(e,"root");const{model:n}=t,o=function(e,t){const s=new Set(e.group().by),n=new Set(e.pivot().by);function o(e,t){const{children:r}=e;for(let e=0,i=r.length;e<i;e++){const i=r[e],c=i.key,{isVisible:l,key:a}=c.model;if(l&&!s.has(a)&&!n.has(a)){const e=new le(i.key,i.level);t.children.push(e),o(i,e)}}return t}return o(t,new le(t.key,t.level))}(n,e);s({columns:ts(o),index:e})}function Mn(e,t,s){kt.notNull(e,"memo");const{model:n}=t,{pivot:o,nodes:r}=e,{head:i}=o,c=_t(n),l=new le(c("cohort",{key:"$root"}),0),a=function(e){const t=zs(e),s=_t(e),{hasChanges:n,columns:o}=t();n&&e.data({columns:o},{source:"column.pipe",behavior:"core"});function r(e,t){for(let n of t){const t=s(n.type,n),o=new le(t,e.level+1);e.children.push(o),r(o,t.model.children)}}return e=>r(e,o)}(n),u=function(e){const t=e.columnList().line,s=e.selection(),n=t.find((e=>"select"===e.type));if(!t.find((e=>"row-indicator"===e.type))&&"mix"===s.unit){const t=_t(e);return e=>{const s=t("row-indicator");if(s.model.source="generation",s.model.isVisible)return e.children.unshift(new le(s,e.level+1)),s}}if(!n&&"row"===s.unit){const t=_t(e);return s=>{const n=t("select");if(n.model.key=`$select-${e.selection().mode}`,n.model.source="generation",n.model.isVisible)return s.children.unshift(new le(n,s.level+1)),n}}return M}(n),h=function(e,t){const s=e.columnList().line.find((e=>"group"===e.type)),{by:n,mode:o}=e.group(),r=_t(e);if(!s&&(t.length||n.length))switch(o){case"nest":return e=>{const t=r("group");if(t.model.source="generation",t.model.isVisible)return e.children.unshift(new le(t,e.level+1)),t};case"rowspan":case"flat":return e=>{const t=n.map((t=>{const s=r("group");return s.model.source="generation",s.model.key=`$group-${t}`,s.model.title=t,s.model.by=t,new le(s,e.level+1)})).filter((e=>e.key.model.isVisible));e.children.splice(0,0,...t)}}return M}(n,r),d=function(e){const t=e.columnList().line.find((e=>"row-expand"===e.type));if("details"===e.row().unit&&!t){const t=_t(e);return e=>{const s=t("row-expand");if(s.model.source="generation",s.model.isVisible)return e.children.unshift(new le(s,e.level+1)),s}}return M}(n),m=function(e){const t=e.columnList().line.find((e=>"row-indicator"===e.type)),{canMove:s,canResize:n}=e.row();if((s||n)&&!t){const t=_t(e);return e=>{const s=t("row-indicator");if(s.model.source="generation",s.model.isVisible)return e.children.unshift(new le(s,e.level+1)),s}}return M}(n),g=function(e){const t=_t(e);return function e(s,n){const{children:o}=n;for(let n=0,r=o.length;n<r;n++){const r=o[n],i=t("pivot"),c=i.model;c.title=r.key,c.key=`$pivot-${r.key}`;const l=new le(i,s.level+1);s.children.push(l),e(l,r)}}}(n),p=function(e){const t=_t(e);return e=>{const s=t("pad");s.model.key="$pad";const n=e.children.findIndex((e=>"right"===e.key.model.pin)),o=new le(s,e.level+1);return n>=0?e.children.splice(n,0,o):e.children.push(o),s}}(n);a(l),d(l),h(l),u(l),m(l),g(l,i);const{columnList:w}=n,f=Zs(n),y=en(l,w().index,f);p(y),Sn(y,t,(({columns:t,index:n})=>{e.columns=t,w({index:n},{behavior:"core",source:"column.pipe"}),s(e)}))}function Tn(e,t,s){const{model:n}=t,{apply:o}=n.animation();let{length:r}=o;if(r){const n=()=>{r--,0===r&&s(e)};o.forEach((s=>{s(e,t,n)}))}else s(e)}class jn{constructor(e){this.model=e}rows(e){const{nodes:t,rows:s}=e;if(t.length&&!(s.length&&s[0]instanceof le)){const{flattenFactory:e}=this.model.group();return e(this.model)(t)}return s}columnRows(e){return e}columnLine(e){return us(e)}columnArea(e){const t=us(e),s={left:[],right:[],mid:[]};for(let e=0,n=t.length;e<n;e++){const n=t[e],{pin:o}=n.model;let r=s[o];if(!r)throw new oe("scene",`Unsupported pin ${o}`);r.push(n)}return s}}function Nn(e){const{index:t}=e.rowList();if(!t.size)return N;const{rowId:s}=e.data();return e=>{let n=0;const o=new Map,r=e.filter(((e,n)=>{const r=s(n,e),i=t.get(r);return!i&&0!==i||(o.set(i,e),!1)})).reduce(((e,t)=>{let s;for(;s=o.get(n);)o.delete(n),e.push(s),n++;return e.push(t),n++,e}),[]);if(o.size){const e=Array.from(o.entries());return e.sort(((e,t)=>e[0]-t[0])),r.concat(e.map((e=>e[1])))}return r}}function An(e,t,s){kt.notNull(e,"memo");const n={source:t.source||"view.pipe",behavior:"core"},{model:o}=t,r=new jn(o);let i=r.rows(e);const{columns:c,nodes:l,pivot:a}=e,u=r.columnLine(c);if(!o.sort().by.length){i=Nn(o)(i)}o.view({rows:i,columns:u.map((e=>e.model)),nodes:l,pivot:a},n),s(e)}function Pn(e,t,s){kt.notNull(e,"memo");const n={source:t.source||"scene.pipe",behavior:"core"},{model:o}=t,r=new jn(o);let i=r.rows(e);const{columns:c}=e,l=r.columnLine(c);if(!o.sort().by.length){i=Nn(o)(i)}o.scene({rows:i,column:{rows:r.columnRows(e.columns),area:r.columnArea(e.columns),line:l}},n),s(e)}class Vn{static get data(){return hn}static get filter(){return dn}static get pagination(){return mn}static get sort(){return vn}static get memo(){return xn}static get group(){return kn}static get pivot(){return Ln}static get column(){return Mn}static get columnIndex(){return Sn}static get animation(){return Tn}static get view(){return An}static get scene(){return Pn}}const Dn=[(e,t,s)=>{const{view:n}=t.model,{rows:o,pivot:r,nodes:i}=n();s({rows:o,pivot:r,nodes:i})},Vn.column,(e,t,s)=>{const{model:n}=t,o=new jn(n),r=o.columnLine(e.columns),i={source:t.source||"column.pipe.unit",behavior:"core"};n.view({columns:r.map((e=>e.model))},i),t.model.scene({column:{rows:o.columnRows(e.columns),area:o.columnArea(e.columns),line:r}},i),s(e)}];Dn.why="redraw";const zn=[(e,t,s)=>{const{index:n}=t.model.columnList();s(n)},Vn.columnIndex,Vn.animation,(e,t,s)=>{const{model:n}=t,o=new jn(n),r=o.columnLine(e.columns),i={source:t.source||"column.pipe.unit",behavior:"core"};n.view({columns:r.map((e=>e.model))},i),n.scene({column:{rows:o.columnRows(e.columns),area:o.columnArea(e.columns),line:r}},i),s(e)}];zn.why="redraw";const Bn=[Vn.data,Vn.filter,Vn.sort,Vn.memo,Vn.group,Vn.pivot,Vn.column,Vn.view,Vn.pagination,Vn.animation,Vn.scene];Bn.why="refresh";const Hn=[(e,t,s)=>{const{model:n}=t,{nodes:o,rows:r}=n.view();s({nodes:o,rows:r})},Vn.pagination,(e,t,s)=>{const{model:n}=t,o={source:t.source||"group.pipe.unit",behavior:"core"},{rows:r}=e;n.scene({rows:r},o),s(e)}];Hn.why="redraw";class Wn{constructor(e){this.expand=e}}function Un(e,t){const{rows:s}=e.scene(),{status:n}=e.row(),{line:o}=e.scene().column,r="all"===t,i=o.find((e=>"row-expand"===e.model.type)),c=i?i.columnIndex:0,l=[],a=_t(e);for(let e=0,t=s.length;e<t;e++){const t=s[e];l.push(t);const o=s[e+1],i=o instanceof ae?o:null,u=n.get(t)||r&&new Wn(!0);if(u instanceof Wn&&u.expand)if(i)l.push(i),e++;else{const e=a("row-details");e.columnIndex=c,l.push(new ae(t,e))}else i&&e++}return l}function _n(e,t,s){switch(s){case"all":t=new Map(t.entries()),e.forEach((e=>{t.has(e)||t.set(e,new Wn(!0))}));break;case"single":t=new Map(Array.from(t.entries()).filter((t=>{const[s,n]=t;return e.indexOf(s)>=0||!(n instanceof Wn)})));break;case"multiple":t=new Map(t.entries());break;default:throw new oe("row.details.service",`Invalid mode ${s}`)}return t}function Kn(e,t,s="single"){return t=_n(e,t,s),"all"!==s&&e.forEach((e=>{const s=t.get(e);s?s.expand=!s.expand:t.set(e,new Wn(!0))})),t}const Gn=[(e,t,s)=>{const n={source:t.source||"row.details.pipe.unit",behavior:"core"},{model:o}=t,{mode:r}=o.row(),i=Un(o,r);o.view({rows:i},n),o.scene({rows:i},n),s(i)}];Gn.why="redraw";const Jn=[Vn.data,Vn.memo,Vn.column,Vn.view,Vn.scene];Jn.why="refresh";const Yn=[Vn.data,Vn.memo,Vn.column,Vn.view,Vn.pagination,Vn.animation,Vn.scene];Yn.why="redraw";const Xn=[(e,t,s)=>{const{model:n}=t,{rows:o,pivot:r,nodes:i}=n.view();s({rows:Nn(n)(o),pivot:r,nodes:i})},Vn.animation,(e,t,s)=>{const{model:n}=t,{rows:o}=e,r={source:t.source||"row.pipe.unit",behavior:"core"};n.view({rows:o},r),n.scene({rows:o},r),s(o)}];Xn.why="redraw";class Zn{static get default(){return Bn}static get view(){return Jn}static get scene(){return Yn}static get column(){return Dn}static get columnIndex(){return zn}static get rowDetails(){return Gn}static get group(){return Hn}static get row(){return Xn}}class Qn{constructor(){this.rows=[],this.columns=[],this.pipe=Zn.default,this.rowId=(e,t)=>t,this.columnId=(e,t)=>t.key}}class eo{constructor(e){this.elements=e}getBoundingClientRect(){const e=this.elements.map((e=>e.getBoundingClientRect())),t=p(e.map((e=>e.top))),s=p(e.map((e=>e.left))),n=g(e.map((e=>e.bottom))),o=g(e.map((e=>e.right)));return{height:n-t,width:o-s,top:t,left:s,right:o,bottom:n}}addClass(e){this.elements.forEach((t=>t.classList.add(ks(e))))}removeClass(e){this.elements.forEach((t=>t.classList.remove(ks(e))))}hasClass(e){return this.elements.some((t=>t.classList.contains(ks(e))))}get clientWidth(){return g(this.elements.map((e=>e.clientWidth)))}get clientHeight(){return g(this.elements.map((e=>e.clientHeight)))}get offsetWidth(){return g(this.elements.map((e=>e.offsetWidth)))}get offsetHeight(){return g(this.elements.map((e=>e.offsetHeight)))}get classList(){return{add:e=>this.addClass(e),remove:e=>this.removeClass(e),contains:e=>this.hasClass(e)}}}class to{constructor(e){this.elements=e}get index(){const e=this.elements[0];return kt.notNull(e,"tr"),e.index}get model(){const e=this.elements[0];return kt.notNull(e,"tr"),e&&e.model}get element(){const{elements:e}=this;if(e.length>1)return new eo(e.map((e=>e.element)));const t=this.elements[0];return kt.notNull(t,"tr"),t.element}}class so{constructor(){this.rows=new Set,this.cells=new Set,this.elements=new Map,this.rowContainer=new Map}findModel(e){return this.elements.get(e)}hasModel(e){return this.elements.has(e)}getRowElements(){return this.rowContainer.values()}getCellElements(){return this.cells}addRow(e){const{rowContainer:t}=this,{model:s,element:n}=e;this.rows.add(e),this.elements.set(n,e);const o=t.get(s);o?o.elements.push(e):t.set(s,new to([e]))}addCell(e){this.cells.add(e),this.elements.set(e.element,e)}deleteRow(e){const{rowContainer:t}=this,{model:s,element:n}=e;this.rows.delete(e),this.elements.delete(n);const o=t.get(s);if(o){const{elements:e}=o,r=e.indexOf(n);r>=0&&(e.splice(r,1),n.length||t.delete(s))}}deleteCell(e){this.cells.delete(e),this.elements.delete(e.element)}}class no{constructor(){}add(){}remove(){}}const oo=Object.freeze({left:0,right:0,top:0,bottom:0,width:0,height:0});class ro{constructor(){this.classList=new no}getBoundingClientRect(){return oo}get clientWidth(){return 0}get clientHeight(){return 0}get offsetWidth(){return 0}get offsetHeight(){return 0}}const io=new ro;class co{constructor(){}rect(){return this.getElement().getBoundingClientRect()}addClass(e){this.addClassCore(e)}removeClass(e){this.removeClassCore(e)}hasClass(e){return this.hasClassCore(e)}width(){return this.getElement().clientWidth}height(){return this.getElement().clientHeight}getElement(){return this.getElementCore()||io}addClassCore(e){this.getElement().classList.add(ks(e))}removeClassCore(e){this.getElement().classList.remove(ks(e))}hasClassCore(e){return this.getElement().classList.contains(ks(e))}getElementCore(){return null}}class lo extends co{constructor(e){super(),this.element=e}getElementCore(){return this.element}}class ao{constructor(e){this.tr=e,this.index=e.index}get model(){if(!ao.equals(this,this.tr))throw new oe("tr","Internal model doesn't match container");return this.tr.model}get element(){if(!ao.equals(this,this.tr))throw new oe("tr","Internal model doesn't match container");return this.tr.element}static equals(e,t){return e===t||!(!e||!t)&&e.index===t.index}}class uo extends lo{constructor(e,t,s=null){super(s),this.box=e,this.index=t}model(){const e=this.box.context.bag.findModel(this.getKeyElementCore());return e?new ao(e):null}cells(){return this.box.rowCellsCore(this.index)}cell(e){return this.box.cellCore(this.index,e)}getKeyElementCore(){const e=super.getElement();return e.elements?e.elements[0]:e}}class ho{constructor(e,t){this.box=e,this.index=t}model(){const{columns:e}=this.box.model.view();return e[this.index]||null}cells(){return this.box.columnCellsCore(this.index)}cell(e){return this.box.cell(e,this.index)}addClass(e){const t=this.cells(),s=t.length;let n=0;for(;n<s;){t[n++].addClass(e)}}removeClass(e){const t=this.cells(),s=t.length;let n=0;for(;n<s;){t[n++].removeClass(e)}}}class mo{constructor(e){this.td=e,this.rowIndex=e.rowIndex,this.columnIndex=e.columnIndex}get row(){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");return this.td.row}get column(){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");return this.td.column}get value(){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");return this.td.value}set value(e){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");this.td.value=e}get label(){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");return this.td.label}get element(){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");return this.td.element}set label(e){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");this.td.label=e}mode(e){if(!mo.equals(this,this.td))throw new oe("td","Internal model doesn't match container");this.td.mode(e)}static equals(e,t){return e===t||!(!e||!t)&&(e.rowIndex===t.rowIndex&&e.columnIndex===t.columnIndex)}}class go extends lo{constructor(e,t,s,n=null){super(n),this.context=e,this.rowIndex=t,this.columnIndex=s}model(){return this.modelCore()}modelCore(){const e=this.context.bag.findModel(this.getElement());return e?new mo(e):null}}class po{constructor(e){this.isDataRow=e}build(e){const t=e.rows,s=this.isDataRow,n=[],o=[];let r=0;for(let e=0,i=t.length;e<i;e++){const i=t[e];if(!s(i))continue;const c=o.length>r?o[r]:o[r]=[0],l=i.cells;for(let e=0,t=l.length;e<t;e++){const t=l[e],{rowSpan:s,colSpan:i}=t,a=c[0],u=a+i;for(let e=0;e<s;e++){const s=r+e,c=n.length>s?n[s]:n[s]=[];for(let e=0;e<i;e++){c[a+e]=t}const l=o.length>s?o[s]:o[s]=[0],h=H(l,a);if(c[u])l.splice(h,1);else{const e=l[h];l.splice(h,c[e]?1:0,u)}}}r++}return n}assertFlatness(e){if(e.length){const t=e.length,s=e[0].length;for(let n=1;n<t;n++)if(e[n].length!==s)throw new oe("matrix",`Matrix is not flat, expect width ${s}, actual ${e[n].length}`)}}}class wo{constructor(e,t,s){this.matrix=e,this.bag=t,this.factory=s}columnCount(e){const t=this.matrix[e];return t?new Set(t).size:0}columnCells(e){const{factory:t,matrix:s}=this,n=[],o=new Set;for(let r=0,i=s.length;r<i;r++){const i=s[r];if(i.length>e){const s=i[e];o.has(s)||(o.add(s),n.push(t.cell(s,r,e)))}}return n}rowCount(e){const{matrix:t}=this,s=new Set;for(let n=0,o=t.length;n<o;n++){const o=t[n];if(o.length>e){const t=o[e];s.add(t)}}return s.size}rows(e){const{matrix:t,factory:s,bag:n}=this,o=new Set,r=[];if(m(e)){const e=n.getRowElements();for(let t of e)r.push(s.row(t.element,t.index));r.sort(((e,t)=>e.index-t.index))}else for(let n=0,i=t.length;n<i;n++){const i=t[n];if(i.length>e){const t=i[e].parentElement;o.has(t)||(o.add(t),r.push(s.row(t,n)))}}return r}rowCells(e){const{matrix:t}=this,s=t[e],n=[];if(s){const t=new Set,o=this.factory;for(let r=0,i=s.length;r<i;r++){const i=s[r];t.has(i)||(t.add(i),n.push(o.cell(i,e,r)))}}return n}row(e,t){const{factory:s}=this;if(!m(t)){const n=this.td(e,t);return s.row(n?n.parentElement:new ro,e)}const n=this.matrix[e];if(n){const t=new Set;for(let e of n)t.add(e.parentElement);const o=Array.from(t);return s.row(o.length>1?new eo(o):o[0],e)}return s.row(new ro,e)}cell(e,t){const s=this.td(e,t);return this.factory.cell(s||new ro,e,t)}td(e,t){const s=this.matrix[e];if(s){const e=s[t];if(e)return e}return null}}class fo{constructor(e,t){this.buildSelectors=e,this.factory=t}columnCount(e){const t=this.buildSelectors({row:e});return t.length?f(t,(e=>e.invoke(((e,t)=>e.columnCount(t))))):0}columnCells(e){const t=this.buildSelectors({column:e}),s=[];for(let e=0,n=t.length;e<n;e++){const n=t[e].invoke(((e,t)=>e.columnCells(t)));s.push(...n)}return s}rowCount(e){const t=this.buildSelectors({column:e});return t.length?g(t.map((e=>e.invoke(((e,t)=>e.rowCount(t)))))):0}rows(e){const t=m(e)?{}:{column:e},s=this.buildSelectors(t),n=this.factory,o=[];for(let e=0,t=s.length;e<t;e++){const t=s[e].invoke(((e,t)=>e.rows(t)));t.length&&o.push(t)}const r=v(...o),i=[];for(let e=0,t=r.length;e<t;e++){const t=r[e],s=t.map((e=>e.element)),o=s.length>1?new eo(s):s[0],c=t[0].index,l=n.row(o,c);i.push(l)}return i}rowCells(e){const t=this.buildSelectors({row:e}),s=[];for(let e=0,n=t.length;e<n;e++){const n=t[e].invoke(((e,t)=>e.rowCells(t)));s.push(...n)}return s}row(e,t){const s={row:e};m(t)||(s.column=t);const n=this.buildSelectors(s),o=[];for(let e=0,t=n.length;e<t;e++){const t=n[e].invoke(((e,t,s)=>e.row(t,s)));o.push(t.element)}return this.factory.row(new eo(o),e)}cell(e,t){const s={row:e,column:t},n=this.buildSelectors(s);for(let e=0,t=n.length;e<t;e++){const t=n[e].invoke(((e,t,s)=>e.cell(t,s)));if(!(t.element instanceof ro))return t}return this.factory.cell(new ro,e,t)}}class yo{constructor(e,t){this.rowRange=e,this.columnRange=t}cell(e,t,s){return{element:e,rowIndex:t+this.rowRange.start,columnIndex:s+this.columnRange.start}}row(e,t){return{element:e,index:t+this.rowRange.start}}}class bo{constructor(e,t){this.start=e,this.end=t}}class vo{constructor(e,t){this.bag=e,this.selectorMark=t}create(){const{bag:e,selectorMark:t}=this,s=new po((t=>e.elements.has(t))),n=t.select().map((({element:e,rowRange:t,columnRange:n})=>({matrix:s.build(e),rowRange:t,columnRange:n}))),o=new yo(new bo(0,0),new bo(0,0));return new fo((t=>n.map((s=>({invoke:n=>{const o=new yo(s.rowRange,s.columnRange),r=new wo(s.matrix,e,o),i=[];return i.push(r),t.hasOwnProperty("row")&&i.push(t.row-s.rowRange.start),t.hasOwnProperty("column")&&i.push(t.column-s.columnRange.start),n(...i)}})))),o)}}class xo{constructor(e,t,s){this.context=e,this.model=t,this.selectFactory=new vo(e.bag,s),this.selector=this.selectFactory.create()}columnCount(e){return this.selector.columnCount(e)}column(e){return this.createColumnCore(e)}columns(e){return this.selector.rowCells(e).map((e=>this.createColumnCore(e.columnIndex)))}row(e,t){return this.rowCore(e,t)}rows(e){return this.selector.rows(e).map((e=>this.createRowCore(e.index,e.element)))}rowCount(e){return this.selector.rowCount(e)}cell(e,t){return this.cellCore(e,t)}getElements(){return[]}rowCore(e,t){return this.createRowCore(e,this.selector.row(e,t).element)}cellCore(e,t){const s=this.selector.cell(e,t);return this.createCellCore(s.rowIndex,s.columnIndex,s.element)}rowCellsCore(e){return this.selector.rowCells(e).map((e=>this.createCellCore(e.rowIndex,e.columnIndex,e.element)))}columnCellsCore(e){return this.selector.columnCells(e).map((e=>this.createCellCore(e.rowIndex,e.columnIndex,e.element)))}createRowCore(e,t){return new uo(this,e,t)}createColumnCore(e){return new ho(this,e)}createCellCore(e,t,s){return new go(this.context,e,t,s)}}class Co{constructor(e){this.context=e,this.entries=new Map}addClass(e,t){const s=this.key(e);if(null!==s){let e=this.entries.get(s);e||(e=new Set,this.entries.set(s,e)),e.add(t)}}removeClass(e,t){const s=this.key(e);if(null!==s){let e=this.entries.get(s);if(e)return e.delete(t),e.size||this.entries.delete(s),!0}return!1}key(e){return e}}class ko extends Co{constructor(e){super(e)}key(e){return`${e.dataRowIndex}x${e.dataColumnIndex}`}}class Eo extends Co{constructor(e){super(e)}key(e){return e.dataIndex}}class $o extends Co{constructor(e){super(e)}key(e){return e.dataIndex}}class Ro{constructor(e){this.selector=e}get model(){const e=this.selector();if(!e)throw new oe("cell","Model is not found");return e}mode(e){return this.model.mode(e)}get value(){return this.model.value}set value(e){this.model.value=e}get label(){return this.model.label}set label(e){this.model.label=e}get element(){return this.model.element||new ro}}class Io extends go{constructor(e,t,s,n=null){super(e.context,t,s,n),this.box=e;const{mapper:o}=e.context;this.dataRowIndex=o.viewToRow(t),this.dataColumnIndex=o.viewToColumn(s)}model(){const e=this.dataRowIndex,t=this.dataColumnIndex;if(e>=0&&t>=0){const s=this.box.model,{rows:n}=s.data(),{columns:o}=s.view();if(n.length>e&&o.length>t){const s=new Ro((()=>this.box.cell(e,t).modelCore()));return s.rowIndex=e,s.columnIndex=t,s.row=n[e],s.column=o[t],new mo(s)}}return null}addClass(e,t=!1){this.box.addCellClass(this,e,t)}removeClass(e,t=!1){this.box.removeCellClass(this,e,t)}}class Oo extends ho{constructor(e,t){super(e,t),this.box=e;const{mapper:s}=e.context;this.dataIndex=s.viewToColumn(t)}cells(){return this.box.columnCellsCore(this.dataIndex)}cell(e){return this.box.cell(e,this.dataIndex)}addClass(e,t=!1){this.box.addColumnClass(this,e,t)}removeClass(e,t=!1){this.box.removeColumnClass(this,e,t)}}class Fo{constructor(e){this.classList=new no,this.getRect=e}getBoundingClientRect(){return this.getRect()}get clientWidth(){return this.getRect().width}get clientHeight(){return this.getRect().height}get offsetWidth(){return this.getRect().width}get offsetHeight(){return this.getRect().height}}class qo extends uo{constructor(e,t,s=null){super(e,t,s);const{mapper:n}=e.context;this.dataIndex=n.viewToRow(t)}model(){const e=super.model();if(e)return e;const t=this.dataIndex;if(t>=0){const e=this.box.model,{rows:s}=e.data();if(s.length>t)return s[t]}return null}cells(){return this.box.rowCellsCore(this.dataIndex)}cell(e){return this.box.cellCore(this.dataIndex,e)}addClass(e,t=!1){this.box.addRowClass(this,e,t)}removeClass(e,t=!1){this.box.removeRowClass(this,e,t)}}class Lo extends xo{constructor(e,t,s){super(e,t,s),this.cellBox=new ko(e),this.rowBox=new $o(e),this.columnBox=new Eo(e),this.requestInvalidate=new te}addCellClass(e,t,s=!1){s?e.addClassCore(t):(this.cellBox.addClass(e,t),this.requestInvalidate.emit({source:"addCellClass"}))}removeCellClass(e,t,s=!1){s?e.removeClassCore(t):(this.cellBox.removeClass(e,t),this.requestInvalidate.emit({source:"removeCellClass"}))}addRowClass(e,t,s=!1){s?e.addClassCore(t):(this.rowBox.addClass(e,t),this.requestInvalidate.emit({source:"addRowClass"}))}removeRowClass(e,t,s=!1){s?e.removeClassCore(t):(this.rowBox.removeClass(e,t),this.requestInvalidate.emit({source:"removeRowClass"}))}addColumnClass(e,t,s=!1){s?e.addClassCore(t):(this.columnBox.addClass(e,t),this.requestInvalidate.emit({source:"addColumnClass"}))}removeColumnClass(e,t,s=!1){s?e.removeClassCore(t):(this.columnBox.removeClass(e,t),this.requestInvalidate.emit({source:"removeColumnClass"}))}columns(){return this.context.view.columns().map(((e,t)=>this.createColumnCore(t)))}rows(e){const{mapper:t}=this.context;return this.selector.rows(e).map((e=>this.createRowCore(t.rowToView(e.index),e.element)))}rowCount(){return this.model.pagination().count}rowCore(e){const t=this.context.mapper.rowToView(e);if(t>=0&&t<super.rowCount(0))return super.rowCore(t);const s=this.rowRectFactory();return this.createRowCore(t,new Fo(s(t)))}cellCore(e,t){const{mapper:s}=this.context,n=s.rowToView(e),o=s.columnToView(t);if(n>=0&&n<super.rowCount(o))return super.cellCore(n,o);const r=this.cellRectFactory();return this.createCellCore(n,o,new Fo(r(n,o)))}rowCellsCore(e){const{mapper:t}=this.context,s=t.rowToView(e);if(s>=0&&s<super.rowCount(0))return super.rowCellsCore(s);const n=this.cellRectFactory();return super.rowCellsCore(0).map(((e,o)=>this.createCellCore(s,o,new Fo(n(s,t.columnToView(o))))))}createRowCore(e,t){return new qo(this,e,t)}createCellCore(e,t,s){return new Io(this,e,t,s)}createColumnCore(e){return new Oo(this,e)}rowRectFactory(){const{height:e}=this.model.row(),t=a(e)?e:()=>e;let s=null;return e=>()=>{s||(s=this.context.view.rect("body-mid"));const n=t(null,e);return{left:0,right:0,top:s.top+n*e,bottom:s.top+n*(e+1),width:0,height:n}}}cellRectFactory(){const{model:e}=this,{height:t}=e.row(),{count:s}=e.pagination(),{columns:n}=e.view(),o=this.model.layout().columns,r=a(t)?t:()=>t;let i=null;return(e,t)=>()=>{i||(i=this.context.view.rect("body-mid"));const c=n[t],l=r(null,e),a=i.top+l*e-(e>0?0:(s+e)*l),u=o.has(c.key)?o.get(c.key).width:0;return{left:0,right:0+u,top:a,bottom:a+l,width:u,height:l}}}}class So{constructor(e,t,s){this.model=e,this.name=s,this.markup=t}select(){const e=[],t=this.addFactory(e);return t("left"),t("mid"),t("right"),e}addFactory(e){const{model:t}=this,{rows:s}=t.scene(),n=t.scene().column.area;return t=>{const o=t?`${this.name}-${t}`:this.name,r=this.markup[o];if(r){const o=e[e.length-1],i=o?o.columnRange.end:0,c=n[t].length,l=0,a=s.length;e.push({element:r,columnRange:new bo(i,i+c),rowRange:new bo(l,l+a)})}return e}}}class Mo extends xo{constructor(e,t){super(e,t,new So(t,e.markup,"body"))}}class To extends Lo{constructor(e,t){super(e,t,new So(t,e.markup,"body"))}}class jo{constructor(e){this.model=e}columns(){return this.model.view().columns}columnMap(){return is(this.columns())}rows(){return this.model.scene().rows}}class No{constructor(){}resource(){}destroy(){}}class Ao{constructor(){this.rows=[]}}class Po extends xo{constructor(e,t){super(e,t,new So(t,e.markup,"foot"))}}class Vo extends xo{constructor(e,t,s){super(e,t,new So(t,e.markup,"head"))}}class Do{constructor(e){this.selector=e,this.clear()}clear(){this.columnCountCache={},this.columnCellsCache={},this.rowCountCache={},this.rowsCache={},this.rowCellsCache={},this.rowCache={},this.cellCache={}}columnCount(e){return this.columnCountCache.hasOwnProperty(e)?this.columnCountCache.get(e):this.columnCountCache[e]=this.selector.columnCount(e)}columnCells(e){return this.columnCells.hasOwnProperty(e)?this.columnCells.get(e):this.columnCells[e]=this.selector.columnCells(e)}rowCount(e){return this.rowCountCache.hasOwnProperty(e)?this.rowCountCache.get(e):this.rowCountCache[e]=this.selector.rowCount(e)}rows(e){return this.rowsCache.hasOwnProperty(e)?this.rowsCache.get(e):this.rowsCache[e]=this.selector.rows(e)}rowCells(e){return this.rowCellsCache.hasOwnProperty(e)?this.rowCellsCache.get(e):this.rowCellsCache[e]=this.selector.rowCells(e)}row(e,t){const s=`${e}x${t}`;return this.rowCache.hasOwnProperty(s)?this.rowCache.get(s):this.rowCache[s]=this.selector.row(e,t)}cell(e,t){const s=`${e}x${t}`;return this.cellCache.hasOwnProperty(s)?this.cellCache.get(s):this.cellCache[s]=this.selector.cell(e,t)}}function zo(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}class Bo extends co{constructor(e,t){super(),this.context=e,this.model=t,this.layers=new Map}columns(){const{column:e}=this.model.scene();return e.line}focus(){const e=this.getElementsCore("body");return!!e.length&&(e[0].focus(),!0)}blur(){this.getElementsCore("body").forEach((e=>e.blur()))}isFocused(){return this.getElementsCore("body").some((e=>this.isFocusedCore(e)))}addLayer(e){const t=this.layers;if(t.has(e))return t.get(e);const s=this.context.layer(e);return t.set(e,s),s}removeLayer(e){const t=this.layers;if(t.has(e)){return t.get(e).destroy(),t.delete(e),!0}return!1}hasLayer(e){return this.layers.has(e)}addClass(e){const{markup:t}=this.context;t.view&&t.view.classList.add(ks(e))}removeClass(e){const{markup:t}=this.context;t.view&&t.view.classList.remove(ks(e))}scrollLeft(e){const{markup:t}=this.context;if(!arguments.length)return this.getElement().scrollLeft;{const s=t["head-mid"];s&&(s.scrollLeft=e);const n=t["foot-mid"];n&&(n.scrollLeft=e);const o=t["body-mid"];o&&(o.scrollLeft=e);const r=t["body-top"];r&&(r.scrollLeft=e);const i=t["body-bottom"];i&&(i.scrollLeft=e)}}scrollTop(e){if(!arguments.length)return this.getElement().scrollTop;this.getElementsCore("body").forEach((t=>t.scrollTop=e))}scrollHeight(){return this.getElement().scrollHeight}scrollWidth(){return this.getElement().scrollWidth}canScrollTo(e,t){if(e&&!(e.element instanceof ro))switch(t){case"left":if(e=e.element){const{markup:t}=this.context,s=t["table-mid"];if(s)return zo(s,e)}break;case"top":return!0}return!1}rect(e="body-mid"){const{markup:t}=this.context,s=t[e];if(s){const e=s.getBoundingClientRect(),t=s.clientWidth,n=s.clientHeight,o=e.left,r=e.top;return{left:o,top:r,right:o+t,bottom:r+n,width:t,height:n}}return super.rect()}height(e="body-mid"){const{markup:t}=this.context,s=t[e];return s?s.clientHeight:0}width(e="body-mid"){const{markup:t}=this.context,s=t[e];return s?s.clientWidth:0}getElementCore(){const{markup:e}=this.context;return e["body-mid"]}isFocusedCore(e){const{markup:t}=this.context,{activeElement:s}=t.document;return zo(e,s)}getElementsCore(e){const{markup:t}=this.context;return[`${e}-left`,`${e}-mid`,`${e}-right`].filter((e=>t.hasOwnProperty(e))).map((e=>t[e]))}}class Ho{constructor(t,s){this.model=t;const{scroll:n}=t,o={mapper:{rowToView:e=>n().map.rowToView(e),viewToRow:e=>n().map.viewToRow(e),columnToView:N,viewToColumn:N},layer:()=>new No,bag:{head:new so,body:new so,foot:new so},markup:{}};this.box=e(o,s),this._data=new es((()=>new jo(t))),this._view=new es((()=>new Bo(s,t))),this._head=new es((()=>new Vo(this.boxContext("head"),t))),this._foot=new es((()=>new Po(this.boxContext("foot"),t))),this._body=new es((()=>{const e=this.boxContext("body");return"virtual"===n().mode?new To(e,t):new Mo(e,t)}))}invalidate(){this.head.selector=this.head.selectFactory.create(),this.body.selector=this.body.selectFactory.create(),this.foot.selector=this.foot.selectFactory.create()}get view(){return this._view.instance}get data(){return this._data.instance}get head(){return this._head.instance}get body(){return this._body.instance}get foot(){return this._foot.instance}boxContext(e){const{view:t,data:s}=this,{mapper:n,layer:o,bag:r,markup:i}=this.box;return"body"===e?{mapper:n,layer:o,bag:r[e],view:t,data:s,markup:i}:{mapper:{rowToView:N,viewToRow:N,columnToView:N,viewToColumn:N},layer:o,bag:r[e],view:t,data:s,markup:i}}}function Wo(e,t){const s={markup:{document:document},bag:{head:new so,body:new so,foot:new so},layer:t};return new Ho(e,s)}class Uo{constructor(){}static get mimeType(){return"application/x-q-grid+json"}static decode(e){return JSON.parse(e)}static encode(e){return JSON.stringify(e)}}Uo.element=null,Uo.data=null,Uo.area=null,Uo.startPosition=null;class _o{constructor(){this.isActive=!1}}class Ko{constructor(e){this.select=e,this.busy=null,this.result=null}run(e){const t=this.select;this.result=null;let s=!0;return this.busy=new Promise(((n,o)=>{const r=e=>{s&&(this.result=e,n(e))};if(a(t)){const s={resolve:r,reject:o},n=Array.from(arguments).slice(1)||[],i=t(e,s,...n);m(i)||this.invoke(i,r,o)}else this.invoke(t,r,o)})),()=>{this.busy=null,s=!1}}invoke(e,t,s){if(e&&a(e.then))e.then(t),a(e.catch)&&e.catch(s);else if(e&&a(e.subscribe)){let n,o=!1;n=e.subscribe(((...e)=>{t(...e),o=!0,n&&a(n.unsubscribe)&&(n.unsubscribe(),n=null)}),s),o&&n&&a(n.unsubscribe)&&(n.unsubscribe(),n=null)}else t(e)}}class Go{constructor(e){this.td=e,this.value=null,this.label=null,this.fetch=M,this.resetFetch=M}commit(){}reset(){}clear(){}}const Jo=new Go(null);class Yo extends Go{constructor(e){if(super(e),this.fetch=this.fetchFactory(),this.resetFetch=this.fetch.run(e.row),m(e.value))this.value=null;else{const s=Ae(e.column.type,e.column.editor)(t(e.value));this.value=null===s?e.value:s}this.label=m(e.label)?null:t(e.label)}commit(){this.td.value=this.value,this.td.label=this.label,this.resetFetch(),this.resetFetch=M}reset(){this.label=this.td.label,this.value=this.td.value,this.resetFetch(),this.resetFetch=M}clear(){this.label=null,this.value=null,this.resetFetch(),this.resetFetch=M}fetchFactory(){const{editorOptions:e}=this.td.column;return e&&e.fetch?new Ko(e.fetch):new Ko(this.td.value)}get cell(){return this.td}static get empty(){return Jo}}function Xo(e,t){const s=[];return e.forEach((e=>{if(e.key===t)for(let t of Object.keys(e))"key"!==t&&"for"!==t&&s.push({[t]:e[t]})})),{hasRules:s.length>0,rules:{[t]:s}}}function Zo(e,t){return Xo(e,t).hasRules}function Qo(e,t){if(2===arguments.length){const s=Xo(e,t);return new k.Validator(s.rules)}return new k.Validator(e)}class er{constructor(e,t){const{model:s,observeReply:n}=e;this.plugin=e,this.shortcut=t,this.editor=Yo.empty,this.requestClose=null;const o=this.getCommands();t.register(o),this.enter=o.get("enter"),this.commit=o.get("commit"),this.push=o.get("push"),this.cancel=o.get("cancel"),this.reset=o.get("reset"),this.exit=o.get("exit"),this.clear=o.get("clear"),n(s.editChanged).subscribe((e=>{if(e.hasChanges("status")&&"edit.cell.view"!==e.tag.source)if("edit"===e.changes.status.newValue)s.edit({status:"view"},{source:"edit.cell.view"}),this.enter.canExecute()&&this.enter.execute();else if("view"===e.changes.status.newValue){if(s.edit({status:"edit"},{source:"edit.cell.view"}),this.requestClose&&this.requestClose())return;this.cancel.canExecute()&&this.cancel.execute()}})),n(s.navigationChanged).subscribe((e=>{if(e.hasChanges("cell")){if(this.requestClose&&this.requestClose())return;const t=this.editor.td;t&&("data"===t.column.category?this.commit.canExecute(t)&&this.commit.execute(t):this.cancel.canExecute(t)&&this.cancel.execute(t));const{cell:s}=e.state;s&&"focus"===s.column.editorOptions.trigger&&this.enter.canExecute(s)&&this.enter.execute(s)}}))}mode(e,t){const{model:s}=this.plugin;s.edit({status:t},{source:"edit.cell.view"}),e.mode(t)}getCommands(){const{model:e,table:t}=this.plugin,s={enter:new js({priority:1,source:"edit.cell.view",shortcut:this.shortcutFactory("enter"),canExecute:t=>("keyboard"!=(t?"mouse":"keyboard")||!S.isControl(this.shortcut.keyCode()))&&(t=t||e.navigation().cell,Array.isArray(t)&&t.length>0&&"TdCoreDirective"==t[0].constructor.name&&(t=t[0]),t&&t.column.canEdit&&("control"===t.column.category||"cell"===e.edit().mode)&&"view"===e.edit().status&&e.edit().enter.canExecute(this.contextFactory(t,t.value,t.label))),execute:(s,n)=>{ce.info("cell.edit","edit mode"),n&&n.stopImmediatePropagation();const o=s?"mouse":"keyboard";if((s=s||e.navigation().cell)&&!1!==e.edit().enter.execute(this.contextFactory(s,s.value,s.label))){const e=t.body.cell(s.rowIndex,s.columnIndex).model();this.editor=new Yo(e);const n=this.shortcut.keyCode();if("keyboard"===o&&S.isPrintable(n)){const e=Ae(s.column.type,s.column.editor)(S.stringify(n));null!==e&&(this.value=e)}return this.mode(this.editor.td,"edit"),!0}return!1}}),commit:new js({priority:1,source:"edit.cell.view",shortcut:this.shortcutFactory("commit"),canExecute:t=>{if((t=t||this.editor.td)&&mo.equals(t,this.editor.td)&&t.column.canEdit&&("control"===t.column.category||"cell"===e.edit().mode)&&"edit"===e.edit().status){const s=this.contextFactory(t,this.value,this.label,this.tag),n=s.column.key,o=Qo(e.validation().rules,n);return e.edit().commit.canExecute(s)&&!1!==o.validate({[n]:this.value})}return!1},execute:(s,n)=>(ce.info("cell.edit","commit"),n&&n.stopImmediatePropagation(),!(!(s=s||this.editor.td)||!1===e.edit().commit.execute(this.contextFactory(s,this.value,this.label,this.tag)))&&(this.editor.commit(),this.editor=Yo.empty,this.requestClose=null,this.mode(s,"view"),t.view.focus(),!0))}),push:new js({priority:1,source:"edit.cell.view",canExecute:t=>{if((t=t||this.editor.td)&&t.column.canEdit){const s=this.contextFactory(t,this.value,this.label,this.tag),n=s.column.key,o=Qo(e.validation().rules,n);return e.edit().commit.canExecute(s)&&!1!==o.validate({[n]:this.value})}return!1},execute:(t,s)=>(ce.info("cell.edit","batch commit"),s&&s.stopImmediatePropagation(),!(!(t=t||this.editor.td)||!1===e.edit().commit.execute(this.contextFactory(t,this.value,this.label,this.tag)))&&(this.editor.commit(),this.editor=Yo.empty,this.requestClose=null,!0))}),cancel:new js({priority:1,source:"edit.cell.view",shortcut:this.shortcutFactory("cancel"),canExecute:t=>(t=t||this.editor.td)&&t.column.canEdit&&("control"===t.column.category||"cell"===e.edit().mode)&&"edit"===e.edit().status&&e.edit().cancel.canExecute(this.contextFactory(t,this.value,this.label)),execute:(s,n)=>(ce.info("cell.edit","cancel"),n&&n.stopImmediatePropagation(),!(!(s=s||this.editor.td)||!1===e.edit().cancel.execute(this.contextFactory(s,this.value,this.label)))&&(this.editor.reset(),this.editor=Yo.empty,this.requestClose=null,this.mode(s,"view"),t.view.focus(),!0))}),reset:new js({priority:1,source:"edit.cell.view",canExecute:t=>(t=t||this.editor.td)&&t.column.canEdit&&("control"===t.column.category||"cell"===e.edit().mode)&&"edit"===e.edit().status&&e.edit().reset.canExecute(this.contextFactory(t,this.value,this.label)),execute:(t,s)=>(ce.info("cell.edit","reset"),s&&s.stopImmediatePropagation(),!(!(t=t||this.editor.td)||!1===e.edit().reset.execute(this.contextFactory(t,this.value,this.label)))&&(this.editor.reset(),!0))}),exit:new js({priority:1,source:"edit.cell.view",execute:(e,t)=>{if(ce.info("cell.edit","reset"),t&&t.stopImmediatePropagation(),e=e||this.editor.td){if(this.commit.canExecute(e,t)){if(e.value!==this.value)return this.commit.execute(e,t),!0}if(this.cancel.canExecute(e,t))return this.cancel.execute(e,t),!0}return!1}}),clear:new js({priority:1,source:"edit.cell.view",canExecute:t=>(t=t||this.editor.td)&&t.column.canEdit&&("control"===t.column.category||"cell"===e.edit().mode)&&"edit"===e.edit().status&&e.edit().clear.canExecute(this.contextFactory(t,this.value,this.label)),execute:(t,s)=>(ce.info("cell.edit","clear"),s&&s.stopImmediatePropagation(),!(!(t=t||this.editor.td)||!1===e.edit().clear.execute(this.contextFactory(t,this.value,this.label)))&&(this.editor.clear(),!0))})};return new Map(Object.entries(s))}contextFactory(e,t,s,n){const{column:o,row:r,columnIndex:i,rowIndex:c,value:l,label:a}=e;return{column:o,row:r,columnIndex:i,rowIndex:c,oldValue:l,newValue:t,oldLabel:a,newLabel:s,unit:"cell",tag:n,getValueFactory:pe,getLabelFactory:ye}}get fetch(){return this.editor.fetch}get value(){return this.editor.value}set value(e){this.editor.value=e}get label(){return this.editor.label}set label(e){this.editor.label=e}get row(){return this.cell.row}get column(){return this.cell.column}get cell(){return this.editor.td}get options(){return this.column.options}canEdit(e){const{model:t}=this.plugin;return!!e&&(e.column.canEdit&&"cell"===t.edit().mode)}shortcutFactory(e){const{model:t}=this.plugin,{edit:s}=t;return()=>{const t=s()[e+"Shortcuts"],{td:n}=this.editor;if(n){const e=n.column&&n.column.editor?n.column.editor:n.column.type;if(t&&t.hasOwnProperty(e))return t[e]}return t.$default}}}class tr{constructor(){this.editors=[]}commit(){}reset(){}}class sr{constructor(e,t){this.row=e,this.column=t}get value(){return ge(this.row,this.column)}set value(e){return we(this.row,this.column,e)}get label(){return fe(this.row,this.column)}set label(e){return be(this.row,this.column,e)}}const nr=new tr;class or extends tr{constructor(e,t){super(),this.value=s(e),this.row=e,this.editors=t.filter((e=>e.canEdit)).map((e=>new Yo(new sr(this.value,e))))}commit(){this.editors.forEach((e=>e.commit())),Object.assign(this.row,this.value)}reset(){this.editors.forEach((e=>e.reset())),this.value=s(this.row)}static get empty(){return nr}}function rr(e){const{cell:t}=e;return t?t.row:null}function ir(e){const{cell:t}=e;return t?t.column:null}function cr(e){const{cell:t}=e;return t?t.columnIndex:-1}function lr(e){const{cell:t}=e;return t?t.rowIndex:-1}class ar{constructor(e,t){this.plugin=e,this.editor=or.empty;const s=this.getCommands();t.register(s),this.enter=s.get("enter"),this.commit=s.get("commit"),this.cancel=s.get("cancel"),this.reset=s.get("reset")}getCommands(){const{model:e}=this.plugin,t={enter:new js({source:"edit.row.view",shortcut:this.shortcutFactory("enter"),canExecute:t=>(t=t||rr(e.navigation()))&&"row"===e.edit().mode&&"view"===e.edit().status&&e.edit().enter.canExecute(this.contextFactory(t)),execute:(t,s)=>{ce.info("row.edit","edit mode"),s&&s.stopImmediatePropagation();const n=this.model.columnList().line;this.editor=new or(t,n),e.edit({status:"edit"},{source:"edit.row.view"})}}),commit:new js({source:"edit.row.view",shortcut:this.shortcutFactory("commit"),canExecute:t=>(t=t||rr(e.navigation()))&&"row"===e.edit().mode&&"edit"===e.edit().status&&e.edit().commit.canExecute(this.contextFactory(t)),execute:(t,s)=>{ce.info("row.edit","commit"),s&&s.stopImmediatePropagation(),this.editor.commit(),this.editor=or.empty,e.edit({status:"view"},{source:"edit.row.view"})}}),cancel:new js({source:"edit.row.view",shortcut:this.shortcutFactory("cancel"),canExecute:t=>(t=t||rr(e.navigation()))&&"row"===e.edit().mode&&"edit"===e.edit().status&&e.edit().cancel.canExecute(this.contextFactory(t)),execute:(t,s)=>{ce.info("cell.edit","cancel"),s&&s.stopImmediatePropagation(),this.editor.reset(),this.editor=or.empty,e.edit({status:"view"},{source:"edit.row.view"})}}),reset:new js({source:"edit.row.view",canExecute:t=>(t=t||rr(e.navigation()))&&"row"===e.edit().mode&&"edit"===e.edit().status&&e.edit().reset.canExecute(this.contextFactory(t)),execute:(t,s)=>{if(ce.info("row.edit","reset"),s&&s.stopImmediatePropagation(),t&&!1!==e.edit().reset.execute(this.contextFactory(t)))return this.editor.reset(),!1}})};return new Map(Object.entries(t))}contextFactory(e){return{row:e,unit:"row"}}shortcutFactory(e){const{model:t}=this.plugin,{edit:s}=t;return()=>{const t=s()[e+"Shortcuts"];return t&&t.row||t.$default}}}class ur{constructor(e,t){this.cell=new er(e,t),this.row=new ar(e,t)}}class hr{constructor(e){this.plugin=e}startBatch(e){const{model:t}=this.plugin,s=t.edit().status,n=t.selection().mode;return t.selection({mode:"range"}),t.edit({status:"startBatch"}),()=>{t.edit({status:s}),this.doBatch(e),t.selection({mode:n})}}doBatch(e){const{table:t,model:s}=this.plugin,{rows:n}=s.scene(),{columns:o}=s.view(),{items:r}=s.selection(),i=new er(this.plugin,{register:()=>({}),keyCode:()=>""}),c=t.body.cell(e.rowIndex,e.columnIndex).model(),{value:l,label:a}=c,u=c.column.type;for(let e=0,s=r.length;e<s;e++){const{row:s,column:c}=r[e],h=n.indexOf(s),d=o.indexOf(c),m=t.body.cell(h,d).model();if(u===m.column.type){const e=new Yo(m);e.label=a,e.value=l,i.editor=e,i.push.canExecute()&&i.push.execute()}}}}class dr{constructor(){this.resource=new $,this.mode=null,this.status="view",this.method=null,this.enter=new js({source:"edit.model"}),this.commit=new js({source:"edit.model"}),this.cancel=new js({source:"edit.model"}),this.reset=new js({source:"edit.model"}),this.clear=new js({source:"edit.model"}),this.cancelShortcuts={$default:"escape"},this.enterShortcuts={$default:"*",row:"F2|Enter",form:"F2|Enter"},this.commitShortcuts={$default:"tab|shift+tab|enter|ctrl+s",reference:"ctrl+s",row:"ctrl+s",form:"ctrl+s",bool:"tab|shift+tab|left|right|up|down|home|end|pageUp|pageDown","text-area":"ctrl+s|ctrl+enter"}}}class mr{constructor(e,t){this.element=e,this.manager=t,this.handlers={}}on(e,t,s=!1){const n=this.manager.bind(t),o=this.handlers[e]||(this.handlers[e]=[]);return o.push(n),this.element.addEventListener(e,n,s),()=>{this.element.removeEventListener(e,n);const t=o.indexOf(n);t>=0&&o.splice(t,1)}}off(){const e=this.handlers,t=this.element;for(let s of Object.keys(e))for(let n of Array.from(e[s]))t.removeEventListener(s,n)}}class gr{constructor(e,t=(e=>e())){this.context=e,this.apply=t}bind(e){const t=e.bind(this.context),s=this.apply;return(...e)=>s((()=>t(...e)))}}function pr(e){let t=""+e;return t=t.replace(/"/g,'""'),t=/[\n",]/.test(t)?`"${t}"`:t,t}class wr{write(e,t){const s=[],n=[];let o=[];for(let e of t)"data"===e.category&&(n.push(pe(e)),o.push(pr(e.title)));s.push(o.join(","));for(let t of e){const e=[];for(let s of n)e.push(pr(s(t)));s.push(e.join(","))}return s.join("\n")}}function fr(e,t=", "){const s={};for(let[n,o]of Object.entries(e))if(r(o)){const e=[];for(let t of o)e.push(t);s[n]=e.join(t)}else if(h(o)){const e=fr(o,t);for(let[t,o]of Object.entries(e))s[n+"."+t]=o}else s[n]=o;return s}class yr{constructor(){this.resource=new $}}class br{write(e,t){const s=[];for(let n of e){const e=fr(n),o={};for(let s of t)o[s.title]=e[s.key];s.push(o)}return JSON.stringify(s,"",2)}}function vr(e){let t=""+e;const s=[/</g,/>/g,/&/g,/'/g,/"/g,/\s\s+/g,/\n/g],n=["&lt;","&gt;","&amp;","&apos;","&quot;"," ","&#xA;"];for(let e=0;e<s.length;e++)t=t.replace(s[e],n[e]);return t}function xr(e){let t="";for(let[s,n]of Object.entries(e))if(e.hasOwnProperty(s))if(!h(n)||r(n)||d(n))if(r(n))for(let e of n)d(e)?t+=`<${s}>${vr(e)}</${s}>`:t+=`<${s}>${xr(e)}</${s}>`;else d(n)&&(t+=`<${s}>${vr(n)}</${s}>`);else t+=`<${s}>${xr(n)}</${s}>`;return t}class Cr{write(e){const t=['<?xml version="1.0" encoding="UTF-8"?><root>'];for(let s of e)t.push(xr({row:s}));return t.push("</root>"),t.join("")}}function kr(e){const t=getType(e),s=""+e,n=+e,o=!!e,r=new Date(e);return i=>{const c=getType(i);if(t===c)return e;switch(c){case"Number":return n;case"String":return s;case"Date":return r;case"Boolean":return o;default:throw oe("cast.factory",`Unsupported format ${c}`)}}}function Er(e,t="and"){const s=[];for(let[t,n]of Object.entries(e)){if("$expression"===t){s.push(n);continue}n.expression&&s.push(n.expression);const e=[];n.items&&n.items.length&&e.push(Rr(t,n.items)),n.blanks&&e.push($r(t)),e.length&&(1===e.length?s.push(e[0]):s.push(Ir(e,"or")))}return Ir(s,t)}function $r(e){return{kind:"group",op:"and",left:{kind:"condition",left:e,op:"isEmpty",right:null},right:null}}function Rr(e,t){return{kind:"group",op:"and",left:{kind:"condition",left:e,op:"in",right:Array.from(t)},right:null}}function Ir(e,t){const s={kind:"group",op:t,left:null,right:null};let n=s;return e.forEach((e=>{if(n.left){const s={kind:"group",op:t,left:e,right:null};n.right=s,n=s}else n.left=e})),s.left?s:null}class Or{constructor(){}visit(e,t=0){switch(e.kind){case"group":return this.visitGroup(e,t+1);case"condition":return this.visitCondition(e,t);case"function":return this.visitFunction(e,t);default:throw oe("expression.visitor",`Invalid kind ${e.kind}`)}}visitGroup(e,t){return e.right&&(this.visit(e.left,t),this.visit(e.right,t)),this.visit(e.left,t)}visitCondition(e,t){switch(e.op){case"isNotNull":case"isNull":case"isNotEmpty":case"isEmpty":case"isNumeric":case"isNotNumeric":return this.visitUnary(e,t);case"equals":case"notEquals":case"greaterThanOrEquals":case"greaterThan":case"lessThanOrEquals":case"lessThan":case"like":case"notLike":case"startsWith":case"endsWith":case"match":return this.visitBinary(e,t);case"between":return this.visitBetween(e,t);case"in":return this.visitIn(e,t);default:throw new oe("expression.visitor",`Invalid operation ${e.op}`)}}visitUnary(e){this.visitLeft(e.left)}visitBinary(e){this.visitLeft(e.left),this.visitRight(e.right)}visitLeft(e){if(e.kind&&"function"===e.kind)this.visitArguments(e.arguments)}visitBetween(){}visitIn(){}visitFunction(){}visitArguments(e){return e.map((e=>{switch(e.kind){case"condition":case"group":this.visit(e)}}))}}function Fr(e,t,s){if(!s)return'<span class="q-grid-markup-condition-value-invalid"></span>';switch(t){case"text":return function(e){return`<span class="q-grid-markup-condition-quote">'</span>\n                <span class="q-grid-markup-condition-value q-grid-markup-condition-value-text">${e}</span>\n            <span class="q-grid-markup-condition-quote">'</span>`}(e);case"number":return function(e){const t=Number.parseFloat(e);if(!isNaN(t)&&isFinite(t))return`<span class="q-grid-markup-condition-value q-grid-markup-condition-number">${e}</span>`;return`<span class="q-grid-markup-condition-value q-grid-markup-condition-number q-grid-markup-condition-error">${e}</span>`}(e);case"date":return function(e){const t=new Date(e);if("Invalid Date"!==t&&!isNaN(t))return`<span class="q-grid-markup-condition-quote">'</span>\n                    <span class="q-grid-markup-condition-value q-grid-markup-condition-value-date">${e}</span>\n                <span class="q-grid-markup-condition-quote">'</span>`;return`<span class="q-grid-markup-condition-quote">'</span>\n                <span class="q-grid-markup-condition-value q-grid-markup-condition-value-date q-grid-markup-condition-error">${e}</span>\n            <span class="q-grid-markup-condition-quote">'</span>`}(e);default:return""+e}}class qr extends Or{constructor(e,t,s){super(),this.label=e,this.type=t,this.isValid=s}visitGroup(e,t){if(e.right){const s=this.visit(e.left,t),n=this.visit(e.right,t),o=`<div class="q-grid-markup-node-left">${s}</div><span class="q-grid-markup-group-op">${e.op}</span><div class="q-grid-markup-node-right">${n}</div>`;return`<div class="q-grid-markup-node">${t>1?`<span class="q-grid-markup-group-open">(</span>${o}<span class="q-grid-markup-group-close">)</span>`:o}</div>`}return`<div class="q-grid-markup-node">${this.visit(e.left,t)}<div class="q-grid-markup-node">`}visitUnary(e){switch(e.op){case"isNotNull":return`<span class="q-grid-markup-condition-left">${this.label(e.left)}</span><span class="q-grid-markup-condition-right q-grid-markup-condition-unary">is not empty</span>`;case"isNull":return`<span class="q-grid-markup-condition-left">${this.label(e.left)}</span><span class="q-grid-markup-condition-right q-grid-markup-condition-unary">is empty</span>`;default:throw new oe("markup.visitor",`Invalid operation ${e.op}`)}}visitBinary(e){let t;switch(e.op){case"equals":t="=";break;case"notEquals":t="&lt;&gt;";break;case"greaterThanOrEquals":t="&gt;=";break;case"greaterThan":t="&gt;";break;case"lessThanOrEquals":t="&lt;=";break;case"lessThan":t="&lt;";break;case"like":t="like";break;case"notLike":t="not like";break;case"startsWith":t="starts with";break;case"endsWith":t="ends with";break;default:throw new oe("markup.visitor",`Invalid operation ${e.op}`)}const s=this.isValid(e.left,e.right);return`<span class="q-grid-markup-condition-left">${this.label(e.left)}</span>\n                <span class="q-grid-markup-condition-op">${t}</span>\n                <span class="q-grid-markup-condition-right">${Fr(e.right,this.type(e.left),s)}</span>`}visitBetween(e){const t=this.isValid(e.left,e.right);return`<span class="q-grid-markup-condition-left">${this.label(e.left)}</span>\n                <span class="q-grid-markup-condition-op">between</span>\n                <span class="q-grid-markup-condition-right">${Fr(e.right[0],this.type(e.left),t)}</span>\n                <span class="q-grid-markup-condition-op">and</span>\n                <span class="q-grid-markup-condition-right">${Fr(e.right[1],this.type(e.left),t)}</span>`}visitIn(e){const t=this.isValid(e.left,e.right);return`<span class="q-grid-markup-condition-left">${this.label(e.left)}</span>\n                <span class="q-grid-markup-condition-op">in</span>\n                <span class="q-grid-markup-condition-open">(</span>\n                <span class="q-grid-markup-condition-right">${e.right.map((s=>Fr(s,this.type(e.left),t))).join(", ")}</span>\n                <span class="q-grid-markup-condition-close">)</span>`}}class Lr extends Or{constructor(e,t,s){super(),this.valueFactory=e,this.assertFactory=t,this.getType=s}visitGroup(e){if(e.right){const t=this.visit(e.left),s=this.visit(e.right);switch(e.op){case"and":return e=>t(e)&&s(e);case"or":return e=>t(e)||s(e);default:throw oe("predicate.visitor",`Invalid operation ${e.op}`)}}return this.visit(e.left)}visitCondition(e){const t=e.right,s=e.left,n=this.valueFactory(s),o=this.assertFactory(s),i=new Set;let c=Pe(this.getType(s,r(t)?t[0]:t));r(t)&&(t.length?t.forEach((e=>i.add(""+e))):c=N);const{equals:l,isNull:a,lessThan:u}=o,h=(e,t)=>l(e,t)||u(e,t),d=(e,t)=>l(e,t)||!u(e,t);let g;switch(e.op){case"isNotNull":case"isNotEmpty":g=e=>!a(e);break;case"isNull":case"isEmpty":g=e=>a(e);break;case"equals":{const e=c(t);g=t=>l(c(t),e);break}case"notEquals":{const e=c(t);g=t=>!l(c(t),e);break}case"greaterThanOrEquals":{const e=c(t);g=t=>d(c(t),e);break}case"greaterThan":{const e=c(t);g=t=>{return s=c(t),!l(s,n=e)&&!u(s,n);var s,n};break}case"lessThanOrEquals":{const e=c(t);g=t=>h(c(t),e);break}case"lessThan":{const e=c(t);g=t=>u(c(t),e);break}case"between":{const[e,s]=t,n=m(e),o=m(s);if(n&&o){g=T;break}if(o){const t=c(e);g=e=>d(c(e),t);break}if(n){const e=c(s);g=t=>h(c(t),e);break}const r=c(e),i=c(s);g=e=>{const t=c(e);return d(t,r)&&h(t,i)};break}case"in":g=e=>{if(r(e)){for(const t of i)if(e.some((e=>""+e===t)))return!0;return!1}const t=e||0===e?""+e:"null";return i.has(t)};break;case"like":{const e=(""+t).toLowerCase();g=t=>t&&(""+t).toLowerCase().includes(e);break}case"notLike":{const e=(""+t).toLowerCase();g=t=>t&&!(""+t).toLowerCase().includes(e);break}case"startsWith":{const e=(""+t).toLowerCase();g=t=>t&&0===(""+t).toLowerCase().indexOf(e);break}case"endsWith":{const e=(""+t).toLowerCase();g=t=>{const s=(""+t).slice(-e.length).toLowerCase();return e===s};break}default:throw new oe("predicate.visitor",`Invalid operation ${e.op}`)}return e=>{const t=n(e);return g(t)}}}class Sr{constructor(){this.skip=0}}class Mr{constructor(e){const{model:s}=e;this.plugin=e,this.column=new js({source:"filter.view",execute:(e,n)=>{const{key:o}=e;let{by:r,operatorFactory:i}=s.filter();r=t(r);const c=r[o]||(r[o]={});if(m(n)||null===n||""===n)delete r[o];else{const t=i(e),s=c.expression?c.expression.op:t[0];switch(s){case"contains":c.items=[n];break;case"between":c.expression={kind:"condition",left:o,op:s,right:[null,n]};break;default:c.expression={kind:"condition",left:o,op:s,right:n}}}s.filter({by:r},{source:"filter.view"})}})}has(e){const{model:t}=this.plugin,{by:s}=t.filter();return s.hasOwnProperty(e.key)}value(e){const{model:t}=this.plugin,{key:s}=e,{by:n}=t.filter();if(n[s]){const{expression:e,items:t}=n[s];return e?r(e.right)?e.right[e.right.length-1]:e.right:t&&t.length?t[0]:null}return null}}function Tr(e){const{model:t}=e,s=Er(t.filter().by);if(null!==s){const{labelFactory:n}=e,{assertFactory:o}=t.filter(),r=is(t.columnList().line),i=e=>{const t=r[e];return"array"===t.type?e=>ge(e,t):n(r[e])},c=e=>o(r[e]),l=e=>{const t=r[e];return t&&t.type||"text"};return new Lr(i,c,l).visit(s)}return T}class jr{constructor(){this.resource=new $,this.by={},this.match=Tr,this.custom=T,this.fetch=M,this.unit="default",this.assertFactory=()=>({equals:(e,t)=>e===t,lessThan:(e,t)=>e<t,isNull:e=>""===e||null==e}),this.operatorFactory=e=>{switch(e.type){case"text":case"url":case"email":case"file":return["contains","like","notLike","startsWith","endsWith","isEmpty","isNotEmpty"];case"date":case"datetime":return["between","contains","lessThan","lessThanOrEquals","greaterThan","greaterThanOrEquals","isEmpty","isNotEmpty"];case"id":case"currency":case"number":return["between","contains","like","lessThan","lessThanOrEquals","greaterThan","greaterThanOrEquals","isEmpty","isNotEmpty"];default:return["contains"]}}}}function Nr(){return e=>new Ts((t=>e.subscribe({next:e=>{t.next(e),t.complete()}})))}function Ar(e){return t=>new Ts((s=>t.subscribe({next:t=>{e(t)&&s.next(t)}})))}class Pr{constructor(e){this.model=e}activate(e,t){const{focus:s,scene:n,sceneChanged:o}=this.model;m(e)&&(e=s().rowIndex),e<0&&(e=0),m(t)&&(t=s().columnIndex),t<0&&(t=n().column.line.findIndex((e=>e.model.canFocus))),"stop"===n().status?this.focus(e,t):o.on(((s,n)=>{s.hasChanges("status")&&"stop"===s.state.status&&(n(),this.focus(e,t))}))}focus(e,t){const{pagination:s,focus:n}=this.model,{count:o,current:r,size:i}=s(),c=this.getPage(o),l=Math.max(0,Math.min(this.getPage(e),c));if(r!==l)return s({current:l},{source:"focus.service"}),void this.activate(e,t);n({isActive:!0,rowIndex:e-=i*r,columnIndex:t},{source:"focus.service"})}getPage(e){const{model:t}=this,{size:s}=t.pagination();return Math.max(0,Math.floor(e/s))}}class Vr{constructor(e){const{table:t,model:s,observe:n}=e;n(s.sceneChanged).pipe(Ar((e=>e.hasChanges("status")&&"stop"===e.state.status)),Nr()).subscribe((e=>{t.view.focus()}))}}class Dr{constructor(){this.isActive=!1,this.rowIndex=-1,this.columnIndex=-1}}class zr{constructor(e){const{model:t,observeReply:s}=e;this.plugin=e,this.valueFactory=pe,this.rows=[],s(t.sceneChanged).subscribe((e=>{e.hasChanges("column")&&this.invalidate()}))}invalidate(){ce.info("view.foot","invalidate"),this.rows=new Array(this.count)}columns(e,t){const{model:s}=this.plugin;return s.scene().column.area[t]||[]}get count(){const{model:e}=this.plugin,{columns:t}=e.view(),s=e.foot().resource.count;for(let e=0,n=t.length;e<n;e++)if(t[e].aggregation)return Math.max(s,1);return s}value(e){if(e.aggregation){const t=e.aggregation,s=e.aggregationOptions;if(!Gt.hasOwnProperty(t))throw new oe("foot",`Aggregation ${t} is not registered`);const{model:n}=this.plugin,{rows:o}=n.data(),r=this.valueFactory(e);return Gt[t](o,r,s)}return null}}class Br extends ${constructor(e={},t={},s=0){super(e,t),this.count=s}}class Hr{constructor(){this.resource=new Br,this.cache=new fs}}class Wr{constructor(e,t){const{model:s,disposable:n,observe:o}=t,{grid:r}=s;if(this.plugin=t,"bound"===r().status)throw new oe("grid.host",`Model is already used by grid "${r().id}"`);e.id||(e.id=s.grid().id),r({status:"bound"},{source:"grid.host"}),this.invalidateVisibility(),o(s.sceneChanged).subscribe((e=>{e.hasChanges("column")&&this.invalidateVisibility()})),n.add((()=>s.grid({status:"unbound"},{source:"grid.host"})))}keyUp(e){const{model:t}=this.plugin,{codes:s}=t.keyboard(),n=L.translate(e.keyCode),o=s.indexOf(n);if(o>=0){const e=Array.from(s);e.splice(o,1),t.keyboard({code:n,codes:e,status:"up"},{source:"key.up"})}t.keyboard({code:null,status:"release"},{source:"key.up"})}keyDown(e,t="grid"){const{model:s}=this.plugin,{shortcut:n}=s.action(),o=L.translate(e.keyCode),r=n.keyDown(e,t);if(r.length>0)e.preventDefault(),e.stopPropagation();else if("TBODY"===e.target.tagName){const{prevent:t}=s.navigation();t.has(o)&&(e.preventDefault(),e.stopPropagation())}return s.keyboard({code:o,codes:b(s.keyboard().codes.concat(o)),status:"down"},{source:"key.down"}),r}invalidateVisibility(){const{model:e}=this.plugin,{left:t,right:s}=e.scene().column.area,{pinTop:n,pinBottom:o}=e.row(),{pin:r}=e.visibility(),i={left:t.length>0,right:s.length>0,top:n.length>0,bottom:o.length>0};l(r,i)||e.visibility({pin:i},{source:"grid.host"})}invalidateActive(){const{model:e,table:t,service:s}=this.plugin;if(t.view.isFocused()){!e.mouse().target&&(e.focus().rowIndex<0||e.focus().columnIndex<0)?s.focus(e.pagination().size*e.pagination().current):e.focus({isActive:!0},{source:"grid.host"})}else e.focus({isActive:!1},{source:"grid.host"})}}class Ur{constructor(e){this.pipes=e}run(e,t=[]){const s=this.pipes.map((t=>s=>new Promise(((n,o)=>t(s,e,n,o)))));return function(e,t){return e=Array.from(e),new Promise(((s,n)=>{function o(t){if(e.length){e.shift()(t).then(o).catch((e=>{throw n(e),e}))}else s(t)}o(t)}))}(s,t)}}function _r(e){return function(t,s,n){const o=new Ur(n),r={model:e,source:t,changes:s,getValueFactory:pe,getLabelFactory:ye},{rows:i}=e.data();return o.run(r,i)}}function Kr(){function e(e){const t=(Math.random().toString(16)+"000000000").substr(2,8);return e?"-"+t.substr(0,4)+"-"+t.substr(4,4):t}return e()+e(!0)+e(!0)+e()}class Gr{constructor(){this.tasks=[]}next(){this.tasks.shift();const e=this.tasks[0];return!!e&&(e(),!0)}add(e){return this.tasks.push(e),1===this.tasks.length&&e(),this.tasks.length}}class Jr{constructor(e){this.model=e,this.scheduler=new Gr}invalidate(...e){const{source:t,changes:s,pipe:n,why:o}=function(...e){return e.length?d(e[0])?{source:e[0],changes:e[1]||{},pipe:e[2],why:"refresh"}:Object.assign({source:"invalidate",changes:{},pipe:null,why:"refresh"},e[0]):{source:"invalidate",changes:{},pipe:null,why:"refresh"}}(...e),{scheduler:r,model:i}=this,{scene:c}=i,l=_r(i),a="refresh"===o?this.busy():M,u=()=>{a(),r.next()||c({status:"pull"},{source:t,behavior:"core"})},h=new se;return ce.info("grid",`add task ${t}`),r.add((()=>(ce.info("grid",`start task ${t}`),c({status:"start"},{source:t,behavior:"core"}),i.head().cache.clear(),i.body().cache.clear(),i.foot().cache.clear(),Q.invoke((()=>l(t,s,n||i.data().pipe))).then((()=>{ce.info("grid",`finish task ${t}`),u(),h.resolve()})).catch((e=>{ce.error("grid",e),u(),h.reject()}))))),h.promise}busy(){const e=Kr(),{progress:t}=this.model,s=t().queue.concat([e]);return t({queue:s}),()=>{const s=Array.from(t().queue),n=s.indexOf(e);n>=0&&(s.splice(n,1),t({queue:s}))}}focus(e,t){new Pr(this.model).activate(e,t)}}class Yr{constructor(){this.id=`q-grid-${Kr()}`,this.status="unbound",this.caption="",this.interactionMode=0,this.title=""}}function Xr(e,t){return e.source===t.by?e:e.children.length?e.children[0]:e}function Zr(e,t){return"group"!==t.type||e.source===t.by}function Qr(e,t,s){return e.source===t.by?!s||s.state.expand:!!e.children.length&&Qr(e.children[0],t,e)}class ei{constructor(e,t){const{model:s,observeReply:n,disposable:o,service:r}=e;this.plugin=e,this.valueFactory=pe;const i=new js({source:"group.view",execute:e=>{let t=rr(s.navigation()),n=ir(s.navigation());e&&(t=e[0]||t,n=e[1]||n);const o=this.getNode(t,n),{toggle:i}=s.group();!1!==i.execute(o)&&(o.state.expand=!o.state.expand,r.invalidate({source:"group.view",pipe:Zn.group,why:Zn.group.why}))},canExecute:e=>{let t=rr(s.navigation()),n=ir(s.navigation());e&&(t=e[0]||t,n=e[1]||n);const o=this.getNode(t,n),{toggle:r}=s.group();return o&&"group"===o.type&&r.canExecute(o)},shortcut:s.group().shortcut.toggle});let c=!0;const l=new js({source:"group.view",execute:()=>{if(!1!==s.group().toggleAll.execute()){const{nodes:e}=s.view(),{toggle:t}=s.group();Us(e,(e=>{i.canExecute([e])&&!1!==t.execute(e)&&(e.state.expand=c)})),c=!c,r.invalidate({source:"group.view",pipe:Zn.group,why:Zn.group.why})}},canExecute:()=>s.group().toggleAll.canExecute()});this.toggleStatus=i,this.toggleAllStatus=l,t.register([i,l]);const a=_t(s);let u;this.reference={group:a("group")},this.getNode=N,this.isVisible=T,n(s.groupChanged).subscribe((e=>{if(e.hasChanges("mode"))switch(e.state.mode){case"rowspan":this.getNode=Xr,this.isVisible=Qr;break;case"flat":this.getNode=N,this.isVisible=Zr;break;default:this.getNode=N,this.isVisible=T}}));const h=()=>{u&&(u.unsubscribe(),u=null)};o.add(h),n(s.rowChanged).subscribe((e=>{if(e.hasChanges("toggle")){const{toggle:t}=e.state;h(),u=t.canExecuteCheck.subscribe((()=>{this.toggleStatus.canExecuteCheck.next()}))}}))}count(e,t){return(e=this.getNode(e,t)).children.length||e.rows.length}status(e,t){return(e=this.getNode(e,t)).state.expand?"expand":"collapse"}offset(e,t){const{model:s}=this.plugin;e=this.getNode(e,t);const{mode:n}=s.group();switch(n){case"nest":case"subhead":return t?t.offset*e.level:0;default:return 0}}value(e,t){if(e=this.getNode(e,t),t){return ye(t)(e)}return null}}class ti{constructor(){this.resource=new $,this.mode="nest",this.summary=null,this.by=[],this.toggle=new js({source:"group.state"}),this.toggleAll=new js({source:"group.state"}),this.flattenFactory=Jt,this.shortcut={toggle:"space|enter"}}}class si{constructor(e){this.bag=e}cell(e){for(let t of e)if("TD"===t.nodeName||"TH"===t.nodeName){const e=this.bag.findModel(t);if(!e)break;return e}return null}row(e){for(let t of e)if("TR"===t.nodeName){const e=this.bag.findModel(t);if(!e)break;return e}return null}}function ni(e,t,s){const n=function(e){return e.replace(/-([a-z])/g,oi)}(t);return m(s)?e.style[n]:(e.style[n]=s,n)}function oi(e,t){return t.toUpperCase()}function ri(e){const t=[];for(;e;)t.unshift(e),e=e.parentNode;return t}function ii(e){const t=e.composedPath&&e.composedPath()||e.path,s=e.target;return t?t.indexOf(window)<0?t.concat(window):t:s===window?[window]:[s].concat(ri(s),window)}function ci(e,t){return document.elementFromPoint(e,t)}class li{constructor(e){const{model:t,table:s,observeReply:n}=e;this.plugin=e,this.column=null,n(t.dragChanged).subscribe((e=>{e.hasChanges("isActive")&&e.state.isActive&&(this.column=null)}))}mouseMove(e){const{table:t}=this.plugin,s=new si(t.box.bag.head).cell(ii(e));s&&this.highlight(s.column)}mouseLeave(){this.highlight(null)}highlight(e){const{view:t}=this.plugin,{highlight:s}=t;s.column.canExecute(e)&&this.column!==e&&(this.column&&s.column.execute(this.column,!1),e&&s.column.execute(e,!0),this.column=e)}}class ai{constructor(e,t){const{model:s,table:n,observeReply:o}=e;this.plugin=e,this.tagName=t,this.rows=[];const r=new si(n.box.bag.head);this.drop=new js({source:"head.view",canExecute:e=>{if("end"===e.action)return!0;const t=r.cell(ii(e));return t&&t.column.canMove},execute:e=>{const t=e.dragData;switch(e.action){case"over":{const n=r.cell(ii(e));if(!e.inAreaX(n.element))return;const o=n.column.key;if(t!==o){const{columnList:e}=s,n=Js(e().index),r=Gs(n,(e=>e.key.model.key===t)),i=Gs(n,(e=>e.key.model.key===o));if(r&&i&&i.path.indexOf(r.node)<0){const t=r.path.reverse(),s=t.findIndex((e=>e.children.length>1));if(s>=0){const o=t[s],c=t[s-1]||r.node,l=o.children.indexOf(c);o.children.splice(l,1),i.parent.children.splice(i.index,0,c),c.level=i.parent.level+1,Us(c.children,((e,t,s)=>{e.level=(t||s).level+1}),c),e({index:n},{source:"head.view"})}}}break}case"end":case"drop":{const{index:e}=s.columnList(),o=Gs(e,(e=>e.key.model.key===t));if(o)for(let e of Ks(o.node)){n.body.column(e.key.columnIndex).removeClass("q-grid-drag")}break}}}}),this.drag=new js({source:"head.view",canExecute:e=>{const t=e.data,{index:n}=s.columnList(),o=Gs(n,(e=>e.key.model.key===t));return o&&o.node.key.model.canMove},execute:e=>{const t=e.data,{index:o}=s.columnList(),r=Gs(o,(e=>e.key.model.key===t));if(r)for(let e of Ks(r.node)){return n.body.column(e.key.columnIndex).addClass("q-grid-drag"),()=>n.head.cell}}}),this.resize=new js({source:"head.view",canExecute:e=>{const t=e.data,s=n.data.columnMap();return s.hasOwnProperty(t)&&!1!==s[t].canResize}}),o(s.dataChanged).subscribe((e=>{if(e.hasChanges("columns")){const t=os(e.state.columns);s.columnList({line:t},{source:"head.view"})}})),o(s.sceneChanged).subscribe((e=>{e.hasChanges("column")&&this.invalidate()})),o(s.filterChanged).subscribe((e=>{e.hasChanges("unit")&&this.invalidate()}))}columns(e,t){return e.filter((e=>e.model.pin===t))}invalidate(){ce.info("view.head","invalidate");const{model:e,table:t}=this.plugin;if(this.rows=Array.from(e.scene().column.rows),this.rows.length>1?t.view.addClass("q-grid-head-span"):t.view.removeClass("q-grid-head-span"),"row"===e.filter().unit){const e=t.data.columns().map((e=>new on(e)));this.rows.push(e)}}}class ui{constructor(){this.resource=new $,this.cache=new fs}}function hi(e){const{columnKey:t}=e.selection();return t===N?e=>e.key:N}function di(e){const{rowKey:t}=e.selection();if(t===N){const t=e.columnList().line,s=t.findIndex((e=>"id"===e.type));if(s>=0){return pe(t[s])}const{rows:n}=e.data();return e=>n.indexOf(e)}return N}function mi(e,t,s){switch(e){case"row":return t;case"column":return s;case"cell":return e=>e.row&&e.column?{row:t(e.row),column:s(e.column)}:e;default:throw new oe("selection.state",`Invalid unit ${e}`)}}class gi{constructor(e){this.model=e}lookup(e,t){let s=[];if(0===e.length)return s;const{model:n}=this;switch(m(t)&&(t=n.selection().unit),t){case"column":{const t=function(e,t){const s=e.columnList().line;return e=>{const n=[];return s.forEach((s=>{const o=t(s);e.indexOf(o)>=0&&n.push(s)})),n}}(n,this.keyFactory("column"));s=t(e);break}case"row":{const t=function(e,t){const{rows:s}=e.data();return e=>{const n=[];return s.forEach((s=>{const o=t(s);e.indexOf(o)>=0&&n.push(s)})),n}}(n,this.keyFactory("row"));s=t(e);break}case"cell":{const t=function(e,t){const{rows:s}=e.data(),n=e.columnList().line,o=(e,t)=>e.column===t.column&&e.row===t.row;return e=>{const r=[];return n.forEach((n=>{s.forEach((s=>{const i={column:n,row:s};e.findIndex((e=>o(e,t(i))))>=0&&r.push(i)}))})),r}}(n,this.keyFactory("cell"));s=t(e);break}case"mix":{const t=e.filter((e=>"row"===e.unit)).map((e=>e.item)),n=e.filter((e=>"column"===e.unit)).map((e=>e.item)),o=e.filter((e=>"cell"===e.unit)).map((e=>e.item));s.push(...this.lookup(t,"row").map((e=>({item:e,unit:"row"})))),s.push(...this.lookup(n,"column").map((e=>({item:e,unit:"column"})))),s.push(...this.lookup(o,"cell").map((e=>({item:e,unit:"cell"}))));break}default:throw new oe("selection.state",`Invalid unit ${t}`)}return s}map(e){const t=this.model.selection(),s=this.keyFactory();switch(t.unit){case"column":case"row":case"cell":return e.map(s);case"mix":return e.map((e=>({unit:e.unit,item:s(e)})));default:throw new oe("selection.state",`Invalid unit ${t.unit}`)}}keyFactory(e){const{rowKey:t,columnKey:s,unit:n}=this.model.selection();switch(e=e||n){case"column":case"row":case"cell":return mi(e,t,s);case"mix":{const e=mi("cell",t,s),n=mi("row",t,s),o=mi("column",t,s);return t=>{if(!t.unit)return N;switch(t.unit){case"column":return o(t.item);case"row":return n(t.item);case"cell":return e(t.item);default:throw new oe("selection.service",`Invalid unit ${t.unit}`)}}}default:throw new oe("selection.service",`Invalid unit ${e}`)}}hashFactory(){const e=this.keyFactory(),t=function(e){const t=e.selection();switch(t.unit){case"row":return di(e);case"column":return hi(e);case"cell":{const t=hi(e),s=di(e);return e=>`${t(e.column)}[${s(e.row)}]`}case"mix":{const t=hi(e),s=di(e);return(e,n)=>{if(!n.unit)return e;switch(n.unit){case"column":return t(e);case"row":return s(e);case"cell":return`${t(e.column)}[${s(e.row)}]`;default:throw new oe("selection.service",`Invalid unit ${n.unit}`)}}}default:throw new oe("selection.service",`Invalid unit ${t.unit}`)}}(this.model);return s=>{const n=e(s);return t(n,s)}}}class pi{constructor(e){const{model:t,table:s,observeReply:n,observe:o}=e;this.plugin=e,this.cellSelector=new Is(t,s),this.selectionService=new gi(t);let r=[],i=[],c=[],l=[],a=[];this.column=new js({source:"highlight.view",canExecute:()=>!this.isRendering,execute:(e,s)=>{const n=Array.from(t.highlight().columns),o=n.indexOf(e.key);let r=!1;s?o<0&&(n.push(e.key),r=!0):o>=0&&(n.splice(o,1),r=!0),r&&t.highlight({columns:n},{source:"highlight.view"})}}),this.row=new js({source:"highlight.view",canExecute:()=>!this.isRendering,execute:(e,s)=>{const n=Array.from(t.highlight().rows),o=n.indexOf(e);let r=!1;s?o<0&&(n.push(e),r=!0):o>=0&&(n.splice(o,1),r=!0),r&&t.highlight({rows:n},{source:"highlight.view"})}}),this.cell=new js({source:"highlight.view",canExecute:()=>!this.isRendering,execute:(e,s)=>{let{cell:n}=t.highlight(),o=!0;e===n?o=!1:e&&n&&(o=e.rowIndex!==n.rowIndex||e.columnIndex!==n.columnIndex),o&&t.highlight({cell:e},{source:"highlight.view"})}}),this.clear=new js({execute:()=>{const{rows:e,cell:s}=t.highlight();e.forEach((e=>this.row.execute(e,!1))),s&&this.cell.execute(null,!1)}}),n(t.selectionChanged).subscribe((e=>{e.hasChanges("items")&&(l=this.invalidateSelection(l))})),n(t.sceneChanged).subscribe((e=>{e.hasChanges("status")&&"stop"===e.state.status&&(i=this.invalidateColumnHover(i),c=this.invalidateRowHover(c),a=this.invalidateCellHover(a),r=this.invalidateSortBy(r),l=this.invalidateSelection(l))})),n(t.sortChanged).subscribe((e=>{!this.isRendering&&e.hasChanges("by")&&(r=this.invalidateSortBy(r))})),n(t.highlightChanged).subscribe((e=>{this.isRendering||(e.hasChanges("cell")&&(a=this.invalidateCellHover(a)),e.hasChanges("columns")&&(i=this.invalidateColumnHover(i)),e.hasChanges("rows")&&(c=this.invalidateRowHover(c)))})),o(t.dragChanged).subscribe((e=>{e.hasChanges("isActive")&&e.state.isActive&&(t.highlight({columns:[],rows:[],cell:null},{source:"highlight.view"}),i=this.invalidateColumnHover(i),c=this.invalidateRowHover(c),a=this.invalidateCellHover(a))}))}get isRendering(){const{model:e}=this.plugin;return"stop"!==e.scene().status||e.drag().isActive}invalidateColumnHover(e){e.forEach((e=>e()));const{model:t}=this.plugin,{columns:s}=t.highlight();return s.map((e=>this.highlightColumn(e,"highlighted")))}invalidateRowHover(e){e.forEach((e=>e()));const{model:t}=this.plugin,{rows:s}=t.highlight();return s.map((e=>this.highlightRow(e,"highlighted")))}invalidateCellHover(e){e.forEach((e=>e()));const{model:t,table:s}=this.plugin,{cell:n}=t.highlight();if(e=[],n){const{body:t}=s,{rowIndex:o,columnIndex:r}=n;e.push(this.highlightCell(t.cell(o,r),"highlighted"))}return e}invalidateSortBy(e){e.forEach((e=>e()));const{model:t}=this.plugin,s=t.sort().by;e=[];for(let t of s){const s=wn(t);e.push(this.highlightColumn(s,"sorted"))}return e}invalidateSelection(e){e.forEach((e=>e()));const{model:t}=this.plugin,{items:s}=t.selection(),n=this.selectionService.lookup(s);return this.cellSelector.map(n).map((e=>this.highlightCell(e,"selected")))}findColumnPosition(e){const{model:t}=this.plugin,{index:s}=t.columnList(),n=Gs(s,(t=>t.key.model.key===e));return n?Ks(n.node).map((e=>e.key.columnIndex)):[]}highlightColumn(e,t){const{table:s}=this.plugin,n=this.findColumnPosition(e);if(!n.length)return M;const{head:o,body:r,foot:i}=s;return Q.mutate((()=>{const e=1===n.length;for(let s of n){e&&(o.column(s).addClass(`q-grid-${t}`),o.column(s-1).addClass(`q-grid-${t}-prev`),o.column(s+1).addClass(`q-grid-${t}-next`));const n=r.column(s),c=n.model();c&&c.canHighlight&&(n.addClass(`q-grid-${t}`),i.column(s).addClass(`q-grid-${t}`))}})),this.blurColumn(e,t)}blurColumn(e,t){const{table:s}=this.plugin,n=this.findColumnPosition(e);if(!n.length)return M;const{head:o,body:r,foot:i}=s;return()=>{Q.mutate((()=>{for(let e of n)o.column(e).removeClass(`q-grid-${t}`),o.column(e-1).removeClass(`q-grid-${t}-prev`),o.column(e+1).removeClass(`q-grid-${t}-next`),r.column(e).removeClass(`q-grid-${t}`),i.column(e).removeClass(`q-grid-${t}`)}))}}highlightRow(e,t){const{table:s}=this.plugin;if(e<0)return M;const{body:n}=s;return Q.mutate((()=>n.row(e).addClass(`q-grid-${t}`))),this.blurRow(e,t)}blurRow(e,t){const{table:s}=this.plugin;if(e<0)return M;const n=s.body.row(e);return()=>Q.mutate((()=>n.removeClass(`q-grid-${t}`)))}highlightCell(e,t){return Q.mutate((()=>{e.addClass(`q-grid-${t}`)})),this.blurCell(e,t)}blurCell(e,t){return()=>Q.mutate((()=>{e.removeClass(`q-grid-${t}`)}))}}class wi{constructor(){this.columns=[],this.rows=[],this.cell=null}}class fi{constructor(e){this.text=e||"",this.peeks=[],this.position=0,this.length=this.text.length}static get eof(){}read(){const e=this.peeks;if(e.length>0)return e.pop();const t=this.position+1;if(t<this.length){const e=this.text[this.position];return this.position=t,e}return fi.eof}peek(){return this.peekCore(0)}peekPeek(){return this.peekCore(1)}peekCore(e){const t=this.peeks;if(e<t.length)return t[e];const s=this.length;for(let n=t.length;n<=e;n++){const e=this.position+1;if(e>=s)return fi.eof;const n=this.text[this.position];this.position=e,t.push(n)}return t[e]}seek(e){const t=this.peeks,s=t.length;for(t.splice(0,Math.Min(e,s)),e-=s;--e>=0;)this.read();return this.peek()}}class yi{constructor(e=","){this.delimiter=e}read(e){const t=new fi(e),s=this.delimiter,n=[];let o=[],r="";for(;;){const e=t.peek();if(" "!==e)if(e!==s)if("\n"!==e)if("\r"!==e||"\n"!==t.peekPeek()){if(e===fi.eof){t.read(),(o.length>0||r.length>0)&&(o.push(r),n.push(o));break}r='"'===e?this.readEscapedValue(t,r):this.readUnescapedValue(t,r)}else t.read(),t.read(),(o.length>0||r.length>0)&&(o.push(r),r=""),o.length>0&&(n.push(o),o=[]);else t.read(),(o.length>0||r.length>0)&&(o.push(r),r=""),o.length>0&&(n.push(o),o=[]);else t.read(),o.push(r),r="";else t.read()}return n.map(this.lineToObj)}readEscapedValue(e,t){let s=e.read();for(;s!==fi.eof;){if(s=e.read(),'"'===s){if('"'===e.peek()){t+=e.read();continue}break}t+=s}return t}readUnescapedValue(e,t){const s=this.delimiter;let n=e.peek();for(;n!==fi.eof&&n!==s&&"\n"!==n&&("\r"!==n||"\n"!==e.peekPeek());)t+=e.read(),n=e.peek();return t}lineToObj(e){const t={};for(let s=0,n=e.length;s<n;s++)t[s]=e[s];return t}}class bi{constructor(){this.resource=new $}}class vi{read(e){const t=JSON.parse(e);return r(t)?t:[t]}}const xi=1;class Ci{read(e){if(!e)return[];const t=(new DOMParser).parseFromString(e,"text/xml").documentElement,s=this.getStatistics(t),n=this.build(t,s,"root"),o=n[Object.keys(n)[0]];return r(o)?o:[o]}arrayFromChildren(e,t,s,n){const o=[],r=Array.from(e.children).filter((e=>e.nodeName===n));for(let e of r)o.push(this.buildNonArray(e,t,s));return o}build(e,t,s="root"){return t.get(s).isArray?this.arrayFromChildren(e.parentNode,t,s,e.nodeName):this.buildNonArray(e,t,s)}buildNonArray(e,t,s="root"){const n=t.get(s);if(n.isObject){const n={},o=new Set;for(let t of Array.from(e.attributes))n[t.name]=t.value;for(let r of Array.from(e.children)){const e=this.getPath(s,r.nodeName);o.has(e)||(o.add(e),n[r.nodeName]=this.build(r,t,e))}return n}return n.isText?e.textContent:null}info(e,t){return t||(t={isArray:!1,isObject:!1,isText:!1}),{isArray:t.isArray||Array.from(e.parentNode.children).filter((t=>t.nodeName===e.nodeName)).length>1,isObject:t.isObject||e.children.length>0||e.attributes.length>0,isText:t.isText||this.isTextContainer(e)}}getStatistics(e,t="root",s=new Map){s.set(t,this.info(e,s.get(t)));const n=Array.from(e.children);if(n.length>0)for(let e of n){const n=this.getPath(t,e.nodeName);this.getStatistics(e,n,s)}return s}isTextContainer(e){return e.nodeType===xi&&!e.children.length&&e.childNodes.length}getPath(...e){return e.join("/")}}class ki{static func(e,t=M,s=null){return(...n)=>{for(const o of e)s=t(s,o(...n));return s}}static command(e){return new js({source:"composite",canExecute:(...t)=>e.reduce(((e,s)=>e||s.canExecute(...t)),!1),execute:(...t)=>e.filter((e=>e.canExecute(...t))).reduce(((e,s)=>s.execute(...t)||e),void 0)})}static list(e){return e.reduce(((e,t)=>e.concat(t)),[])}static object(e,t={}){return Object.assign(t,...e)}}function Ei(){let e=!1;return t=>{if(e)return!1;e=!0;try{return t(),!0}finally{e=!1}}}class $i{constructor(){this.status="release",this.codes=[],this.code=null}}class Ri{constructor(){this.resource=new $}}class Ii{constructor(e){const{model:t,observeReply:s,disposable:n}=e,o=this.styleRow.bind(this);this.plugin=e,s(t.navigationChanged).subscribe((e=>{if(e.hasChanges("cell")){const{oldValue:t,newValue:s}=e.changes.cell,n=t?t.column:{},o=s?s.column:{};n.key!==o.key&&(n.viewWidth||o.viewWidth)&&Q.measure((()=>{const e=this.updateColumnForm();Q.mutate((()=>this.invalidateColumns(e)))}))}})),s(t.layoutChanged).subscribe((e=>{"layout.let"!==e.tag.source&&e.hasChanges("columns")&&Q.measure((()=>{const e=this.updateColumnForm();Q.mutate((()=>this.invalidateColumns(e)))}))})),s(t.rowChanged).subscribe((e=>{if(e.hasChanges("canResize")){const s=Array.from(t.style().rows);if(e.state.canResize)s.push(o);else{const e=t.style.rows.indexOf(o);s.splice(e,1)}t.style({rows:s},{source:"layout.let"})}})),s(t.dataChanged).subscribe((e=>{e.hasChanges("columns")&&t.layout({columns:new Map},{source:"layout.let",behavior:"core"})})),s(t.viewChanged).subscribe((e=>{if(e.hasChanges("columns")){const s=e=>null!==e.width||null!==e.minWidth||null!==e.maxWidth||"fit-head"===e.widthMode;os(e.state.columns).some(s)&&Q.mutate((()=>{const{columns:e}=t.layout();this.invalidateColumns(e)}))}})),n.add((()=>{Cs(this.gridId,"column-layout").remove()}))}updateColumnForm(){const{model:e,table:t}=this.plugin,{head:s}=t,{cells:n}=s.context.bag,o=e.layout().columns,r=new Map;for(let e of n){const{column:t,rowIndex:n,columnIndex:i}=e;if(!t.canResize)continue;const{key:c}=t;if(o.has(c)){const{width:e}=o.get(c);r.set(c,{width:e})}else{const e=s.cell(n,i).width();e&&r.set(c,{width:e})}}e.layout({columns:r},{source:"layout.let",behavior:"core"});const i=ir(e.navigation());if(i&&i.viewWidth){const e=new Map(r),t=r.get(i.key);return e.set(i.key,{width:t?Math.max(t.width,i.viewWidth):i.viewWidth}),e}return r}invalidateColumns(e){ce.info("layout","invalidate columns");const{table:t}=this.plugin,s=t.data.columns(),n=hs(t,e),o={};let{length:r}=s;for(;r--;){const e=s[r],t=n(e.key);if(null!==t){const s=t+"px",n={width:s,"min-width":s,"max-width":s};o[`.q-grid-the-${Es(e.key)}`]=n}}Cs(this.gridId,"column-layout").set(o)}styleRow(e,t){const{model:s}=this.plugin,{layout:n}=s,o=n().rows.get(e);if(o){const{minHeight:e}=s.row();if(e>o.height)return;t.class(`resized-${o.height}px`,{height:o.height+"px"})}}get gridId(){return this.plugin.model.grid().id}}class Oi{constructor(){this.columns=new Map,this.rows=new Map}}class Fi{constructor(e,t){this.host=e,this.plugin=t}canWrite(e,t,s){return m(t)?(ce.warn("model.bind",`can't write undefined to the model[${s}]`),!1):!r(e)||null!==t||(ce.warn("model.bind",`the model[${s}] expects array, got ${t}`),!1)}bound(e,t,s=!0,n=!0){if(e){const o=[];for(let r of t){const t=e[r],i=this.packFactory(r),c=this.writeFactory(r);if(s){const e=t(),s=i(e);c({changes:this.buildChanges(s)})}n&&this.disposable.add(e[r+"Changed"].on(c)),o.push((()=>{ce.info("model.bind",`to model "${r}"`);const e=t(),s=i(e);t(s)}))}return()=>o.forEach((e=>e()))}return M}writeFactory(e){const t=this.host;return s=>{const n=Object.keys(s.changes);for(let o of n){const n=A(e,o);if(t.hasOwnProperty(n)){const e=s.changes[o];t[n]=e.newValue}}}}packFactory(e){return t=>{const s=this.host,n={};for(let o of Object.keys(t)){const r=A(e,o);if(s.hasOwnProperty(r)){const e=t[o],i=s[r];this.canWrite(e,i,o)&&(n[o]=i)}}return n}}buildChanges(e){return Object.keys(e).reduce(((t,s)=>{const n=e[s];return t[s]={newValue:n,oldValue:n},t}),{})}}class qi{constructor(){this.status="release",this.code=null,this.target=null,this.timestamp=(new Date).getMilliseconds()}}class Li{constructor(){this.cell=null,this.shortcut={up:"up",down:"down",left:"left",right:"right",next:"tab",previous:"shift+tab",home:"home",end:"end",pageUp:"pageUp",pageDown:"pageDown",upward:"shift+pageUp",downward:"shift+pageDown"},this.go=new js({source:"navigation.model"}),this.prevent=new Set(["space","shift+space","up","down","left","right","home","end","pageUp","pageDown","shift+pageDown","shift+pageUp"])}}class Si{constructor(){this.resource=new $,this.current=0,this.size=50,this.sizeList=[5,10,20,30,40,50],this.count=0,this.mode="showPages",this.resetTriggers={filter:["by"],pivot:["by"],group:["by"]},this.shortcut={prev:"alt+pageup",next:"alt+pagedown"}}}function Mi(e,t){return t instanceof Map?{type:"map",value:Array.from(t.entries())}:t instanceof Set?{type:"set",value:Array.from(t.values())}:t}function Ti(e,t){if("object"==typeof t&&null!==t){if("map"===t.type)return new Map(t.value);if("set"===t.type)return new Set(t.value)}return t}const ji=e=>JSON.stringify(e,Mi),Ni=e=>JSON.parse(e,Ti);class Ai{constructor(e){this.storage=e}getItem(e){return new Promise((t=>{t(Ni(this.storage.getItem(e)))}))}setItem(e,t){return new Promise((s=>{s(this.storage.setItem(e,ji(t)))}))}}class Pi{constructor(){this.id="default",this.defaultGroup="My Presets",this.schedule="onDemand",this.load=new js({source:"persistence.model"}),this.remove=new js({source:"persistence.model"}),this.create=new js({source:"persistence.model"}),this.modify=new js({source:"persistence.model"}),this.setDefault=new js({source:"persistence.model"}),this.reset=new js({source:"persistence.model"}),this.storage=new Ai(localStorage),this.settings={group:["by"],sort:["by"],pivot:["by"],filter:["by"],queryBuilder:["node"],pagination:["current","size"],layout:["columns"]}}}class Vi{constructor(){this.reduce=(e,t)=>{const s=t.data().pipe,n=e.indexOf(Zn.default);n>=0&&(e[n]=s),e=b(e);const o=new Set(e),r=new Map([[Zn.default,s],[Zn.view,Zn.default],[Zn.column,Zn.view]]);return e.reduce(((e,t)=>((e=>{let t;for(;(t=r.get(e))&&t!==e;){if(o.has(t))return!1;e=t}return!0})(t)&&e.push(t),e)),[])},this.triggers={data:{rows:Zn.default,columns:Zn.column},pagination:{current:Zn.default,size:Zn.default},fetch:{skip:Zn.default},sort:{by:Zn.default},filter:{by:Zn.default,match:Zn.default,custom:Zn.default,unit:Zn.column},group:{by:Zn.default},pivot:{by:Zn.default},columnList:{index:Zn.columnIndex},row:{status:Zn.rowDetails,unit:Zn.rowDetails,canMove:Zn.column,canResize:Zn.column},rowList:{index:Zn.row},animation:{rows:Zn.default}},this.effect={}}}class Di{constructor(){this.resource=new $,this.by=[]}}class zi{constructor(){this.resource=new $,this.imports={}}}class Bi{constructor(){this.resource=new $,this.isBusy=!1,this.queue=[]}}function Hi(e){const t=e.pagination(),s=e.sort(),n=e.filter();return{order:s.by.map((e=>{const t=Object.keys(e)[0];return`${"asc"===e[t]?"+":"-"}${t}`})).join(","),filter:Object.keys(n.by).map((e=>{const t=n.by[e];return"$expression"===e?`$expression=where:${t}`:t.items?`${e}=in:${t.items.join(",")}`:t.expression?`${e}=where:${t.expression}`:""})).filter((e=>!!e)).join(";"),skip:t.current*t.size,take:t.size}}class Wi{constructor(){this.url="",this.method="get",this.serialize=Hi}}class Ui{constructor(){this.index=new Map}}class _i{constructor(){this.resource=new $,this.mode="single",this.unit="data",this.height=e=>e&&e.offsetHeight||64,this.status=new Map,this.shortcut={toggle:"space|enter"},this.canMove=!1,this.canResize=!1,this.minHeight=0,this.pinTop=[],this.pinBottom=[],this.toggle=new js}}class Ki{constructor(){this.status="idle",this.rows=[],this.column={rows:[],line:[],area:{left:[],mid:[],right:[]}}}}class Gi{constructor(){this.mode="default",this.top=0,this.left=0,this.cursor=0,this.map={rowToView:N,viewToRow:N},this.resetTriggers=["sort.view","column.filter.view","data.manipulation"]}}class Ji{constructor(){this.resource=new $,this.unit="cell",this.mode="single",this.items=[],this.area="body",this.toggle=new js({source:"selection.model"}),this.rowKey=N,this.columnKey=N,this.shortcut={toggleRow:"shift+space|space",togglePreviousRow:"shift+up",toggleNextRow:"shift+down",toggleColumn:"ctrl+space",toggleNextColumn:"shift+right",togglePreviousColumn:"shift+left",selectAll:"ctrl+a"}}}class Yi{constructor(){this.resource=new $,this.by=[],this.mode="mixed",this.trigger=[]}}class Xi{constructor(){this.row=M,this.cell=M,this.rows=[],this.cells=[],this.classList=[],this.invalidate=new js({source:"style.model",canExecute:e=>"view"===e.model.edit().status})}}class Zi{constructor(){this.resource={}}}class Qi{constructor(){this.resource=new $}}class ec{constructor(){this.resource=new $,this.rules=[]}}class tc{constructor(){this.rows=[],this.columns=[],this.nodes=[],this.pivot={head:new le("$root",0),rows:[]}}}class sc{constructor(){this.resource=new $,this.head=!0,this.foot=!0,this.body=!0,this.toolbar={top:!0,bottom:!0,right:!1,left:!1},this.pin={left:!1,right:!1,top:!1,bottom:!1},this.plugin={}}}class nc{constructor(){this.state={},this.register("action",X).register("animation",Z).register("body",ys).register("clipboard",As).register("columnList",sn).register("data",Qn).register("drag",_o).register("edit",dr).register("export",yr).register("fetch",Sr).register("filter",jr).register("focus",Dr).register("foot",Hr).register("grid",Yr).register("group",ti).register("head",ui).register("highlight",wi).register("import",bi).register("keyboard",$i).register("layer",Ri).register("layout",Oi).register("mouse",qi).register("navigation",Li).register("pagination",Si).register("persistence",Pi).register("pipe",Vi).register("pivot",Di).register("plugin",zi).register("progress",Bi).register("rest",Wi).register("row",_i).register("rowList",Ui).register("scene",Ki).register("scroll",Gi).register("selection",Ji).register("sort",Yi).register("style",Xi).register("template",Zi).register("toolbar",Qi).register("validation",ec).register("view",tc).register("visibility",sc)}register(e,t){if(this.state.hasOwnProperty(e))throw new oe("model",`"${e}" is already registered`);if(!a(t))throw new oe(`model.${e}`,`"${t}" is not a valid type, should be an constructor function`);return this.state[e]=t,this}build(){const{state:e}=this,t=new Et;for(let s of Object.keys(e)){const n=e[s];t.inject(s,n)}return t}}const oc=0,rc=1,ic=2,cc=3;function lc(e,t){return ac(e)===t}function ac(e){return e.which}function uc(e){switch(e){case 1:return"left";case 3:return"right";case 2:return"middle";default:return null}}class hc{constructor(e,t){this.model=e,this.table=t}position(e,t){const s=this.table,n=s.body,o=this.lastRow,r=s.view.scrollHeight()-s.view.height();let i=0,c=0;for(;i<=o&&c<=e;)c+=n.row(i).height(),i++;"down"===t&&n.row(i)&&(c-=n.row(i).height(),i--);const l=Math.max(this.firstRow,Math.min(o,i));return c=Math.min(c,r),{row:l,offset:c}}goTo(e,t,s="navigation"){let n=this.cell(e,t);return n||(n=this.cell(e,this.firstColumn)),this.model.navigation({cell:n},{source:s}),!0}columns(e){const t=this.table.body.columns(e),s=[];for(let e=0,n=t.length;e<n;e++){const n=t[e];n.model().canFocus&&s.push(n.index)}return s}get currentColumn(){const e=this.columns(this.currentRow),t=cr(this.model.navigation()),s=e.indexOf(t);return e.length?e[Math.max(s,0)]:-1}get nextColumn(){const e=this.columns(this.currentRow),t=e.indexOf(this.currentColumn);return t>=0&&t<e.length-1?e[t+1]:-1}get prevColumn(){const e=this.columns(this.currentRow),t=e.indexOf(this.currentColumn);return t>0&&t<e.length?e[t-1]:-1}get lastColumn(){const e=this.columns(this.currentRow),t=e.length-1;return t>=0?e[t]:-1}get firstColumn(){const e=this.columns(this.currentRow);return e.length?e[0]:-1}get currentRow(){const e=lr(this.model.navigation());return e<0?this.model.scene().rows.length?0:-1:e}get nextRow(){const e=this.currentRow+1;return e<=this.lastRow?e:-1}get prevRow(){const e=this.currentRow-1;return e>=0?e:-1}get firstRow(){return Math.min(0,this.lastRow)}get lastRow(){return this.table.body.rowCount(this.currentColumn)-1}cell(e,t){const s=this.table.body.cell(e,t).model();if(s){const{row:n,column:o}=s;return{rowIndex:e,columnIndex:t,row:n,column:o}}return null}context(e,t){const s=this.model,n=this.currentRow,o=this.currentColumn,r=s.action().shortcut.keyCode;return Object.assign({model:s,type:e,oldRow:n,oldColumn:o,keyCode:r},t)}get commands(){const{model:e,table:t}=this,{edit:s}=e,{shortcut:n,go:o}=e.navigation(),r=()=>{if("view"===s().status)return!0;const e=t.body.column(this.currentColumn).model();return e&&("focus"===e.editorOptions.trigger||"transparent"===e.editorOptions.cruise)},i={goDown:new js({source:"navigation",shortcut:n.down,canExecute:()=>{if(r()){const e=this.nextRow;return e>=0&&o.canExecute(this.context("down",{newRow:e}))}return!1},execute:()=>{const e=this.nextRow,t=this.currentColumn;return o.execute(this.context("down",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),goUp:new js({source:"navigation",shortcut:n.up,canExecute:()=>{if(r()){const e=this.prevRow;return e>=0&&o.canExecute(this.context("up",{newRow:e}))}return!1},execute:()=>{const e=this.prevRow,t=this.currentColumn;return o.execute(this.context("up",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),goRight:new js({source:"navigation",shortcut:n.right,canExecute:()=>{if(r()){const e=this.nextColumn;return e>=0&&o.canExecute(this.context("right",{newColumn:e}))}return!1},execute:()=>{const e=this.currentRow,t=this.nextColumn;return o.execute(this.context("right",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),goLeft:new js({source:"navigation",shortcut:n.left,canExecute:()=>{if(r()){const e=this.prevColumn;return e>=0&&o.canExecute(this.context("left",{newColumn:e}))}return!1},execute:()=>{const e=this.currentRow,t=this.prevColumn;return o.execute(this.context("left",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),goNext:new js({source:"navigation",shortcut:n.next,canExecute:()=>{const e=this.nextRow,t=this.nextColumn;return(t>=0||e>=0)&&o.canExecute(this.context("next",{newRow:e,newColumn:t}))},execute:()=>{const e=this.nextColumn,t=e>=0,s=t?this.currentRow:this.nextRow,n=t?e:this.firstColumn;return o.execute(this.context("next",{newRow:s,newColumn:n}))&&this.goTo(s,n)}}),goPrevious:new js({source:"navigation",shortcut:n.previous,canExecute:()=>{const e=this.prevColumn,t=this.prevRow;return(e>=0||t>=0)&&o.canExecute(this.context("previous",{newRow:t,newColumn:e}))},execute:()=>{const e=this.prevColumn,t=e>=0,s=t?e:this.lastColumn,n=t?this.currentRow:this.prevRow;return o.execute(this.context("previous",{newRow:n,newColumn:s}))&&this.goTo(n,s)}}),home:new js({source:"navigation",shortcut:n.home,canExecute:()=>{if(r()){const e=this.prevColumn;return e>=0&&o.canExecute(this.context("end",{newColumn:e}))}return!1},execute:()=>{const e=this.currentRow,t=this.firstColumn;return o.execute(this.context("home",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),end:new js({source:"navigation",shortcut:n.end,canExecute:()=>{if(r()){const e=this.nextColumn;return e>=0&&o.canExecute(this.context("home",{newColumn:e}))}return!1},execute:()=>{const e=this.currentRow,t=this.lastColumn;return o.execute(this.context("end",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),upward:new js({source:"navigation",shortcut:n.upward,canExecute:()=>{if(r()){const e=this.prevRow;return e>=0&&o.canExecute(this.context("upward",{newRow:e}))}return!1},execute:()=>{const e=this.firstRow,t=this.currentColumn;return o.execute(this.context("upward",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),downward:new js({source:"navigation",shortcut:n.downward,canExecute:()=>{if(r()){const e=this.nextRow;return e>=0&&o.canExecute(this.context("downward",{newRow:e}))}return!1},execute:()=>{const e=this.lastRow,t=this.currentColumn;return o.execute(this.context("downward",{newRow:e,newColumn:t}))&&this.goTo(e,t)}}),pageUp:new js({source:"navigation",shortcut:n.pageUp,canExecute:()=>{if(r()){const e=this.prevRow;return e>=0&&o.canExecute(this.context("pageUp",{newRow:e}))}return!1},execute:()=>{const e=t.view,s=this.position(e.scrollTop()-e.height(),"up"),n=s.row,r=this.currentColumn;return!!o.execute(this.context("pageUp",{newRow:n,newColumn:r}))&&(this.model.scroll({top:s.offset},{source:"navigation"}),this.goTo(n,r,"navigation.scroll"))}}),pageDown:new js({source:"navigation",shortcut:n.pageDown,canExecute:()=>{if(r()){const e=this.nextRow;return e>=0&&o.canExecute(this.context("pageDown",{newRow:e}))}return!1},execute:()=>{const e=t.view,s=this.position(e.scrollTop()+e.height(),"down"),n=s.row,r=this.currentColumn;return!!o.execute(this.context("pageDown",{newRow:n,newColumn:r}))&&(this.model.scroll({top:s.offset},{source:"navigation"}),this.goTo(s.row,this.currentColumn,"navigation.scroll"))}})};return new Map(Object.entries(i))}}class dc{constructor(e,t){const{model:s,table:n,observeReply:o}=e;this.plugin=e;const r=new hc(s,n);let i=[];t.register(r.commands),this.focus=new js({source:"navigation.view",canExecute:e=>{const{cell:t}=s.navigation();return!(!e||!e.column.canFocus||mo.equals(e,t))},execute:e=>{const{rowIndex:t,columnIndex:o,behavior:r}=e,i=n.body.cell(t,o).model();if(i){const{row:e,column:n}=i;s.navigation({cell:{rowIndex:t,columnIndex:o,row:e,column:n}},{source:"navigation.view",behavior:r})}else s.navigation({cell:null},{source:"navigation.view",behavior:r})}}),this.scrollTo=new js({source:"navigation.view",execute:(e,t)=>{const s=n.body.cell(e,t);this.scroll(n.view,s)},canExecute:(e,t)=>null!==n.body.cell(e,t).model()}),o(s.navigationChanged).subscribe((e=>{if(e.hasChanges("cell")){"core"!==e.tag.behavior&&(n.view.isFocused()||n.view.focus());const t=lr(e.state),o=cr(e.state);i=this.invalidateFocus(i),"navigation.scroll"!==e.tag.source&&"core"!==e.tag.behavior&&this.scrollTo.canExecute(t,o)&&this.scrollTo.execute(t,o),s.focus({rowIndex:t,columnIndex:o},{source:"navigation.view"})}})),o(s.focusChanged).subscribe((e=>{if("navigation.view"!==e.tag.source){if(e.hasChanges("isActive")){const{view:t}=n,s="q-grid-active";e.state.isActive?(Q.mutate((()=>t.addClass(s))),t.focus()):Q.mutate((()=>t.removeClass(s)))}(e.hasChanges("rowIndex")||e.hasChanges("columnIndex"))&&this.focus.execute(e.state)}})),o(s.sceneChanged).subscribe((e=>{if(e.hasChanges("status")){const{status:t}=e.state;switch(t){case"stop":{const e=s.navigation(),t=lr(e),o=cr(e);if(t>=0&&o>=0){let e=n.body.cell(t,o).model();this.focus.execute({rowIndex:e?e.rowIndex:-1,columnIndex:e?e.columnIndex:-1,behavior:"core"})}break}}}}))}invalidateFocus(e){const{model:t,table:s}=this.plugin;e.forEach((e=>e())),e=[];const n=lr(t.navigation()),o=cr(t.navigation()),r=s.body.cell(n,o);if(r.model()){const t=s.body.row(n);Q.mutate((()=>{r.addClass("q-grid-focused"),t.addClass("q-grid-focused")})),e.push((()=>Q.mutate((()=>{r.removeClass("q-grid-focused"),t.removeClass("q-grid-focused")}))))}return e}scroll(e,t){const{model:s}=this.plugin,{scroll:n}=s;Q.measure((()=>{const s=t.rect(),o=e.rect("body-mid"),r={};e.canScrollTo(t,"left")&&(o.left>s.left||o.left>s.right||o.right<s.left||o.right<s.right)&&(o.width<s.width||o.left>s.left||o.left>s.right?r.left=s.left-o.left+n().left:(o.left<s.left||o.right<s.right)&&(r.left=s.right-o.right+n().left)),e.canScrollTo(t,"top")&&(o.top>s.top||o.top>s.bottom||o.bottom<s.top||o.bottom<s.bottom)&&(o.height<s.height||o.top>s.top||o.top>s.bottom?r.top=s.top-o.top+n().top:(o.top<s.top||o.bottom<s.bottom)&&(r.top=s.bottom-o.bottom+n().top)),Object.keys(r).length&&n(r,{behavior:"core",source:"navigation.view"})}))}}class mc{constructor(e){const{model:t,observe:s}=e,{resetTriggers:n}=t.pagination();Object.keys(n).forEach((e=>s(t[e+"Changed"]).subscribe((s=>{if("core"===s.tag.behavior)return;if("virtual"===t.scroll().mode)return;const o=n[e];for(const e of o)s.hasChanges(e)&&t.pagination({current:0},{source:s.tag.source||"pagination.view"})}))))}get current(){return this.plugin.model.pagination().current}get size(){return this.plugin.model.pagination().size}}class gc{constructor(e,t){this.model=e,this.createDefaultModel=t}save(e){const s=this.model;e=e||s.persistence().settings;const n={};for(const o in e){const r=s[o](),i={};n[o]=i;for(const s of e[o]){const e=r[s];i[s]=t(e)}}return n}load(e,t){const s=this.model;t=t||s.persistence().settings;for(const n in t){const t=e[n];if(t){(0,s[n])(t,{source:"persistence.service"})}}return e}reset(e){const t=this.createDefaultModel(),s=this.model;e=e||s.persistence().settings;const n={};for(let o in e){n[o]={};const r=t[o],i=s[o];for(const t of e[o])n[o][t]=r()[t];i(n[o],{source:"persistence.service"})}return n}}class pc{constructor(e){this.model=e}resolve(e){const t=this.model.plugin().imports[e];if(!t)switch(e){case"xlsx":throw new oe("plugin.service","To use export plugin for xlsx format please add http://github.com/SheetJS/js-xlsx library to your project");case"fileSaver":throw new oe("plugin.service","To use export plugin for file saving please add https://github.com/eligrey/FileSaver.js library to your project");case"pdf":throw new oe("plugin.service","To use export plugin for pdf format please add https://github.com/MrRio/jsPDF and https://github.com/simonbengtsson/jsPDF-AutoTable libraries to your project");default:throw new oe("import library",`Can't find ${e} library in imports`)}return t}}function wc(e,t){const s=e.data,n=e.scope;if(e instanceof Br){let o=1,r=e.count;const i=t;for(;s.hasOwnProperty(t);)t=i+o++;return r<o&&(r=o),(e,o)=>(s[t]=e,Object.keys(o).length&&(n[t]=o),new Br(s,n,r))}return(e,o)=>(s[t]=e,Object.keys(o).length&&(n[t]=o),new $(s,n))}function fc(e){const t=e.pagination(),s=e.sort();return{filter:e.filter().by,order:s.by.map((e=>{const t=Object.keys(e)[0];return("asc"===e[t]?"+":"-")+t})),skip:t.current*t.size,take:t.size}}class yc{constructor(e,t){const{model:s,observeReply:n,observe:o,disposable:r}=e;let i;this.plugin=e,this.toggleStatus=new js({source:"row.details.view",execute:e=>{e||(e=rr(s.navigation()));const{toggle:t,status:n,mode:r}=s.row();if(!1!==t.execute({row:e})){const t=Kn([e],n,r);s.row({status:t},{source:"row.details.view"}),o(s.sceneChanged).pipe(Ar((e=>e.hasChanges("status")&&"stop"===e.state.status)),Nr()).subscribe((n=>{const o=t.get(e);if(o&&o.expand){const t=s.view().rows.indexOf(e);s.focus({rowIndex:t+1},{source:"row.details.let"})}}))}},canExecute:e=>{if(!e){const{cell:t}=s.navigation();t&&"row-expand"===t.column.type&&(e=t.row)}const{toggle:t}=s.row();return!!e&&t.canExecute({row:e})},shortcut:s.row().shortcut.toggle}),n(s.sceneChanged).subscribe((e=>{if("row.details.view"!==e.tag.source&&e.hasChanges("rows")){const{status:e,mode:t}=s.row(),n=_n(s.data().rows,e,t);s.row({status:n},{source:"row.details.view"})}}));const c=()=>{i&&(i.unsubscribe(),i=null)};r.add(c),n(s.rowChanged).subscribe((e=>{if(e.hasChanges("toggle")){const{toggle:t}=e.state;c(),i=t.canExecuteCheck.subscribe((()=>{this.toggleStatus.canExecuteCheck.next()}))}})),t.register([this.toggleStatus])}status(e){if(e instanceof ae)return null;const{model:t}=this.plugin,{status:s}=t.row(),n=s.get(e);return n&&n.expand?"expand":"collapse"}}class bc{constructor(e,t){const{model:s,table:n,observe:o}=e;this.plugin=e,this.tagName=t;const r=new si(n.box.bag.body);this.drop=new js({source:"row.view",canExecute:e=>{if("end"===e.action)return!0;return!!r.row(ii(e))},execute:e=>{const t=e.dragData;switch(e.action){case"over":{const o=r.row(ii(e));if(!e.inAreaY(o.element))return;const i=o.index;if(t!==i){n.body.row(t).removeClass("q-grid-drag");n.body.row(i).addClass("q-grid-drag");const o=n.body.row(t).model(),r=[];for(let e of s.rowList().index.entries()){const s=e[1];t<s&&s<=i?e[1]=s-1:t>s&&s>=i&&(e[1]=s+1),r.push(e)}const c=new Map(r),{rowId:l}=s.data(),a=l(i,o.model);c.set(a,i),s.rowList({index:c},{source:"row.view"}),e.dragData=i}break}case"drop":case"end":n.body.row(t).removeClass("q-grid-drag");break}}}),this.drag=new js({source:"row.view",execute:e=>{const t=e.data,s=n.body.row(t);s.addClass("q-grid-drag");const o=s.model();if(o)return o.element},canExecute:e=>{if(u(e.data)){const t=e.data;return t>=0&&s.scene().rows.length>t}return!1}}),this.resize=new js({source:"row.view"}),o(s.dataChanged).subscribe((e=>{e.hasChanges("rows")&&s.rowList({index:new Map},{source:"row.view",behavior:"core"})}))}get canMove(){const{model:e}=this.plugin;return e.row().canMove}get canResize(){const{model:e}=this.plugin;return e.row().canResize}}class vc{constructor(e,t){const{model:s,observeReply:n,service:o}=e,{scroll:r,row:i,pagination:c,fetch:l,pipe:u}=s;this.plugin=e;const h=i().height,d={threshold:c().size,resetTriggers:[]};(h>0||a(h))&&(d.rowHeight=h),this.y=t.factory(d),this.y.container.read=Q.measure,this.y.container.write=Q.mutate;const m=(this.y.container.draw$.on||this.y.container.draw$.subscribe).bind(this.y.container.draw$),g=()=>{const{effect:e}=u();if(e.hasOwnProperty("memo")){const t=e.memo.length;return c({count:t},{source:"scroll.view",behavior:"core"}),t}return c().count};switch(m((e=>{const{position:t}=e;(e=>{const{size:t,current:s,count:n}=c(),o=0===t?0:n-1<=e+t?Math.ceil(n/t)-1:Math.floor((e+t/2)/t);o!==s&&c({current:o},{source:"scroll.view",behavior:"core"})})(t),r({cursor:t},{source:"scroll.view",behavior:"core"})})),r().mode){case"virtual":{let e;this.y.settings.fetch=(e,t,s)=>{if(l({skip:e},{source:"scroll.view",behavior:"core"}),0===e){const e=g();s.resolve(e)}else o.invalidate({source:"scroll.view",why:"refresh"}).then((()=>{const e=g();s.resolve(e)}))};const t=new Set(r().resetTriggers);n(s.sceneChanged).subscribe((s=>{if(s.hasChanges("status")){const{status:n}=s.state;switch(n){case"start":e=s.tag.source,t.has(e)&&l({skip:0},{source:"scroll.view",behavior:"core"});break;case"stop":t.has(e)&&this.y.container.reset()}}}));break}default:n(s.paginationChanged).subscribe((e=>{"core"!==e.tag.behavior&&this.y.container.reset()}))}n(s.scrollChanged).subscribe((e=>{if("scroll.view"!==e.tag.source){if(e.hasChanges("mode"))switch(e.state.mode){case"virtual":r({map:{rowToView:e=>e-this.y.container.position,viewToRow:e=>e+this.y.container.position}},{source:"scroll.view",behavior:"core"});break;case"default":r({map:{rowToView:N,viewToRow:N}})}(e.hasChanges("left")||e.hasChanges("top"))&&this.invalidate()}}))}invalidate(){ce.info("layout","invalidate scroll");const{model:e,table:t}=this.plugin,{view:s}=t,{left:n,top:o}=e.scroll();Q.mutate((()=>{s.scrollLeft(n),s.scrollTop(o)}))}get mode(){return this.plugin.model.scroll().mode}}class xc extends an{constructor(e,t){super(t),this.model=e}filter(e){if("edit"===this.model.edit().status){const{cell:e}=this.model.navigation();if(e&&"select"!==e.column.type)return[]}return super.filter(e)}}class Cc{constructor(e){this.model=e}build(){const e={row:this.buildRows.bind(this),column:this.buildColumns.bind(this),cell:this.buildCells.bind(this),mix:this.buildMix.bind(this)},t=this.model;return(...s)=>{const n=t.selection(),o=e[n.unit];if(!o)throw new oe("range.builder",`Invalid unit ${n.unit}`);return o(...s)}}buildRows(e,t){const s=this.model,{rows:n}=s.scene();if(!t)return[n[e.rowIndex]];const o=Math.min(e.rowIndex,t.rowIndex),r=Math.max(e.rowIndex,t.rowIndex);return n.slice(o,r+1)}buildColumns(e,t){if(!t)return[e.column];const s=this.model.columnList().line,n=Math.min(e.columnIndex,t.columnIndex),o=Math.max(e.columnIndex,t.columnIndex);return s.slice(n,o+1)}buildCells(e,t){if(!t)return[{column:e.column,row:e.row}];const s=this.model,{rows:n}=s.scene(),{columns:o}=s.view(),r=Math.min(e.rowIndex,t.rowIndex),i=Math.max(e.rowIndex,t.rowIndex),c=Math.min(e.columnIndex,t.columnIndex),l=Math.max(e.columnIndex,t.columnIndex),a=n.slice(r,i+1),u=o.slice(c,l+1),h=[];return a.forEach((e=>{u.filter((e=>"data"===e.category)).forEach((t=>{h.push({column:t,row:e})}))})),h}buildMix(e,t){const s="row-indicator"===e.column.type?"row":"cell";return("row"===s?this.buildRows(e,t):this.buildCells(e,t)).map((e=>({item:e,unit:s})))}}class kc{constructor(e,t){this.model=e,this.service=t}select(e,t=!0,s){if(s=s||this.keyFactory(),r(e))e.forEach((e=>this.select(e,t,s)));else{if(e instanceof le){const{rows:n}=this.model.data();if(n.length)return void e.rows.forEach((e=>this.select(n[e],t,s)))}this.selectCore(e,t,s)}}canSelect(e){return this.canSelectCore(e)}toggle(e){const t=this.state(e);return this.select(e,null===t||!t)}state(e,t){if(t=t||this.keyFactory(),r(e)){return!!e.every((e=>this.state(e,t)))||!!e.some((e=>this.state(e,t)))&&null}if(e instanceof le){const{rows:s}=this.model.data();if(s.length){const n=e.rows.length&&e.rows.every((e=>this.state(s[e],t)));return!!n||!!e.rows.some((e=>this.state(s[e],t)))&&null}}return this.stateCore(e,t)}stateAll(e){if(!e.length)return!1;const t=this.keyFactory(),s=e.findIndex((e=>!1===this.state(e,t)));return s<0||(0===s?!e.every((e=>!1===this.state(e,t)))&&null:null)}keyFactory(){return this.service.hashFactory()}clear(){this.clearCore()}entries(){return[]}selectCore(){}clearCore(){}stateCore(){return!1}canSelectCore(){return!0}}class Ec extends kc{constructor(e,t){super(e,t),this.item=null}entries(){return this.item?[this.item]:[]}selectCore(e,t){this.item=t?e:null}stateCore(e,t){return null!==this.item&&t(e)===t(this.item)}clearCore(){this.item=null}}class $c extends kc{constructor(e,t){super(e,t),this.item=null}entries(){return this.item?[this.item]:[]}selectCore(e,t){t&&(this.item=e)}canSelectCore(e){return e!==this.item}stateCore(e,t){return null!==this.item&&t(e)===t(this.item)}clearCore(){this.item=null}}class Rc extends kc{constructor(e,t){super(e,t),this.items=new Map}entries(){return Array.from(this.items.values())}selectCore(e,t,s){t?this.items.set(s(e),e):this.items.delete(s(e))}stateCore(e,t){return this.items.has(t(e))}clearCore(){this.items=new Map}}class Ic extends Rc{constructor(e,t){super(e,t)}select(e,t=!0){r(e)&&this.clear(),super.select(e,t)}}function Oc(e,t){const s=e.selection().mode;switch(s){case"single":return new Ec(e,t);case"singleOnly":return new $c(e,t);case"multiple":return new Rc(e,t);case"range":return new Ic(e,t);default:throw new oe("selection.state.factory",`Invalid selection mode "${s}"`)}}class Fc{constructor(e,t){const{model:s,table:n,observeReply:o}=e;this.plugin=e,this.selectionService=new gi(s),this.form=Oc(s,this.selectionService),this.selectionRange=new Cc(s);const r=this.getCommands();t.register(r),this.toggleRow=r.get("toggleRow"),this.toggleColumn=r.get("toggleColumn"),this.toggleCell=r.get("toggleCell"),this.reset=r.get("reset"),this.stateCheck=new Ms,o(s.navigationChanged).subscribe((e=>{"selection.view"!==e.tag.source&&e.hasChanges("cell")&&this.toggleCell.canExecute(e.state.cell)&&this.toggleCell.execute(e.state.cell)}));const i=`q-grid-select-${s.selection().mode}`,c=`q-grid-select-${s.selection().unit}`,{view:l}=n;l.addClass(i),l.addClass(c),o(s.selectionChanged).subscribe((e=>{if(e.hasChanges("mode")){const t=`q-grid-select-${e.state.mode}`,s=`q-grid-select-${e.changes.mode.oldValue}`;l.removeClass(s),l.addClass(t)}if(e.hasChanges("unit")){const t=`q-grid-select-${e.state.unit}`,s=`q-grid-select-${e.changes.unit.oldValue}`;l.removeClass(s),l.addClass(t)}if((e.hasChanges("unit")||e.hasChanges("mode"))&&(e.hasChanges("items")||(this.form.clear(),s.selection().items.length&&s.selection({items:[]},{source:"selection.view"}),this.form=Oc(s,this.selectionService))),e.hasChanges("items")){if("selection.view"!==e.tag.source){const t=this.selectionService.lookup(e.changes.items.oldValue);this.select(t,!1);const s=this.selectionService.lookup(e.state.items);this.select(s,!0)}this.stateCheck.next(e.state.items)}})),o(s.dataChanged).subscribe((e=>{const{unit:t,items:n}=s.selection(),o=e.hasChanges("rows")&&("row"===t||"mix"===t||"cell"===t),r=e.hasChanges("columns")&&("column"===t||"mix"===t||"cell"===t);if(o||r){this.form.clear();const e=this.selectionService.lookup(n);this.select(e,!0)}}))}getCommands(){const{model:e,table:t}=this.plugin,{shortcut:s}=e.selection(),n=new js({source:"selection.view",canExecute:()=>{const t=lr(e.navigation()),s=this.rows[t>=0?t:t+1];return!!this.form.canSelect(s)&&("row"===e.selection().unit&&this.rows.length>0)},execute:()=>{const t=lr(e.navigation()),s=this.rows[t>=0?t:t+1];this.toggle(s)()},shortcut:s.toggleRow}),o={toggleCell:new js({source:"selection.view",canExecute:t=>{const s=e.selection();return t&&"range"!==s.mode&&("cell"===s.unit||"mix"===s.unit)},execute:(t,s)=>{switch(e.selection().unit){case"cell":this.toggle(t,s)();break;case"mix":if("row-indicator"===t.column.type){this.toggle({item:t.row,unit:"row"},s)();break}this.toggle({item:t,unit:"cell"},s)();break}}}),toggleRow:new js({source:"selection.view",execute:(e,t)=>{this.toggle(e,t)()},canExecute:t=>{if(!this.form.canSelect(t))return!1;const s={items:m(t)?e.scene().rows:[t],source:"custom",kind:"toggleRow"};return t?e.selection().toggle.canExecute(s):e.selection().toggle.canExecute(s)&&"multiple"===this.mode}}),toggleColumn:new js({source:"selection.view",execute:(e,t)=>{this.toggle(e,t)()}}),commitRow:new js({source:"selection.view",canExecute:()=>{const t=ir(e.navigation());return t&&"select"===t.type},execute:()=>{n.canExecute()&&n.execute()},shortcut:e.edit().commitShortcuts.select||""}),toggleActiveRow:n,togglePrevRow:new js({source:"selection.view",canExecute:()=>"row"===e.selection().unit&&lr(e.navigation())>0,execute:()=>{const t=lr(e.navigation()),s=cr(e.navigation()),n=this.rows[t];this.toggle(n)(),this.navigateTo(t-1,s)},shortcut:s.togglePreviousRow}),toggleNextRow:new js({source:"selection.view",canExecute:()=>"row"===e.selection().unit&&lr(e.navigation())<this.rows.length-1,execute:()=>{const t=lr(e.navigation()),s=cr(e.navigation()),n=this.rows[t];this.toggle(n)(),this.navigateTo(t+1,s)},shortcut:s.toggleNextRow}),toggleActiveColumn:new js({source:"selection.view",canExecute:()=>"column"===e.selection().unit&&cr(e.navigation())>=0,execute:()=>{const t=cr(e.navigation()),s=this.columns[t];this.toggle(s)()},shortcut:s.toggleColumn}),toggleNextColumn:new js({source:"selection.view",canExecute:()=>"column"===e.selection().unit&&cr(e.navigation())<this.columns.length-1,execute:()=>{const t=lr(e.navigation()),s=cr(e.navigation()),n=this.columns[s];this.toggle(n)(),this.navigateTo(t,s+1)},shortcut:s.toggleNextColumn}),togglePrevColumn:new js({source:"selection.view",canExecute:()=>"column"===e.selection().unit&&cr(e.navigation())>0,execute:()=>{const t=lr(e.navigation()),s=cr(e.navigation()),n=this.columns[s];this.toggle(n)(),this.navigateTo(t,s-1)},shortcut:s.togglePreviousColumn}),selectAll:new js({source:"selection.view",canExecute:()=>{const{mode:t}=e.selection();return"multiple"===t||"range"===t},execute:()=>{let s=[];switch(e.selection().unit){case"row":s=this.rows;break;case"column":s=e.columnList().line;break;case"cell":case"mix":{const{body:e}=t;s=this.selectionRange.build()(e.cell(0,0),e.cell(this.rows.length,this.columns.length));break}default:throw new oe("selection.view",`Invalid unit ${e.selection().unit}`)}this.select(s,!0)()},shortcut:s.selectAll})};return new Map(Object.entries(o))}selectRange(e,t,s){const n=this.selectionRange.build()(e,t);this.select(n,!0,s)()}toggle(e,t="custom"){const{model:s}=this.plugin,{toggle:n}=s.selection(),o={items:e=!arguments.length||m(e)?this.rows:r(e)?e:[e],source:t,kind:"toggle"};if(n.canExecute(o)){n.execute(o);const{form:t}=this;return t.toggle(e),()=>{s.selection({items:this.selectionService.map(t.entries())},{source:"selection.view"})}}return M}select(e,t,s="custom"){const{model:n}=this.plugin,{toggle:o}=n.selection(),r={items:e,source:s,kind:"select"};return o.canExecute(r)?(o.execute(r),this.form.select(e,t),()=>{const e=this.selectionService.map(this.form.entries());n.selection({items:e},{source:"selection.view"})}):M}state(e){return arguments.length?!0===this.form.state(e):!!this.form.stateAll(this.rows)}isIndeterminate(e){return arguments.length?null===this.form.state(e):null===this.form.stateAll(this.rows)}get selection(){return this.plugin.model.selection()}get mode(){return this.selection.mode}get items(){return this.selection.items}get rows(){const{table:e}=this.plugin;return e.data.rows()}get columns(){const{table:e}=this.plugin;return e.data.columns()}navigateTo(e,t){const{table:s,model:n}=this.plugin,{row:o,column:r}=s.body.cell(e,t).model();n.navigation({cell:{rowIndex:e,columnIndex:t,row:o,column:r}},{source:"selection.view"})}}function qc(e){switch(e){case"filter":return Lc;case"sort":return Sc;case"group":case"pivot":return function(e){return t=>{const s=t.by;if(0===s.length)return"";const n=s.join(", ");return`${e} ${n}`}}(e);default:return()=>""}}function Lc(e){const t=Object.values(e.by).map((e=>e.items));if(0===t.length)return"";return`filter ${o(t).join(", ")}`}function Sc(e){const t=[];for(let s of e.by)for(let e in s)t.push(e);if(0===t.length)return"";return`sort ${t.join(", ")}`}function Mc(e){const t=Object.keys(e)[0];if(!t)throw new oe("pair",`Key is not defined in "${e}"`);return t}function Tc(e,t){return e.map(Mc).findIndex((e=>e===t))}function jc(e){return e[Mc(e)]}function Nc(e){return e.reduce(((e,t)=>{const s=Mc(t);return e[s]=t[s],e}),{})}function Ac(e){if(h(e)){const t=Object.keys(e).map((e=>({key:e,value:he(e)}))),{length:s}=t;switch(s){case 0:return T;case 1:{const s=t[0],n=e[s.key];if(!n)return T;const o=new RegExp(n,"gi");return e=>o.test(s.value(e))}default:return s=>t.reduce(((t,n)=>t&&new RegExp(e[n.key],"gi").test(n.value(s))||""===e[n.key]),!0)}}const t=B(e),s=new RegExp(t,"gi");return e=>(s.lastIndex=0,s.test(e))}function Pc(e,t){return t[e]}function Vc(e){return e}function Dc(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ";if(e<t.length)return t[e];return`${t[Math.floor(e/t.length-1)]}${t[e%t.length]}`}function zc(e){const{ownerDocument:t}=e,s=t.createElement("input");s.type="file",s.style.display="none",e.appendChild(s),s.click()}class Bc{constructor(e){const{model:t}=e;this.plugin=e,this.hover=!1,this.toggle=new js({source:"sort.view",canExecute:e=>{const s=e.key,n=is(t.columnList().line);return n.hasOwnProperty(s)&&!1!==n[s].canSort},execute:e=>{const s=e.key,n=t.sort,o=n();let r=Array.from(o.by);if("mixed"===o.mode){const{code:e,status:n}=t.keyboard();if("shift"!==e||"down"!==n){const e=bn(r,s);r=e>=0?r.filter(((t,s)=>s===e)):[]}}const i=bn(r,s);if(i>=0){const e=fn(r[i]);switch(e){case"desc":r.splice(i,1),this.hover=!1;break;case"asc":{const e={[s]:"desc"};r[i]=e,this.hover=!1;break}default:throw oe("head.core",`Invalid sort direction ${e}`)}}else{"single"===o.mode&&(r.length=0);const e={[s]:"asc"};r.push(e);pn(t)(r)}n({by:r},{source:"sort.view"})}}),this.onInit()}onInit(){const{model:e,observeReply:t}=this.plugin,{sort:s}=e;t(e.columnListChanged).subscribe((t=>{if(t.hasChanges("index")){const t=s(),n=pn(e)(Array.from(t.by));this.equals(n,t.by)||s({by:n},{source:"sort.view"})}})),t(e.dataChanged).subscribe((e=>{if(e.hasChanges("columns")){const{by:t}=s(),n=is(e.state.columns),o=t.filter((e=>n.hasOwnProperty(wn(e))));this.equals(o,t)||s({by:o},{source:"sort.view"})}}))}equals(e,t){return JSON.stringify(e)===JSON.stringify(t)}direction(e){const{key:t}=e,{by:s}=this.plugin.model.sort();return yn(s)[t]}order(e){const{key:t}=e,{model:s}=this.plugin,{by:n}=s.sort();return bn(n,t)}}class Hc{constructor(e,t,s){this.element=e,this.list=new Set,this.sheets=t,this.markDirty=s}class(e,t){if(e=Es(e),this.list.add(e),this.markDirty(this),t){const s=this.sheets;s.has(e)||s.set(e,t)}}}class Wc{constructor(e){this.model=e,this.entries=new Set,this.newSheets=new Map,this.oldSheets=new Map}enter(){const e=this.newSheets;let t=this.entries;for(let e of t)for(let t of e.list)e.element.removeClass(t,!0);t=this.entries=new Set;const s=e=>t.add(e);return t=>{const n=new Hc(t,e,s);return n.class.bind(n)}}exit(){const e=this.entries;for(let t of e)for(let e of t.list)t.element.addClass(e,!0);const t=this.newSheets,s=this.oldSheets,n=this.model.grid().id;for(let e of s.keys())if(!t.has(e)){Cs(n,e).remove()}for(let[e,o]of t.entries())if(!s.has(e)){Cs(n,e).set({[`.${e}`]:o})}this.oldSheets=t,this.newSheets=new Map}}class Uc{constructor(e){this.style=e.style}row(){const{rows:e,row:t}=this.style(),s=t===M?e:e.concat([t]);return ki.func(s)}cell(){const{cells:e,cell:t}=this.style();if(a(t)){const s=t===M?e:e.concat([t]);return ki.func(s)}const s=Object.keys(t);if(s.length){const n=e.concat(s.map((e=>{const s=t[e];return(t,n,o)=>{n.key===e&&s(t,n,o)}})));return ki.func(n)}return ki.func(e)}}class _c{constructor(e,t){this.table=e,this.style=t}visitFactory(){const{style:e}=this,{rowBox:t}=this.table.body,{entries:s}=t;return(n,o)=>{const r={dataIndex:o.row},i=t.key(r),c=s.get(i);if(c)for(let e of c)o.class(e);e(n,o)}}}class Kc{constructor(e,t){this.table=e,this.style=t}visitFactory(){const{style:e}=this,{cellBox:t}=this.table.body,{columnBox:s}=this.table.body,n=t.entries,o=s.entries;return(r,i,c)=>{const l={dataIndex:c.column},a=s.key(l),u=o.get(a);if(u)for(let e of u)c.class(e);const h={dataRowIndex:c.row,dataColumnIndex:c.column},d=t.key(h),m=n.get(d);if(m)for(let e of m)c.class(e);e(r,i,c)}}}class Gc{constructor(e){const{model:t,observeReply:s}=e;this.plugin=e,this.valueFactory=pe,this.service=new Uc(t),this.active={row:!1,cell:!1},this.monitor={row:new Wc(t),cell:new Wc(t)},s(t.styleChanged).subscribe((e=>{(e.hasChanges("row")||e.hasChanges("rows"))&&(this.active.row=e.state.row!==M||e.state.rows.length>0),(e.hasChanges("cell")||e.hasChanges("cells"))&&(this.active.cell=e.state.cell!==M||e.state.cells.length>0)}))}needInvalidate(){const{model:e}=this.plugin;if("stop"!==e.scene().status)return!1;const{active:t}=this;if(!("virtual"===e.scroll().mode||t.row||t.cell))return!1;const{invalidate:s}=e.style(),n={model:e};return s.canExecute(n)&&!1!==s.execute(n)}invalidate(e,t){const{model:s,table:n}=this.plugin;let{row:o,cell:r}=this.active;const i="virtual"===s.scroll().mode,c=new Map,l=(e,t)=>{let s=c.get(t);return s||(s=pe(t),c.set(t,s)),s(e)},a=n.data.columns(),u=is(a);let h=this.service.row(),d=this.service.cell();i&&(o=!0,r=!0,h=new _c(n,h).visitFactory(),d=new Kc(n,d).visitFactory());const m={class:M,row:-1,value:null,columns:{map:u,list:a}},g={class:M,row:-1,column:-1,value:null,columns:m.columns},{body:p}=n,{rowToView:w,columnToView:f}=n.box.mapper,y=n.box.bag.body;if(o){const e=y.getRowElements();for(let s of e){const{index:e,element:n,model:o}=s,r=p.createRowCore(w(e),n);m.class=t(r),m.row=e,m.value=l,h(o,m)}}if(r){const t=y.getCellElements();for(let s of t){const{rowIndex:t,columnIndex:n,element:o,row:r,column:i}=s,c=p.createCellCore(w(t),f(n),o);g.class=e(c),g.row=t,g.column=n,g.value=l,d(r,i,g)}}}}const Jc=new nc;function Yc(){return Jc.build()}function Xc(e,t,s,n){const{model:o,disposable:r}=e,{shortcut:i}=o.action(),c={keyCode:()=>i.keyCode,register:e=>r.add(i.register(t,e))},l=new xc(o,t),a={register:e=>{r.add(i.register(l,e))}};return t=>{t.head=new ai(e,n.th),t.body=new ws(e),t.foot=new zr(e),t.row=new bc(e,n.tr),t.layout=new Ii(e),t.scroll=new vc(e,s),t.highlight=new pi(e),t.sort=new Bc(e),t.pagination=new mc(e),t.nav=new dc(e,c),t.group=new ei(e,c),t.edit=new ur(e,c),t.filter=new Mr(e),t.rowDetails=new yc(e,c),t.selection=new Fc(e,a),t.style=new Gc(e),t.clipboard=new Ns(e,c)}}class Zc{constructor(e){this.plugin=e,this.watch(e.service),this.final=Ei(),this.startCell=null}invalidate(){this.final((()=>{const{view:e}=this.plugin,{style:t}=e;if(t.needInvalidate()){const e=t.monitor.row,s=t.monitor.cell;Q.mutate((()=>{Q.mutate((()=>{const n=s.enter(),o=e.enter();try{t.invalidate(n,o)}finally{e.exit(),s.exit()}}))}))}}))}triggerLine(e,t){const{model:s}=this.plugin,{reduce:n}=s.pipe();let o=[];const r=re(t);return(t,i,c)=>{s.scene({status:"start"},{source:t}),o.push(...c),r((()=>{const r=n(o,s);o=[],r.forEach((s=>e.invalidate({source:t,changes:i,pipe:s,why:s.why||"refresh"})))}))}}watch(e){const{model:t,observeReply:s}=this.plugin,{triggers:n}=t.pipe(),{pipe:o}=t.data(),r=this.triggerLine(e,10);o!==Zn.default&&r("grid",{},[o]),Object.keys(n).forEach((e=>s(t[e+"Changed"]).subscribe((t=>{if("core"===t.tag.behavior)return;const s=[],o=n[e];for(const e in t.changes){const t=o[e];t&&s.push(t)}s.length>0&&r(t.tag.source||e,t.changes,s)}))))}mouseDown(e){const{model:t,view:s}=this.plugin,{edit:n}=t,o=this.findCell(e);if(t.mouse({code:uc(ac(e)),status:"down",target:o},{source:"mouse.down"}),lc(e,1)){const{area:e,mode:t}=this.selection;if(o){const r="view"===n().status;this.navigate(o),"body"===e&&this.select(o),r&&s.edit.cell.enter.canExecute(o)&&s.edit.cell.enter.execute(o),"range"===t&&"select"!==o.column.type&&(this.startCell=o,s.selection.selectRange(o,null,"body"))}}}mouseUp(e){const{model:t}=this.plugin,{edit:s}=t,n=this.findCell(e);this.startCell=null,t.mouse({code:uc(ac(e)),status:"up",target:n},{source:"mouse.up"}),lc(e,1)&&"startBatch"===s().status&&s({status:"endBatch"},{source:"body.ctrl"}),t.mouse({code:uc(0),status:"release",target:null,timestamp:Date.now()},{source:"mouse.up"})}mouseMove(e){const{model:t,view:s}=this.plugin,{highlight:n}=s,{rows:o,cell:r}=t.highlight(),i=this.findCell(e);if(i){r&&n.cell.execute(r,!1);const c={rowIndex:i.rowIndex,columnIndex:i.columnIndex};t.mouse({status:"move",target:r||c},{source:"mouse.move"}),n.cell.canExecute(c)&&n.cell.execute(c,!0);const l=this.findRow(e);if(l){const{index:e}=l;n.row.canExecute(e)&&(o.filter((t=>t!==e)).forEach((e=>n.row.execute(e,!1))),n.row.execute(e,!0))}if(lc(e,1)&&"range"===this.selection.mode){const e=this.startCell,t=i;e&&t&&(this.navigate(t),s.selection.selectRange(e,t,"body"))}}else t.mouse({status:"move",target:null},{source:"mouse.move"})}mouseEnter(e){const{model:t}=this.plugin;t.mouse({status:"enter",target:null,code:null},{source:"mouse.enter"})}mouseLeave(){const{model:e}=this.plugin;e.mouse({status:"leave",target:null,code:null},{source:"mouse.leave"}),this.clearHighlight()}select(e){const{area:t,mode:s,unit:n}=this.selection;if("select"!==e.column.type&&("body"!==t||"range"===s))return;const{model:o,view:r}=this.plugin,i=o.edit().mode;switch(n){case"row":if("select"===e.column.type&&"focus"===e.column.editorOptions.trigger){const t=o.focus();t.rowIndex===e.rowIndex&&t.columnIndex===e.columnIndex||r.selection.toggleRow.canExecute(e.row)&&r.selection.toggleRow.execute(e.row,"body")}else i||"control"===e.column.category||r.selection.toggleRow.canExecute(e.row)&&r.selection.toggleRow.execute(e.row,"body");break;case"column":i||r.selection.toggleColumn.execute(e.column,"body");break;case"mix":"row-indicator"===e.column.type&&r.selection.toggleCell.execute(e,"body")}}navigate(e){const{view:t}=this.plugin,{focus:s}=t.nav;s.canExecute(e)&&s.execute(e)}findCell(e){const{table:t}=this.plugin,s=new si(t.box.bag.body),n=ii(e);let o=s.cell(n);if(!o){const e=n[0];if(e&&e.classList.contains("q-grid-edit-marker")){const{model:e}=this.plugin,{rowIndex:s,columnIndex:n}=e.focus();o=t.body.cell(s,n).model()}}return o}findRow(e){const{table:t}=this.plugin,s=new si(t.box.bag.body),n=ii(e);return s.row(n)}clearHighlight(){const{view:e}=this.plugin,{highlight:t}=e;t.clear.canExecute()&&t.clear.execute()}get selection(){const{model:e}=this.plugin;return e.selection()}}export{E as Action,X as ActionState,Gt as Aggregation,Z as AnimationState,qe as ArrayColumn,Fe as ArrayColumnModel,so as Bag,Mo as Body,ie as BodyHost,ws as BodyLet,ys as BodyState,Se as BoolColumn,Le as BoolColumnModel,xo as Box,bs as BoxHost,fs as Cache,ve as CacheStrategy,go as Cell,ko as CellBox,Yo as CellEditor,Is as CellSelector,fi as CharReader,Ns as ClipboardLet,As as ClipboardState,Te as CohortColumn,Me as CohortColumnModel,ho as Column,Eo as ColumnBox,Ws as ColumnListHost,sn as ColumnListState,$e as ColumnModel,Re as ColumnView,js as Command,rn as CommandKey,Y as CommandManager,ki as Composite,an as CompositeCommandManager,eo as Container,wr as CsvExport,yi as CsvImport,Ne as CurrencyColumn,je as CurrencyColumnModel,jo as Data,Oe as DataColumnModel,Ce as DataRow,Qn as DataState,Ze as DateColumn,Xe as DateColumnModel,et as DateTimeColumn,Qe as DateTimeColumnModel,se as Defer,Kt as DetailsRow,Fs as Disposable,Uo as DragService,_o as DragState,er as EditCellLet,ur as EditLet,ar as EditRowLet,hr as EditService,dr as EditState,lo as Element,st as EmailColumn,tt as EmailColumnModel,Br as EnumerableResource,te as Event,mr as EventListener,gr as EventManager,yr as ExportState,no as FakeClassList,ro as FakeElement,No as FakeLayer,Ao as FakeTable,Q as Fastdom,Ko as Fetch,Sr as FetchState,rt as FileColumn,ot as FileColumnModel,Mr as FilterLet,on as FilterRowColumn,nn as FilterRowColumnModel,jr as FilterState,Vr as FocusAfterRenderService,Pr as FocusService,Dr as FocusState,Po as Foot,zr as FootLet,Hr as FootState,Ie as FormatService,ee as GRID_PREFIX,oe as GridError,Wr as GridHost,Jr as GridService,Yr as GridState,ct as GroupColumn,it as GroupColumnModel,ei as GroupLet,ti as GroupState,at as GroupSummaryColumn,lt as GroupSummaryColumnModel,kt as Guard,Vo as Head,li as HeadHost,ai as HeadLet,ui as HeadState,pi as HighlightLet,wi as HighlightState,ht as IdColumn,ut as IdColumnModel,mt as ImageColumn,dt as ImageColumnModel,bi as ImportState,br as JsonExport,vi as JsonImport,L as Keyboard,$i as KeyboardState,rc as LEFT_BUTTON,Ri as LayerState,Ii as LayoutLet,Oi as LayoutState,es as Lazy,ce as Log,ic as MIDDLE_BUTTON,qr as MarkupVisitor,po as Matrix,Ur as Middleware,Et as Model,Fi as ModelBinder,nc as ModelBuilder,qi as MouseState,Rc as MultipleSelectionState,oc as NO_BUTTON,hc as Navigation,dc as NavigationLet,Li as NavigationState,le as Node,Xt as NodeRow,pt as NumberColumn,gt as NumberColumnModel,Ls as ObservableEvent,Ss as ObservableReplyEvent,Ts as Operator,ft as PadColumn,wt as PadColumnModel,mc as PaginationLet,Si as PaginationState,bt as PasswordColumn,yt as PasswordColumnModel,si as PathService,gc as PersistenceService,Pi as PersistenceState,Ai as PersistenceStorage,Vn as Pipe,Vi as PipeState,Zn as PipeUnit,xt as PivotColumn,vt as PivotColumnModel,ms as PivotRow,Di as PivotState,pc as PluginService,zi as PluginState,Lr as PredicateVisitor,Bi as ProgressState,cc as RIGHT_BUTTON,bo as Range,Ic as RangeSelectionState,Rt as ReferenceColumn,$t as ReferenceColumnModel,gs as Renderer,$ as Resource,Wi as RestState,uo as Row,$o as RowBox,ae as RowDetails,Ot as RowDetailsColumn,It as RowDetailsColumnModel,yc as RowDetailsLet,Wn as RowDetailsStatus,or as RowEditor,qt as RowExpandColumn,Ft as RowExpandColumnModel,St as RowIndicatorColumn,Lt as RowIndicatorColumnModel,bc as RowLet,Ui as RowListState,Tt as RowNumberColumn,Mt as RowNumberColumnModel,Nt as RowOptionsColumn,jt as RowOptionsColumnModel,_i as RowState,jn as Scene,Ki as SceneState,vc as ScrollLet,Gi as ScrollState,Pt as SelectColumn,At as SelectColumnModel,xc as SelectionCommandManager,Fc as SelectionLet,Cc as SelectionRange,gi as SelectionService,Ji as SelectionState,wo as Selector,Do as SelectorCache,vo as SelectorFactory,So as SelectorMark,fo as SelectorMediator,S as Shortcut,J as ShortcutDispatcher,$c as SingleOnlySelectionState,Ec as SingleSelectionState,Bc as SortLet,Yi as SortState,Co as StyleBox,Hc as StyleEntry,Gc as StyleLet,Wc as StyleMonitor,Uc as StyleService,Xi as StyleState,kc as SubSelectionState,Ms as SubjectLike,Ho as Table,un as TableCommandManager,mo as Td,Ee as TemplatePath,Zi as TemplateState,Dt as TextColumn,Vt as TextColumnModel,ps as TextSelection,Bt as TimeColumn,zt as TimeColumnModel,Qi as ToolbarState,ao as Tr,to as TrContainer,co as Unit,yo as UnitFactory,qs as UnsubscribableLike,Wt as UrlColumn,Ht as UrlColumnModel,ec as ValidationState,Bo as View,Zc as ViewHost,tc as ViewState,To as VirtualBody,Lo as VirtualBox,Io as VirtualCell,Kc as VirtualCellStyle,Oo as VirtualColumn,Fo as VirtualElement,qo as VirtualRow,_c as VirtualRowStyle,sc as VisibilityState,Or as Visitor,Cr as XmlExport,Ci as XmlImport,Dc as alphaTitle,Tn as animationPipe,Xs as bend,H as binarySearch,$s as bodyCellClassifier,vs as build,Er as buildExpression,_r as buildFromModel,xs as buildLines,qn as buildPivot,Js as calk,kr as castFactory,lc as checkButtonCode,ns as collapse,_t as columnFactory,Sn as columnIndexPipe,zn as columnIndexPipeUnit,Mn as columnPipe,Dn as columnPipeUnit,cn as commandKey,V as compare,Pe as compareParseFactory,ue as compile,he as compileGet,de as compileSet,Ys as copy,Os as copyToClipboard,Qo as createValidator,ni as css,hn as dataPipe,Bn as defaultPipeUnit,Ni as deserialize,ci as elementFromPoint,Es as escape,ks as escapeAttr,B as escapeRegexp,ii as eventPath,ss as expand,wc as factory,Ar as filter,_s as filterNode,dn as filterPipe,Ei as final,ls as findColumn,Yt as findFirstLeaf,as as findIndex,Ks as findLeaves,rs as findLine,Gs as findNode,Be as findType,Pc as firstRowTitle,Un as flatView,os as flattenColumns,Jt as flattenFactory,ts as flattenRows,Bs as generate,ln as generateCommandKey,zs as generateFactory,ac as getButtonCode,cs as getCellValue,fn as getDirection,bn as getIndex,wn as getKey,fe as getLabel,ye as getLabelFactory,yn as getMap,De as getType,K as getTypeName,ge as getValue,pe as getValueFactory,fr as graphFlatView,ds as groupBuilder,kn as groupPipe,Hn as groupPipeUnit,Kr as guid,Zo as hasRules,Rs as headCellClassifier,z as htmlEncode,N as identity,Tc as index,ze as inferType,_n as invalidateStatus,P as isEmail,nt as isFileAnImage,U as isImage,He as isPrimitive,W as isUrl,re as jobLine,Mc as key,us as lineView,Nc as map,is as mapColumns,Tr as match,_ as matchISO8601,xn as memoPipe,Ps as merge,en as mergeTree,Yc as modelFactory,j as no,Cn as nodeBuilder,M as noop,Vc as numericTitle,D as orderBy,pn as orderFactory,mn as paginationPipe,ri as parents,Ae as parseFactory,Rn as pivot,Fn as pivotForm,Ln as pivotPipe,Us as preOrderDFS,Ac as predicateFactory,Ve as resolveType,Gn as rowDetailsPipeUnit,Xn as rowPipeUnit,Pn as scenePipe,Yn as scenePipeUnit,ir as selectColumn,cr as selectColumnIndex,rr as selectRow,lr as selectRowIndex,Oc as selectionStateFactory,ji as serialize,Hi as serializeGet,fc as serializePost,be as setLabel,we as setValue,Cs as sheet,Nn as sortFactory,Zs as sortIndexFactory,vn as sortPipe,uc as stringify,qc as stringifyFactory,Wo as tableFactory,Nr as takeOnce,A as toCamelCase,Kn as toggleStatus,zc as upload,jc as value,Xc as viewFactory,An as viewPipe,Jn as viewPipeUnit,hs as widthFactory,T as yes};
